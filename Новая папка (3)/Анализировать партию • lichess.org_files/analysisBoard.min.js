var LichessAnalyse=function(t){"use strict";const e={createElement:function(t,e){return document.createElement(t,e)},createElementNS:function(t,e,n){return document.createElementNS(t,e,n)},createTextNode:function(t){return document.createTextNode(t)},createDocumentFragment:function(){return document.createDocumentFragment()},createComment:function(t){return document.createComment(t)},insertBefore:function(t,e,n){t.insertBefore(e,n)},removeChild:function(t,e){t.removeChild(e)},appendChild:function(t,e){t.appendChild(e)},parentNode:function(t){return t.parentNode},nextSibling:function(t){return t.nextSibling},tagName:function(t){return t.tagName},setTextContent:function(t,e){t.textContent=e},getTextContent:function(t){return t.textContent},isElement:function(t){return 1===t.nodeType},isText:function(t){return 3===t.nodeType},isComment:function(t){return 8===t.nodeType},isDocumentFragment:function(t){return 11===t.nodeType}};function n(t,e,n,o,r){return{sel:t,data:e,children:n,text:o,elm:r,key:void 0===e?void 0:e.key}}const o=Array.isArray;function r(t){return"string"==typeof t||"number"==typeof t||t instanceof String||t instanceof Number}function s(t){return void 0===t}function i(t){return void 0!==t}const a=n("",{},[],void 0,void 0);function c(t,e){var n,o;const r=t.key===e.key,s=(null===(n=t.data)||void 0===n?void 0:n.is)===(null===(o=e.data)||void 0===o?void 0:o.is);return t.sel===e.sel&&r&&s}function l(){throw new Error("The document fragment is not supported on this platform.")}function d(t,e,n){var o;const r={};for(let s=e;s<=n;++s){const e=null===(o=t[s])||void 0===o?void 0:o.key;void 0!==e&&(r[e]=s)}return r}const h=["create","update","remove","destroy","pre","post"];function u(t,u,p){const m={create:[],update:[],remove:[],destroy:[],pre:[],post:[]},f=void 0!==u?u:e;for(const e of h)for(const n of t){const t=n[e];void 0!==t&&m[e].push(t)}function g(t){const e=t.id?"#"+t.id:"",o=t.getAttribute("class"),r=o?"."+o.split(" ").join("."):"";return n(f.tagName(t).toLowerCase()+e+r,{},[],void 0,t)}function v(t){return n(void 0,{},[],void 0,t)}function b(t,e){return function(){if(0==--e){const e=f.parentNode(t);f.removeChild(e,t)}}}function y(t,e){var n,c,d,h;let u,g=t.data;if(void 0!==g){const e=null===(n=g.hook)||void 0===n?void 0:n.init;i(e)&&(e(t),g=t.data)}const v=t.children,b=t.sel;if("!"===b)s(t.text)&&(t.text=""),t.elm=f.createComment(t.text);else if(void 0!==b){const n=b.indexOf("#"),s=b.indexOf(".",n),l=n>0?n:b.length,d=s>0?s:b.length,h=-1!==n||-1!==s?b.slice(0,Math.min(l,d)):b,p=t.elm=i(g)&&i(u=g.ns)?f.createElementNS(u,h,g):f.createElement(h,g);for(l<d&&p.setAttribute("id",b.slice(l+1,d)),s>0&&p.setAttribute("class",b.slice(d+1).replace(/\./g," ")),u=0;u<m.create.length;++u)m.create[u](a,t);if(o(v))for(u=0;u<v.length;++u){const t=v[u];null!=t&&f.appendChild(p,y(t,e))}else r(t.text)&&f.appendChild(p,f.createTextNode(t.text));const w=t.data.hook;i(w)&&(null===(c=w.create)||void 0===c||c.call(w,a,t),w.insert&&e.push(t))}else if((null===(d=null==p?void 0:p.experimental)||void 0===d?void 0:d.fragments)&&t.children){const n=t.children;for(t.elm=(null!==(h=f.createDocumentFragment)&&void 0!==h?h:l)(),u=0;u<m.create.length;++u)m.create[u](a,t);for(u=0;u<n.length;++u){const o=n[u];null!=o&&f.appendChild(t.elm,y(o,e))}}else t.elm=f.createTextNode(t.text);return t.elm}function w(t,e,n,o,r,s){for(;o<=r;++o){const r=n[o];null!=r&&f.insertBefore(t,y(r,s),e)}}function k(t){var e,n;const o=t.data;if(void 0!==o){null===(n=null===(e=null==o?void 0:o.hook)||void 0===e?void 0:e.destroy)||void 0===n||n.call(e,t);for(let e=0;e<m.destroy.length;++e)m.destroy[e](t);if(void 0!==t.children)for(let e=0;e<t.children.length;++e){const n=t.children[e];null!=n&&"string"!=typeof n&&k(n)}}}function C(t,e,n,o){for(var r,s;n<=o;++n){let o,a;const c=e[n];if(null!=c)if(i(c.sel)){k(c),o=m.remove.length+1,a=b(c.elm,o);for(let e=0;e<m.remove.length;++e)m.remove[e](c,a);const t=null===(s=null===(r=null==c?void 0:c.data)||void 0===r?void 0:r.hook)||void 0===s?void 0:s.remove;i(t)?t(c,a):a()}else f.removeChild(t,c.elm)}}function x(t,e,n){var o,r,a,l,h,u,p,g;const v=null===(o=e.data)||void 0===o?void 0:o.hook;null===(r=null==v?void 0:v.prepatch)||void 0===r||r.call(v,t,e);const b=e.elm=t.elm,k=t.children,M=e.children;if(t!==e){if(void 0!==e.data||i(e.text)&&e.text!==t.text){null!==(a=e.data)&&void 0!==a||(e.data={}),null!==(l=t.data)&&void 0!==l||(t.data={});for(let n=0;n<m.update.length;++n)m.update[n](t,e);null===(p=null===(u=null===(h=e.data)||void 0===h?void 0:h.hook)||void 0===u?void 0:u.update)||void 0===p||p.call(u,t,e)}s(e.text)?i(k)&&i(M)?k!==M&&function(t,e,n,o){let r,i,a,l,h=0,u=0,p=e.length-1,m=e[0],g=e[p],v=n.length-1,b=n[0],k=n[v];for(;h<=p&&u<=v;)null==m?m=e[++h]:null==g?g=e[--p]:null==b?b=n[++u]:null==k?k=n[--v]:c(m,b)?(x(m,b,o),m=e[++h],b=n[++u]):c(g,k)?(x(g,k,o),g=e[--p],k=n[--v]):c(m,k)?(x(m,k,o),f.insertBefore(t,m.elm,f.nextSibling(g.elm)),m=e[++h],k=n[--v]):c(g,b)?(x(g,b,o),f.insertBefore(t,g.elm,m.elm),g=e[--p],b=n[++u]):(void 0===r&&(r=d(e,h,p)),i=r[b.key],s(i)?f.insertBefore(t,y(b,o),m.elm):(a=e[i],a.sel!==b.sel?f.insertBefore(t,y(b,o),m.elm):(x(a,b,o),e[i]=void 0,f.insertBefore(t,a.elm,m.elm))),b=n[++u]);u<=v&&(l=null==n[v+1]?null:n[v+1].elm,w(t,l,n,u,v,o)),h<=p&&C(t,e,h,p)}(b,k,M,n):i(M)?(i(t.text)&&f.setTextContent(b,""),w(b,null,M,0,M.length-1,n)):i(k)?C(b,k,0,k.length-1):i(t.text)&&f.setTextContent(b,""):t.text!==e.text&&(i(k)&&C(b,k,0,k.length-1),f.setTextContent(b,e.text)),null===(g=null==v?void 0:v.postpatch)||void 0===g||g.call(v,t,e)}}return function(t,e){let n,o,r;const s=[];for(n=0;n<m.pre.length;++n)m.pre[n]();for(!function(t,e){return t.isElement(e)}(f,t)?function(t,e){return t.isDocumentFragment(e)}(f,t)&&(t=v(t)):t=g(t),c(t,e)?x(t,e,s):(o=t.elm,r=f.parentNode(o),y(e,s),null!==r&&(f.insertBefore(r,e.elm,f.nextSibling(o)),C(r,[t],0,0))),n=0;n<s.length;++n)s[n].data.hook.insert(s[n]);for(n=0;n<m.post.length;++n)m.post[n]();return e}}function p(t,e,n){if(t.ns="http://www.w3.org/2000/svg","foreignObject"!==n&&void 0!==e)for(let o=0;o<e.length;++o){const t=e[o];if("string"==typeof t)continue;const n=t.data;void 0!==n&&p(n,t.children,t.sel)}}function m(t,e,s){let i,a,c,l={};if(void 0!==s?(null!==e&&(l=e),o(s)?i=s:r(s)?a=s.toString():s&&s.sel&&(i=[s])):null!=e&&(o(e)?i=e:r(e)?a=e.toString():e&&e.sel?i=[e]:l=e),void 0!==i)for(c=0;c<i.length;++c)r(i[c])&&(i[c]=n(void 0,void 0,void 0,i[c],void 0));return"s"!==t[0]||"v"!==t[1]||"g"!==t[2]||3!==t.length&&"."!==t[3]&&"#"!==t[3]||p(l,i,t),n(t,l,i,a,void 0)}function f(t,e){var n;const o=null===(n=e.data)||void 0===n?void 0:n.ns;t.data.fn=e.data.fn,t.data.args=e.data.args,e.data=t.data,e.children=t.children,e.text=t.text,e.elm=t.elm,o&&p(e.data,e.children,e.sel)}function g(t){const e=t.data;f(e.fn(...e.args),t)}function v(t,e){let n;const o=t.data,r=e.data,s=o.args,i=r.args;if(o.fn===r.fn&&s.length===i.length){for(n=0;n<i.length;++n)if(s[n]!==i[n])return void f(r.fn(...i),e);f(t,e)}else f(r.fn(...i),e)}const b=function(t,e,n,o){return void 0===o&&(o=n,n=e,e=void 0),m(t,{key:e,hook:{init:g,prepatch:v},fn:n,args:o})};function y(t,e){let n;const o=e.elm;let r=t.data.attrs,s=e.data.attrs;if((r||s)&&r!==s){for(n in r=r||{},s=s||{},s){const t=s[n];r[n]!==t&&(!0===t?o.setAttribute(n,""):!1===t?o.removeAttribute(n):120!==n.charCodeAt(0)?o.setAttribute(n,t):58===n.charCodeAt(3)?o.setAttributeNS("http://www.w3.org/XML/1998/namespace",n,t):58===n.charCodeAt(5)?o.setAttributeNS("http://www.w3.org/1999/xlink",n,t):o.setAttribute(n,t))}for(n in r)n in s||o.removeAttribute(n)}}const w={create:y,update:y};function k(t,e){let n,o;const r=e.elm;let s=t.data.class,i=e.data.class;if((s||i)&&s!==i){for(o in s=s||{},i=i||{},s)s[o]&&!Object.prototype.hasOwnProperty.call(i,o)&&r.classList.remove(o);for(o in i)n=i[o],n!==s[o]&&r.classList[n?"add":"remove"](o)}}const C={create:k,update:k};function x(t){lichess.socket=new lichess.StrongSocket(t.socketUrl||"/analysis/socket/v5",t.socketVersion,{receive:(t,n)=>e.socketReceive(t,n)}),t.socketSend=lichess.socket.send;const e=_d(t)}function M(t){return{insert:e=>t(e.elm)}}function P(t,e,n,o=!0){return M((r=>r.addEventListener(t,(t=>{const o=e(t);return!1===o&&t.preventDefault(),null==n||n(),o}),{passive:o})))}lichess.load.then((()=>{const t=lichess;var e;t.userAnalysis?((e=t.userAnalysis).$side=$(".analyse__side").clone(),x(e)):(t.study||t.practice||t.relay)&&x(t.study||t.practice||t.relay)}));const S=(t,e,n)=>P(t,e,n,!1);function E(t,e){return P("submit",(e=>(e.preventDefault(),t(e))),e,!1)}function A(t){return{"data-icon":t}}const T={start:["hi/Hello","gl/Good luck","hf/Have fun!","u2/You too!"].map(I),end:["gg/Good game","wp/Well played","ty/Thank you","gtg/I've got to go","bye/Bye!"].map(I)};function I(t){const e=t.split("/");return{key:e[0],text:e[1]}}const _=t=>void 0!==t,N=t=>null!=t,D=t=>!t||0===t.length,O=t=>!D(t),q=t=>{let e=t;return function(t){return _(t)&&(e=t),e}},L={Accept:"application/vnd.lichess.v5+json"},R={cache:"no-cache",credentials:"same-origin"},F={"X-Requested-With":"XMLHttpRequest"},B=t=>{if(t.ok)return t;if(429==t.status)throw new Error("Too many requests");if(413==t.status)throw new Error("The uploaded file is too large");throw new Error(`Error ${t.status}`)},z=(t,e={})=>j(t,e).then((t=>B(t).json())),j=(t,e={})=>fetch(t,{...R,headers:{...L,...F},...e}),G=(t,e={})=>V(t,e).then((t=>B(t).text())),V=(t,e={})=>fetch(t,{...R,headers:{...F},...e}),H=t=>{const e=new FormData;for(const n of Object.keys(t))e.append(n,t[n]);return e},U=(t,e)=>{const n=new URLSearchParams;for(const r of Object.keys(e))_(e[r])&&n.append(r,e[r]);const o=n.toString();return o?`${t}?${o}`:t},W=t=>G(K(t)),K=t=>`/${t}/note`;function J(t,e,n=!1){let o,r=0;return function(...s){const i=this;o&&clearTimeout(o),o=void 0;const a=performance.now()-r;r=performance.now(),n&&a>e?t.apply(i,s):o=setTimeout((()=>{o=void 0,t.apply(i,s)}),e)}}function Y(t){let e=t.text;const n=J((()=>{((t,e)=>{z(K(t),{method:"post",body:H({text:e})})})(t.id,e||"")}),1e3);return{id:t.id,trans:t.trans,text:()=>e,fetch(){W(t.id).then((n=>{e=n||"",t.redraw()}))},post(t){e=t,n()}}}function X(t,e){const n=t.text();return null==n?m("div.loading",{hook:{insert:t.fetch}}):m("textarea.mchat__note",{attrs:{placeholder:t.trans("typePrivateNotesHere")},hook:{insert(o){const r=o.elm;r.value=n,e&&r.focus(),$(r).on("change keyup paste",(()=>t.post(r.value)))}}})}function Q(t,e,n){const o=n?m("line.line.patron",{attrs:{title:"Lichess Patron"}}):void 0;return m("a",{class:{"user-link":!0,ulpt:!0},attrs:{href:"/@/"+t}},e&&"BOT"!=e?[o,m("span.utitle",e),t]:[o,t])}let Z=!1;const tt=t=>(!1===Z&&(Z=window.Intl&&Intl.NumberFormat?new Intl.NumberFormat:null),null===Z?""+t:Z.format(t));function et(t){let e,n=!1;const o=()=>{e=void 0,n=!1,t.redraw()};return{loading:()=>n,data:()=>e,reasons:t.reasons,permissions:()=>t.permissions,open:o=>{const r=o.querySelector("a.user-link"),s=o.querySelector("t").innerText,i=r.href.split("/")[4];t.permissions.timeout?(n=!0,(t=>z("/mod/chat-user/"+t))(i).then((o=>{e={...o,text:s},n=!1,t.redraw()}))):e={id:i.toLowerCase(),username:i,text:s},t.redraw()},close:o,timeout(n,r){e&&lichess.pubsub.emit("socket.send","timeout",{userId:e.id,reason:n.key,text:r}),o(),t.redraw()}}}const nt=()=>m("i.mod",{attrs:{"data-icon":""}});function ot(t,e){const n=t.data;n.domVersion=1;const o={instance:void 0,loaded:!1,enabled:q(!!n.palantir)},r=["discussion"];t.noteId&&r.push("note"),t.plugin&&r.push(t.plugin.tab.key);const s=lichess.storage.make("chat.tab"),i=s.get();let a;const c={tab:r.find((t=>t===i))||r[0],enabled:t.alwaysEnabled||!lichess.storage.get("nochat"),placeholderKey:"talkInChat",loading:!1,autofocus:!1,timeout:t.timeout,writeable:t.writeable};r.length>1&&"discussion"===c.tab&&lichess.storage.get("nochat")&&(c.tab=r[1]);const l=t=>!!(t=t.trim())&&(!("You too!"==t&&!n.lines.some((t=>t.u!=n.userId)))&&(t.length>140?(alert("Max length: 140 chars. "+t.length+" chars used."),!1):(lichess.pubsub.emit("socket.send","talk",t),!0))),d=lichess.trans(t.i18n);function h(){(t.permissions.timeout||t.permissions.local)&&(a=et({reasons:t.timeoutReasons||[{key:"other",name:"Inappropriate behavior"}],permissions:t.permissions,redraw:e}),t.loadCss("chat.mod"))}h();const u=t.noteId?Y({id:t.noteId,text:t.noteText,trans:d,redraw:e}):void 0,p=function(t){let e=t.initialGroup,n=[];return{group:()=>e,said:()=>n,setGroup(o){o!==e&&(e=o,o||(n=[]),t.redraw())},post(o){e&&T[e]&&(n.includes(o.key)||t.post(o.text)&&n.push(o.key))}}}({initialGroup:t.preset,post:l,redraw:e}),m=[["socket.in.message",t=>{n.lines.push(t);const o=n.lines.length;o>200&&(n.lines.splice(0,o-200+50),n.domVersion++),e()}],["socket.in.chat_timeout",t=>{let o=!1;n.lines.forEach((e=>{e.u&&e.u.toLowerCase()==t&&(e.d=!0,o=!0)})),t==n.userId&&(c.timeout=o=!0),o&&(n.domVersion++,e())}],["socket.in.chat_reinstate",t=>{t==n.userId&&(c.timeout=!1,e())}],["chat.writeable",t=>{c.writeable=t,e()}],["chat.permissions",n=>{let o;for(o in n)t.permissions[o]=n[o];h(),e()}],["palantir.toggle",o.enabled]];m.forEach((([t,e])=>lichess.pubsub.on(t,e)));const f=()=>lichess.pubsub.emit("chat.enabled",c.enabled);return f(),{data:n,opts:t,vm:c,allTabs:r,setTab(t){c.tab=t,c.autofocus=!0,s.set(t),e()},moderation:()=>a,note:u,preset:p,post:l,trans:d,plugin:t.plugin,setEnabled(t){c.enabled=t,f(),t?lichess.storage.remove("nochat"):lichess.storage.set("nochat","1"),e()},redraw:e,palantir:o,destroy:()=>{m.forEach((([t,e])=>lichess.pubsub.off(t,e)))}}}const rt=/(^|[\s\n]|<[A-Za-z]*\/?>)((?:(?:https?|ftp):\/\/|lichess\.org)[\-A-Z0-9+\u0026\u2019@#\/%?=()~_|!:,.;]*[\-A-Z0-9+\u0026@#\/%=~()_|])/gi,st=/\n/g,it=/(^|[^\w@#/])@([a-z0-9][a-z0-9_-]{0,28}[a-z0-9])/gi;function at(t){return`<a target="_blank" rel="nofollow noopener noreferrer" href="${t}">${t.replace(/https?:\/\//,"")}</a>`}function ct(t,e){return{insert(n){n.elm.innerHTML=e(t),n.data.cachedA=t},postpatch(n,o){n.data.cachedA!==t&&(o.elm.innerHTML=e(t)),o.data.cachedA=t}}}function lt(t,e,n){return t.includes("&quot;")?t:`<a target="_blank" rel="noopener nofollow noreferrer" href="${t.startsWith("/")||t.includes("://")?t:"//"+t}"${n?` class="${n}"`:""}>${e||t}</a>`}function dt(t,e=!0){let n=(o=lichess.escapeHtml(t),r=at,o.replace(rt,((t,e,n)=>e+r(n))));var o,r;return e&&(n=n.replace(st,"<br>")),n}function ht(t,e=!0){return ct(t,(t=>dt(t,e)))}const ut=/\b\b(?:https?:\/\/)?(lichess\.org\/[-–—\w+&'@#\/%?=()~|!:,.;]+[\w+&@#\/%=~|])/gi,pt=/^[a-h][2-7]$/,mt=/\b(\d+)\s*(\.+)\s*(?:[o0-]+[o0]|[NBRQKP\u2654\u2655\u2656\u2657\u2658\u2659]?[a-h]?[1-8]?[x@]?[a-z][1-8](?:=[NBRQK\u2654\u2655\u2656\u2657\u2658\u2659])?)\+?#?[!\?=]{0,5}/gi;function ft(t,e,n){if(e<1||e>200)return t;return'<a class="jump" data-ply="'+(2*e-(n.length>1?0:1))+'">'+t+"</a>"}function gt(t,e,n){return n.match(pt)?t:function(t,e,n){return e+lt("/@/"+n,"@"+n)}(0,e,n)}function vt(t,e){const n=lichess.escapeHtml(t),o=n.replace(it,gt).replace(ut,lt);return e&&o===n?o.replace(mt,ft):o}const bt=()=>"1"==lichess.storage.get("chat-spam"),yt=new RegExp(["xcamweb.com","(^|[^i])chess-bot","chess-cheat","coolteenbitch","letcafa.webcam","tinyurl.com/","wooga.info/","bit.ly/","wbt.link/","eb.by/","001.rs/","shr.name/","u.to/",".3-a.net",".ssl443.org",".ns02.us",".myftp.info",".flinkup.com",".serveusers.com","badoogirls.com","hide.su","wyon.de","sexdatingcz.club","qps.ru","tiny.cc/","trasderk.blogspot.com"].map((t=>t.replace(/\./g,"\\.").replace(/\//g,"\\/"))).join("|")),wt=t=>!!t.match(yt),kt=/follow me|join my team/i,Ct=t=>!!t.match(kt),xt=/lichess\.org\/team\//i,Mt=/^\/[wW](?:hisper)?\s/;function Pt(t){if(!t.vm.enabled)return[];const e=e=>{const n=e.elm;if(t.data.lines.length>5){(0===n.scrollTop||n.scrollTop>n.scrollHeight-n.clientHeight-100)&&(n.scrollTop=999999,setTimeout((t=>n.scrollTop=999999),300))}},n=!!t.moderation(),o=[m("ol.mchat__messages.chat-v-"+t.data.domVersion,{attrs:{role:"log","aria-live":"polite","aria-atomic":"false"},hook:{insert(o){const r=$(o.elm).on("click","a.jump",(t=>{lichess.pubsub.emit("jump",t.target.getAttribute("data-ply"))}));n?r.on("click",".mod",(e=>{var n;return null===(n=t.moderation())||void 0===n?void 0:n.open(e.target.parentNode)})):r.on("click",".flag",(e=>function(t,e){const n=e.querySelector("a.user-link"),o=e.querySelector("t").innerText;n&&confirm(`Report "${o}" to moderators?`)&&((t,e,n)=>{z("/report/flag",{method:"post",body:H({username:e,resource:t,text:n})})})(t.data.resourceId,n.href.split("/")[4],o)}(t,e.target.parentNode))),e(o)},postpatch:(t,n)=>e(n)}},Tt(t).map((e=>function(t,e){var n,o;const r=function(t,e){if(n=t,/(\n|(@|#|\.)\w{2,})/.test(n)){const n=function(t){return(e,n)=>{n.data.lichessChat!==e.data.lichessChat&&(n.elm.innerHTML=vt(n.data.lichessChat,t))}}(e);return m("t",{lichessChat:t,hook:{create:n,update:n}})}var n;return m("t",t)}(e.t,t.opts.parseMoves);if("lichess"===e.u)return m("li.system",r);if(e.c)return m("li",[m("span.color","["+e.c+"]"),r]);const s=b("a",e.u,Q,[e.u,e.title,e.p]),i=null===(n=e.u)||void 0===n?void 0:n.toLowerCase(),a=t.data.userId,c=!!a&&!!(null===(o=e.t.match(it))||void 0===o?void 0:o.find((e=>e.trim().toLowerCase()==`@${t.data.userId}`)));return m("li",{class:{me:i===a,host:i===t.data.hostId,mentioned:c}},t.moderation()?[e.u?nt():null,s," ",r]:[a&&e.u&&a!=e.u?m("i.flag",{attrs:{"data-icon":"",title:"Report"}}):null,s," ",r])}(t,e)))),St(t)],r=function(t){const e=t.group();if(!e)return;const n=T[e],o=t.said();return n&&o.length<2?m("div.mchat__presets",n.map((e=>{const n=o.includes(e.key);return m("span",{class:{disabled:n},attrs:{title:e.text,disabled:n},hook:P("click",(()=>{!n&&t.post(e)}))},e.key)}))):void 0}(t.preset);return r&&o.push(r),o}function St(t){if(!t.vm.writeable)return;if(t.data.loginRequired&&!t.data.userId||t.data.restricted)return m("input.mchat__say",{attrs:{placeholder:t.trans("loginToChat"),disabled:!0}});let e;return e=t.vm.timeout?t.trans("youHaveBeenTimedOut"):t.opts.blind?"Chat":t.trans.noarg(t.vm.placeholderKey),m("input.mchat__say",{attrs:{placeholder:e,autocomplete:"off",maxlength:140,disabled:t.vm.timeout||!t.vm.writeable,"aria-label":"Chat input"},hook:{insert(e){At(t,e.elm)}}})}let Et;const At=(t,e)=>{const n=lichess.tempStorage.make("chat.input"),o=n.get();o?(e.value=o,e.focus(),!t.opts.public&&o.match(Mt)&&e.classList.add("whisper")):t.vm.autofocus&&e.focus(),e.addEventListener("keydown",(e=>{"Enter"===e.key&&setTimeout((()=>{const o=e.target,r=o.value,s=t.opts.public;""===r?$(".keyboard-move input").each((function(){this.focus()})):(t.opts.kobold||(t=>{if(bt())return;const e=wt(t);e&&G(`/jslog/${window.location.href.substr(-12)}?n=spam`,{method:"post"}),(e||Ct(t))&&lichess.storage.set("chat-spam","1")})(r),s&&(t=>!!t.match(xt))(r)?alert("Please don't advertise teams in the chat."):t.post(r),o.value="",n.remove(),s||o.classList.remove("whisper"))}))})),e.addEventListener("input",(e=>setTimeout((()=>{const o=e.target,r=o.value;o.removeAttribute("placeholder"),t.opts.public||o.classList.toggle("whisper",!!r.match(Mt)),n.set(r)})))),window.Mousetrap.bind("c",(()=>e.focus()));const r=["touchstart","mousedown"];Et&&r.forEach((t=>document.body.removeEventListener(t,Et,{capture:!0}))),Et=t=>{t.shiftKey||2===t.buttons||2===t.button||e.blur()},e.onfocus=()=>r.forEach((t=>document.body.addEventListener(t,Et,{passive:!0,capture:!0}))),e.onblur=()=>r.forEach((t=>document.body.removeEventListener(t,Et,{capture:!0})))};function Tt(t){const e=[];let n;return t.data.lines.forEach((o=>{var r,s,i;o.d||n&&(i=o,(s=n).d&&i.d&&s.u===i.u)||o.r&&(o.u||"").toLowerCase()!=t.data.userId||(r=o.t,(wt(r)||Ct(r))&&!bt())||e.push(o),n=o})),e}function It(t){const e=t.moderation();return m("section.mchat"+(t.opts.alwaysEnabled?"":".mchat-optional"),{class:{"mchat-mod":!!e},hook:{destroy:t.destroy}},function(t){if(!t)return;if(t.loading())return[m("div.loading")];const e=t.data();if(!e)return;const n=t.permissions(),o=e.history?m("div.infos.block",[tt(e.games||0)+" games",e.tos?"TOS":void 0].map((t=>t&&m("span",t))).concat([m("a",{attrs:{href:"/@/"+e.username+"?mod"}},"profile")]).concat(n.shadowban?[m("a",{attrs:{href:"/mod/"+e.username+"/communication"}},"coms")]:[])):void 0,r=n.timeout?m("div.timeout.block",[m("strong","Timeout 15 minutes for"),...t.reasons.map((n=>m("a.text",{attrs:{"data-icon":""},hook:P("click",(()=>t.timeout(n,e.text)))},n.name)))]):m("div.timeout.block",[m("strong","Moderation"),m("a.text",{attrs:{"data-icon":""},hook:P("click",(()=>t.timeout(t.reasons[0],e.text)))},"Timeout 15 minutes")]),s=e.history?m("div.history.block",[m("strong","Timeout history"),m("table",m("tbody.slist",{hook:{insert(){lichess.contentLoaded()}}},e.history.map((function(t){return m("tr",[m("td.reason",t.reason),m("td.mod",t.mod),m("td",m("time.timeago",{attrs:{datetime:t.date}}))])}))))]):void 0;return[m("div.top",{key:"mod-"+e.id},[m("span.text",{attrs:{"data-icon":""}},[Q(e.username)]),m("a",{attrs:{"data-icon":""},hook:P("click",t.close)})]),m("div.mchat__content.moderation",[m("i.line-text.block",['"',e.text,'"']),o,r,s])]}(e)||function(t){const e=t.vm.tab;return[m("div.mchat__tabs.nb_"+t.allTabs.length,{attrs:{role:"tablist"}},[...t.allTabs.map((n=>_t(t,n,e))),$t(t)]),m("div.mchat__content."+e,"note"===e&&t.note?[X(t.note,t.vm.autofocus)]:t.plugin&&e===t.plugin.tab.key?[t.plugin.view()]:Pt(t))]}(t))}function $t(t){const e=t.palantir;if(e.enabled())return e.instance?e.instance.render(m):m("div.mchat__tab.palantir.palantir-slot",{attrs:{"data-icon":"",title:"Voice chat"},hook:P("click",(()=>{e.loaded||(e.loaded=!0,lichess.loadScript("javascripts/vendor/peerjs.min.js").then((()=>{lichess.loadModule("palantir").then((()=>{e.instance=window.Palantir.palantir({uid:t.data.userId,redraw:t.redraw}),t.redraw()}))})))}))})}const _t=(t,e,n)=>m("div.mchat__tab."+e,{attrs:{role:"tab"},class:{"mchat__tab-active":e===n},hook:P("click",(()=>t.setTab(e)))},function(t,e){return"discussion"===e?[m("span",t.data.name),t.opts.alwaysEnabled?void 0:m("input",{attrs:{type:"checkbox",title:t.trans.noarg("toggleTheChat"),checked:t.vm.enabled},hook:P("change",(e=>{t.setEnabled(e.target.checked)}))})]:"note"===e?[m("span",t.trans.noarg("notes"))]:t.plugin&&e===t.plugin.tab.key?[m("span",t.plugin.tab.name)]:[]}(t,e));const Nt={a:"a1",b:"b1",c:"c1",d:"d1",e:"e1",f:"f1",g:"g1",h:"h1",i:"a2",j:"b2",k:"c2",l:"d2",m:"e2",n:"f2",o:"g2",p:"h2",q:"a3",r:"b3",s:"c3",t:"d3",u:"e3",v:"f3",w:"g3",x:"h3",y:"a4",z:"b4",A:"c4",B:"d4",C:"e4",D:"f4",E:"g4",F:"h4",G:"a5",H:"b5",I:"c5",J:"d5",K:"e5",L:"f5",M:"g5",N:"h5",O:"a6",P:"b6",Q:"c6",R:"d6",S:"e6",T:"f6",U:"g6",V:"h6",W:"a7",X:"b7",Y:"c7",Z:"d7",0:"e7",1:"f7",2:"g7",3:"h7",4:"a8",5:"b8",6:"c8",7:"d8",8:"e8",9:"f8","!":"g8","?":"h8"};function Dt(t){return"P"===t[0]?t.slice(1):t}function Ot(t){return null==t?null:t.match(/.{2}/g)||[]}const qt={e1a1:"e1c1",e1h1:"e1g1",e8a8:"e8c8",e8h8:"e8g8"},Lt=25,Rt=30,Ft=t=>t.game.status.id<Lt&&!Bt(t),Bt=t=>"import"===t.game.source,zt=t=>Bt(t)||(t=>t.game.status.id>=Rt)(t)||(t=>t.game.status.id===Lt)(t)&&(t=>(t=>t.game.turns-(t.game.startedAtTurn||0))(t)>1)(t);function jt(t,e){return t.player.color===e?t.player:t.opponent.color===e?t.opponent:null}function Gt(t){return t.slice(0,2)}function Vt(t){return t.slice(2)}function Ht(t){return t.slice(0,-2)}function Ut(t,e){return t.startsWith(e)}function Wt(t){let e="";for(const n in t)e+=t[n].id;return e}function Kt(t,e){const n=t.children[0];return n?e(n):void 0}function Jt(t,e){const n=function(t){return e(t)?t:Kt(t,n)};return n(t)}function Yt(t,e){const n=[t];let o,r=t;for(;o=e(r);)n.push(o),r=o;return n}function Xt(t){return t.children[0]}function Qt(t,e){return t.children.find((t=>t.id===e))}function Zt(t){return t[t.length-1]}function te(t,e){let n="";for(const o in t){if(!e(t[o]))break;n+=t[o].id}return n}function ee(t,e){t.children=t.children.filter((function(t){return t.id!==e}))}function ne(t){const e={nodes:1,comments:(t.comments||[]).length};return t.children.forEach((function(t){const n=ne(t);e.nodes+=n.nodes,e.comments+=n.comments})),e}function oe(t,e){t.eval=e.eval,e.glyphs&&(t.glyphs=e.glyphs),e.comments&&e.comments.forEach((function(e){t.comments?t.comments.some((function(t){return t.text===e.text}))||t.comments.push(e):t.comments=[e]})),e.children.forEach((function(e){const n=Qt(t,e.id);n?oe(n,e):t.children.push(e)}))}function re(t,e){return e<=0||!!t.children[1]||t.children[0]&&re(t.children[0],e-1)}function se(t){return Yt(t,Xt)}function ie(t,e){!function t(n){e(n),n.children.forEach(t)}(t)}function ae(t){function e(e){return n(t,e)}function n(t,e){if(""===e)return t;const o=Qt(t,Gt(e));return o?n(o,Vt(e)):t}function o(e){return r(t,e)}function r(t,e){if(""===e)return t;const n=Qt(t,Gt(e));return n?r(n,Vt(e)):void 0}function s(t,e){const n=Gt(e),o=Qt(t,n);return o?n+s(o,Vt(e)):""}function i(t,e){if(""===e)return!0;const n=Gt(e),o=t.children[0];return!(!o||o.id!==n)&&i(o,Vt(e))}function a(t,e){if(""===e)return t;const n=Gt(e),o=t.children[0];return o&&o.id===n?a(o,Vt(e)):t}function c(e){return Yt(t,(function(t){const n=Gt(e);if(""!==n)return e=Vt(e),Qt(t,n)}))}function l(t,e){const n=o(t);if(n)return e(n),n}function d(t,e){const n=e+t.id,r=o(n);return r?(["dests","drops","clock"].forEach((e=>{_(t[e])&&!_(r[e])&&(r[e]=t[e])})),n):l(e,(function(e){e.children.push(t)}))?n:void 0}function h(t,e){return l(e,(function(e){const n=(e.comments||[]).filter((function(e){return e.id!==t}));e.comments=n.length?n:void 0}))}function u(t){return e(Ht(t))}return{root:t,lastPly(){var e;return(null===(e=Jt(t,(t=>!t.children.length)))||void 0===e?void 0:e.ply)||t.ply},nodeAtPath:e,getNodeList:c,longestValidPath:e=>s(t,e),updateAt:l,addNode:d,addNodes:function t(e,n){const o=e[0];if(!o)return n;const r=d(o,n);return r?t(e.slice(1),r):void 0},addDests:(t,e)=>l(e,(function(e){e.dests=t})),setShapes:(t,e)=>l(e,(function(e){e.shapes=t})),setCommentAt:function(t,e){return t.text?l(e,(function(e){e.comments=e.comments||[];const n=e.comments.find((function(e){return e.id===t.id}));n?n.text=t.text:e.comments.push(t)})):h(t.id,e)},deleteCommentAt:h,setGlyphsAt:function(t,e){return l(e,(function(e){e.glyphs=t}))},setClockAt:(t,e)=>l(e,(function(e){e.clock=t})),pathIsMainline:function(e){return i(t,e)},pathIsForcedVariation:function(t){return!!c(t).find((t=>t.forceVariation))},lastMainlineNode:e=>a(t,e),pathExists:function(t){return!!o(t)},deleteNodeAt:function(t){ee(u(t),function(t){return t.slice(-2)}(t))},promoteAt:function(t,e){const n=c(t);for(let o=n.length-2;o>=0;o--){const t=n[o+1],r=n[o];if(r.children[0].id!==t.id){if(ee(r,t.id),r.children.unshift(t),!e)break}else if(t.forceVariation&&(t.forceVariation=!1,!e))break}},forceVariationAt:(t,e)=>l(t,(function(t){t.forceVariation=e})),getCurrentNodesAfterPly:function(t,e,n){const o=[];for(const r in t){const s=t[r];if(s.ply<=n&&e[r].id!==s.id)break;s.ply>n&&o.push(s)}return o},merge(e){oe(t,e)},removeCeval(){ie(t,(function(t){delete t.ceval,delete t.threat}))},removeComputerVariations(){se(t).forEach((function(t){t.children=t.children.filter((function(t){return!t.comp}))}))},parentNode:u,getParentClock:function(t,e){if(!("parentClock"in t)){const n=e&&u(e);t.parentClock=n?"clock"in n?n.clock:void 0:t.clock}return t.parentClock}}}function ce(t){const e=t.node.children[0];e&&t.userJumpIfCan(t.path+e.id)}function le(t){t.userJumpIfCan(Ht(t.path))}function de(t){t.userJumpIfCan(Wt(t.mainline))}function he(t){t.userJump("")}function ue(t){const e=t.node.children[1];e&&t.userJump(t.path+e.id)}function pe(t){if(t.onMainline)return;let e,n="";t.nodeList.slice(1,-1).forEach((function(t){n+=t.id,t.children[1]&&(e=n)})),e&&t.userJump(e)}var me=Object.freeze(Object.defineProperty({__proto__:null,next:ce,prev:le,last:de,first:he,enterVariation:ue,exitVariation:pe},Symbol.toStringTag,{value:"Module"}));function fe(t){fe.close();const e=$('<div id="modal-wrap"><span class="close" role="button" aria-label="Close" data-icon="" tabindex="0"></span></div>'),n=$(`<div id="modal-overlay" class="${t.class}">`);return t.noClickAway||n.on("click",fe.close),$('<a href="#"></a>').appendTo(n),e.appendTo(n),$('<a href="#"></a>').appendTo(n),t.content.clone().removeClass("none").appendTo(e),t.onInsert&&t.onInsert(e),fe.onClose=t.onClose,e.find(".close,.cancel").each((function(){ve(this,fe.close)})),$("body").addClass("overlayed").prepend(n),be(e),e}function ge(t){const e=t.onClose;return m("div#modal-overlay",t.noClickAway?{}:{hook:P("click",e)},[m("div#modal-wrap."+t.class,{hook:M((e=>{be($(e)),t.onInsert&&t.onInsert($(e))}))},[m("span.close",{attrs:{"data-icon":"",role:"button","aria-label":"Close",tabindex:"0"},hook:M((t=>ve(t,e)))}),m("div",t.content)])])}fe.close=()=>{$("body").removeClass("overlayed"),$("#modal-overlay").each((function(){fe.onClose&&fe.onClose(),$(this).remove()})),delete fe.onClose},fe.onClose=void 0;const ve=(t,e)=>{t.addEventListener("click",e),t.addEventListener("keydown",(t=>"Enter"!==t.code&&"Space"!==t.code||e()))},be=t=>{t.on("click",(t=>t.stopPropagation())),ye(t)},ye=t=>{const e=t.find('button:not(:disabled), [href], input:not(:disabled):not([type="hidden"]), select:not(:disabled), textarea:not(:disabled), [tabindex="0"]');setTimeout((()=>{var t,n;return null===(n=null!==(t=e[1])&&void 0!==t?t:e[0])||void 0===n?void 0:n.focus()}))},we=[{"stroke-width":3.779,d:"m21.78 12.64c-1.284 8.436 8.943 12.7 14.54 17.61 3 2.632 4.412 4.442 5.684 7.93"},{"stroke-width":4.157,d:"m43.19 36.32c2.817-1.203 6.659-5.482 5.441-7.623-2.251-3.957-8.883-14.69-11.89-19.73-0.4217-0.7079-0.2431-1.835 0.5931-3.3 1.358-2.38 1.956-5.628 1.956-5.628"},{"stroke-width":4.535,d:"m37.45 2.178s-3.946 0.6463-6.237 2.234c-0.5998 0.4156-2.696 0.7984-3.896 0.6388-17.64-2.345-29.61 14.08-25.23 27.34 4.377 13.26 22.54 25.36 39.74 8.666"}],ke=()=>m("div.spinner",{"aria-label":"loading"},[m("svg",{attrs:{viewBox:"-2 -2 54 54"}},[m("g",{attrs:{mask:"url(#mask)",fill:"none"}},we.map((t=>m("path",{attrs:t}))))])]),Ce=t=>{const e=window.Mousetrap;if(e&&(e.bind(["left","k"],(()=>{le(t),t.redraw()})).bind(["shift+left","shift+k"],(()=>{pe(t),t.redraw()})).bind(["right","j"],(()=>{t.fork.proceed()||ce(t),t.redraw()})).bind(["shift+right","shift+j"],(()=>{ue(t),t.redraw()})).bind(["up","0"],(()=>{t.fork.prev()||he(t),t.redraw()})).bind(["down","$"],(()=>{t.fork.next()||de(t),t.redraw()})).bind("shift+c",(()=>{t.showComments=!t.showComments,t.autoScroll(),t.redraw()})).bind("shift+i",(()=>{t.treeView.toggle(),t.redraw()})).bind("z",(()=>{t.toggleComputer(),t.redraw()})),!t.embed&&(e.bind("space",(()=>{const e=t.gamebookPlay();if(e)e.onSpace();else{if(t.practice||t.studyPractice)return;t.ceval.enabled()?t.playBestMove():t.toggleCeval()}})),!t.studyPractice&&(e.bind("f",t.flip).bind("?",(()=>{t.keyboardHelp=!t.keyboardHelp,t.redraw()})).bind("l",t.toggleCeval).bind("a",(()=>{t.toggleAutoShapes(!t.showAutoShapes()),t.redraw()})).bind("x",t.toggleThreatMode).bind("e",(()=>{t.toggleExplorer(),t.redraw()})),t.study)))){const n=(t,n)=>{e.bind(t,(()=>{$(n).each((function(){this.dispatchEvent(new Event("mousedown"))}))}))};n("d",".study__buttons .comments"),n("g",".study__buttons .glyphs"),e.bind("p",t.study.goToPrevChapter),e.bind("n",t.study.goToNextChapter)}};function xe(t){return ge({class:"keyboard-help",onInsert:async e=>{const[,n]=await Promise.all([lichess.loadCssPath("analyse.keyboard"),G(U("/analysis/help",{study:!!t.study}))]);e.find(".scrollable").html(n)},onClose(){t.keyboardHelp=!1,t.redraw()},content:[m("div.scrollable",ke())]})}function Me(t){!window.LichessSpeech&&t?lichess.loadModule("speech"):window.LichessSpeech&&!t&&(window.LichessSpeech=void 0)}function Pe(t){var e;e=e=>e.step(t,!0),window.LichessSpeech&&e(window.LichessSpeech)}const Se="button.button.button-red.button-empty";function Ee(t){return function(){return t}}function Ae(t){return m("i",{attrs:A(t)})}function Te(t){return t.san?(e=t.ply,Math.floor((e-1)/2)+1+(t.ply%2==1?".":"...")+" "+Dt(t.san)):"Initial position";var e}function Ie(t,e){return e+" "+(1===e?t:t+"s")}function $e(t){const e=t.split(" ");return(1===e.length?e[0]:e[1]).toLowerCase()}function _e(){return`${window.location.protocol}//${window.location.host}`}function Ne(t,e,n){return m("option",{attrs:{value:t,selected:t===e}},n)}function De(t,e){t&&e&&(t.scrollTop=e.offsetTop-t.offsetHeight/2+e.offsetHeight/2)}function Oe(t,e){return function(t){let e,n;return function(...o){const r=this,s=()=>{n=void 0,e=t.apply(r,o).finally((()=>{e=void 0,n&&n()}))};e?n=s:s()}}((function(...n){return e.apply(this,n),new Promise((e=>setTimeout(e,t)))}))}function qe(t){const e=q(t.initDict),n=q(null),o={};let r={},s=[];function i(){return t.myId===t.ownerId||t.admin&&c()}function a(){return t.myId?e()[t.myId]:void 0}function c(){const t=a();return!!t&&"w"===t.role}const l=function(t,e,n,o,r){const s=q(!1),i=q([]);return{open:s,members:e,spectators:i,toggle(){s(!s())},invite(e){t("invite",$e(e)),n()},redraw:o,trans:r}}(t.send,e,(()=>t.tab("members")),t.redraw,t.trans);function d(e){"members"===t.tab()&&(o[e]?o[e]():o[e]=function(t){let e;const n=()=>{e&&clearTimeout(e),e=setTimeout(t,100)};return n(),n}((()=>{delete o[e],t.redraw()})),t.redraw())}function h(){r={};const n=e();s.forEach((function(t){n[t]&&(r[t]=!0)})),"members"===t.tab()&&t.redraw()}return lichess.pubsub.on("socket.in.crowd",(t=>{const e=t.users||[];l.spectators(e),s=e.map($e),h()})),{dict:e,confing:n,myId:t.myId,inviteForm:l,update(o){i()&&n(Object.keys(o).find((t=>!e()[t]))||null);const r=a()&&!c(),s=a()&&c();e(o),r&&c()?(lichess.once("study-tour")&&t.startTour(),t.onBecomingContributor(),t.notif.set({text:t.trans.noarg("youAreNowAContributor"),duration:3e3})):s&&!c()&&t.notif.set({text:t.trans.noarg("youAreNowASpectator"),duration:3e3}),h()},setActive:d,isActive:t=>!!o[t],owner:function(){return e()[t.ownerId]},myMember:a,isOwner:i,canContribute:c,max:30,setRole(e,o){d(e),t.send("setRole",{userId:e,role:o}),n(null)},kick(e){t.send("kick",e),n(null)},leave(){t.send("leave")},ordered(){const t=e();return Object.keys(t).map((e=>t[e])).sort(((t,e)=>"r"===t.role&&"w"===e.role?1:"w"===t.role&&"r"===e.role?-1:0))},size:()=>Object.keys(e()).length,isOnline:t=>r[t],hasOnlineContributor(){const t=e();for(const e in t)if(r[e]&&"w"===t[e].role)return!0;return!1}}}function Le(t){const e=t.members,n=e.isOwner();function o(t){const e=t.user;return m("span.user-link.ulpt",{attrs:{"data-href":"/@/"+e.name}},(e.title?e.title+" ":"")+e.name)}function r(n){const o="w"===n.role;return m("span.status",{class:{contrib:o,active:e.isActive(n.user.id),online:e.isOnline(n.user.id)},attrs:{title:t.trans.noarg(o?"contributor":"spectator")}},[Ae(o?"":"")])}function s(t,o){return n&&(o.user.id!==e.myId||t.data.admin)?m("i.act",{attrs:A(""),hook:P("click",(t=>e.confing(e.confing()==o.user.id?null:o.user.id)),t.redraw)}):n||o.user.id!==e.myId?void 0:m("i.act.leave",{attrs:{"data-icon":"",title:t.trans.noarg("leaveTheStudy")},hook:P("click",e.leave,t.redraw)})}function i(n){const o="member-role";return m("m-config",{key:n.user.id+"-config",hook:M((t=>De($(t).parent(".members")[0],t)))},[m("div.role",[m("div.switch",[m("input.cmn-toggle",{attrs:{id:o,type:"checkbox",checked:"w"===n.role},hook:P("change",(t=>{e.setRole(n.user.id,t.target.checked?"w":"r")}),t.redraw)}),m("label",{attrs:{for:o}})]),m("label",{attrs:{for:o}},t.trans.noarg("contributor"))]),m("div.kick",m("a.button.button-red.button-empty.text",{attrs:A(""),hook:P("click",(t=>e.kick(n.user.id)),t.redraw)},t.trans.noarg("kick")))])}const a=e.ordered();return m("div.study__members",{hook:M((()=>lichess.pubsub.emit("chat.resize")))},[...a.map((n=>{const a=e.confing()===n.user.id;return[m("div",{key:n.user.id,class:{editing:!!a}},[m("div.left",[r(n),o(n)]),s(t,n)]),a?i(n):null]})).reduce(((t,e)=>t.concat(e)),[]),n&&a.length<e.max?m("div.add",{key:"add",hook:P("click",e.inviteForm.toggle,t.redraw)},[m("div.left",[m("span.status",Ae("")),m("div.user-link",t.trans.noarg("addMembers"))])]):null,!e.canContribute()&&t.data.admin?m("form.admin",{key:":admin",hook:S("submit",(()=>(V(`/study/${t.data.id}/admin`,{method:"post"}).then((()=>location.reload())),!1)))},[m("button.button.button-red.button-thin","Enter as admin")]):null])}class Re{unwrap(t,e){const n=this._chain((e=>ze.ok(t?t(e):e)),(t=>e?ze.ok(e(t)):ze.err(t)));if(n.isErr)throw n.error;return n.value}map(t,e){return this._chain((e=>ze.ok(t(e))),(t=>ze.err(e?e(t):t)))}chain(t,e){return this._chain(t,e||(t=>ze.err(t)))}}class Fe extends Re{constructor(t){super(),this.value=void 0,this.isOk=!0,this.isErr=!1,this.value=t}_chain(t,e){return t(this.value)}}class Be extends Re{constructor(t){super(),this.error=void 0,this.isOk=!1,this.isErr=!0,this.error=t}_chain(t,e){return e(this.error)}}var ze;!function(t){t.ok=function(t){return new Fe(t)},t.err=function(t){return new Be(t||new Error)},t.all=function(e){if(Array.isArray(e)){const n=[];for(let t=0;t<e.length;t++){const o=e[t];if(o.isErr)return o;n.push(o.value)}return t.ok(n)}const n={},o=Object.keys(e);for(let t=0;t<o.length;t++){const r=e[o[t]];if(r.isErr)return r;n[o[t]]=r.value}return t.ok(n)}}(ze||(ze={}));const je=["a","b","c","d","e","f","g","h"],Ge=["1","2","3","4","5","6","7","8"],Ve=["white","black"],He=["pawn","knight","bishop","rook","queen","king"],Ue=["a","h"],We=t=>"role"in t,Ke=t=>(t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459),Math.imul(t+(t>>>4)&252645135,16843009)>>24),Je=t=>(t=t>>>8&16711935|(16711935&t)<<8)>>>16&65535|(65535&t)<<16,Ye=t=>Je(t=(t=(t=t>>>1&1431655765|(1431655765&t)<<1)>>>2&858993459|(858993459&t)<<2)>>>4&252645135|(252645135&t)<<4);class Xe{constructor(t,e){this.lo=0|t,this.hi=0|e}static fromSquare(t){return t>=32?new Xe(0,1<<t-32):new Xe(1<<t,0)}static fromRank(t){return new Xe(255,0).shl64(8*t)}static fromFile(t){return new Xe(16843009<<t,16843009<<t)}static empty(){return new Xe(0,0)}static full(){return new Xe(4294967295,4294967295)}static corners(){return new Xe(129,2164260864)}static center(){return new Xe(402653184,24)}static backranks(){return new Xe(255,4278190080)}static backrank(t){return"white"===t?new Xe(255,0):new Xe(0,4278190080)}static lightSquares(){return new Xe(1437226410,1437226410)}static darkSquares(){return new Xe(2857740885,2857740885)}complement(){return new Xe(~this.lo,~this.hi)}xor(t){return new Xe(this.lo^t.lo,this.hi^t.hi)}union(t){return new Xe(this.lo|t.lo,this.hi|t.hi)}intersect(t){return new Xe(this.lo&t.lo,this.hi&t.hi)}diff(t){return new Xe(this.lo&~t.lo,this.hi&~t.hi)}intersects(t){return this.intersect(t).nonEmpty()}isDisjoint(t){return this.intersect(t).isEmpty()}supersetOf(t){return t.diff(this).isEmpty()}subsetOf(t){return this.diff(t).isEmpty()}shr64(t){return t>=64?Xe.empty():t>=32?new Xe(this.hi>>>t-32,0):t>0?new Xe(this.lo>>>t^this.hi<<32-t,this.hi>>>t):this}shl64(t){return t>=64?Xe.empty():t>=32?new Xe(0,this.lo<<t-32):t>0?new Xe(this.lo<<t,this.hi<<t^this.lo>>>32-t):this}bswap64(){return new Xe(Je(this.hi),Je(this.lo))}rbit64(){return new Xe(Ye(this.hi),Ye(this.lo))}minus64(t){const e=this.lo-t.lo,n=(e&t.lo&1)+(t.lo>>>1)+(e>>>1)>>>31;return new Xe(e,this.hi-(t.hi+n))}equals(t){return this.lo===t.lo&&this.hi===t.hi}size(){return Ke(this.lo)+Ke(this.hi)}isEmpty(){return 0===this.lo&&0===this.hi}nonEmpty(){return 0!==this.lo||0!==this.hi}has(t){return 0!=(t>=32?this.hi&1<<t-32:this.lo&1<<t)}set(t,e){return e?this.with(t):this.without(t)}with(t){return t>=32?new Xe(this.lo,this.hi|1<<t-32):new Xe(this.lo|1<<t,this.hi)}without(t){return t>=32?new Xe(this.lo,this.hi&~(1<<t-32)):new Xe(this.lo&~(1<<t),this.hi)}toggle(t){return t>=32?new Xe(this.lo,this.hi^1<<t-32):new Xe(this.lo^1<<t,this.hi)}last(){return 0!==this.hi?63-Math.clz32(this.hi):0!==this.lo?31-Math.clz32(this.lo):void 0}first(){return 0!==this.lo?31-Math.clz32(this.lo&-this.lo):0!==this.hi?63-Math.clz32(this.hi&-this.hi):void 0}withoutFirst(){return 0!==this.lo?new Xe(this.lo&this.lo-1,this.hi):new Xe(0,this.hi&this.hi-1)}moreThanOne(){return 0!==this.hi&&0!==this.lo||0!=(this.lo&this.lo-1)||0!=(this.hi&this.hi-1)}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let t=this.lo,e=this.hi;for(;0!==t;){const e=31-Math.clz32(t&-t);t^=1<<e,yield e}for(;0!==e;){const t=31-Math.clz32(e&-e);e^=1<<t,yield 32+t}}*reversed(){let t=this.lo,e=this.hi;for(;0!==e;){const t=31-Math.clz32(e);e^=1<<t,yield 32+t}for(;0!==t;){const e=31-Math.clz32(t);t^=1<<e,yield e}}}class Qe{constructor(){}static default(){const t=new Qe;return t.reset(),t}reset(){this.occupied=new Xe(65535,4294901760),this.promoted=Xe.empty(),this.white=new Xe(65535,0),this.black=new Xe(0,4294901760),this.pawn=new Xe(65280,16711680),this.knight=new Xe(66,1107296256),this.bishop=new Xe(36,603979776),this.rook=new Xe(129,2164260864),this.queen=new Xe(8,134217728),this.king=new Xe(16,268435456)}static empty(){const t=new Qe;return t.clear(),t}clear(){this.occupied=Xe.empty(),this.promoted=Xe.empty();for(const t of Ve)this[t]=Xe.empty();for(const t of He)this[t]=Xe.empty()}clone(){const t=new Qe;t.occupied=this.occupied,t.promoted=this.promoted;for(const e of Ve)t[e]=this[e];for(const e of He)t[e]=this[e];return t}getColor(t){return this.white.has(t)?"white":this.black.has(t)?"black":void 0}getRole(t){for(const e of He)if(this[e].has(t))return e}get(t){const e=this.getColor(t);if(!e)return;return{color:e,role:this.getRole(t),promoted:this.promoted.has(t)}}take(t){const e=this.get(t);return e&&(this.occupied=this.occupied.without(t),this[e.color]=this[e.color].without(t),this[e.role]=this[e.role].without(t),e.promoted&&(this.promoted=this.promoted.without(t))),e}set(t,e){const n=this.take(t);return this.occupied=this.occupied.with(t),this[e.color]=this[e.color].with(t),this[e.role]=this[e.role].with(t),e.promoted&&(this.promoted=this.promoted.with(t)),n}has(t){return this.occupied.has(t)}*[Symbol.iterator](){for(const t of this.occupied)yield[t,this.get(t)]}pieces(t,e){return this[t].intersect(this[e])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(t){return this.pieces(t,"king").singleSquare()}}class Ze{constructor(){}static empty(){const t=new Ze;for(const e of He)t[e]=0;return t}static fromBoard(t,e){const n=new Ze;for(const o of He)n[o]=t.pieces(e,o).size();return n}clone(){const t=new Ze;for(const e of He)t[e]=this[e];return t}equals(t){return He.every((e=>this[e]===t[e]))}add(t){const e=new Ze;for(const n of He)e[n]=this[n]+t[n];return e}nonEmpty(){return He.some((t=>this[t]>0))}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}size(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}}class tn{constructor(t,e){this.white=t,this.black=e}static empty(){return new tn(Ze.empty(),Ze.empty())}static fromBoard(t){return new tn(Ze.fromBoard(t,"white"),Ze.fromBoard(t,"black"))}clone(){return new tn(this.white.clone(),this.black.clone())}equals(t){return this.white.equals(t.white)&&this.black.equals(t.black)}add(t){return new tn(this.white.add(t.white),this.black.add(t.black))}count(t){return this.white[t]+this.black[t]}size(){return this.white.size()+this.black.size()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}}class en{constructor(t,e){this.white=t,this.black=e}static default(){return new en(3,3)}clone(){return new en(this.white,this.black)}equals(t){return this.white===t.white&&this.black===t.black}}const nn=t=>void 0!==t,on=t=>"white"===t?"black":"white",rn=t=>t>>3,sn=t=>7&t,an=t=>{switch(t){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}};function cn(t){switch(t.toLowerCase()){case"p":return"pawn";case"n":return"knight";case"b":return"bishop";case"r":return"rook";case"q":return"queen";case"k":return"king";default:return}}function ln(t){if(2!==t.length)return;const e=t.charCodeAt(0)-"a".charCodeAt(0),n=t.charCodeAt(1)-"1".charCodeAt(0);return e<0||e>=8||n<0||n>=8?void 0:e+8*n}const dn=t=>je[sn(t)]+Ge[rn(t)],hn=t=>{if("@"===t[1]&&4===t.length){const e=cn(t[0]),n=ln(t.slice(2));if(e&&nn(n))return{role:e,to:n}}else if(4===t.length||5===t.length){const e=ln(t.slice(0,2)),n=ln(t.slice(2,4));let o;if(5===t.length&&(o=cn(t[4]),!o))return;if(nn(e)&&nn(n))return{from:e,to:n,promotion:o}}},un=(t,e)=>"white"===t?"a"===e?2:6:"a"===e?58:62;var pn;!function(t){t.Fen="ERR_FEN",t.Board="ERR_BOARD",t.Pockets="ERR_POCKETS",t.Turn="ERR_TURN",t.Castling="ERR_CASTLING",t.EpSquare="ERR_EP_SQUARE",t.RemainingChecks="ERR_REMAINING_CHECKS",t.Halfmoves="ERR_HALFMOVES",t.Fullmoves="ERR_FULLMOVES"}(pn||(pn={}));class mn extends Error{}const fn=t=>/^\d{1,4}$/.test(t)?parseInt(t,10):void 0,gn=t=>{const e=cn(t);return e&&{role:e,color:t.toLowerCase()===t?"black":"white"}},vn=t=>{const e=Qe.empty();let n=7,o=0;for(let r=0;r<t.length;r++){const s=t[r];if("/"===s&&8===o)o=0,n--;else{const i=parseInt(s,10);if(i>0)o+=i;else{if(o>=8||n<0)return ze.err(new mn(pn.Board));const i=o+8*n,a=gn(s);if(!a)return ze.err(new mn(pn.Board));"~"===t[r+1]&&(a.promoted=!0,r++),e.set(i,a),o++}}}return 0!==n||8!==o?ze.err(new mn(pn.Board)):ze.ok(e)},bn=t=>{if(t.length>64)return ze.err(new mn(pn.Pockets));const e=tn.empty();for(const n of t){const t=gn(n);if(!t)return ze.err(new mn(pn.Pockets));e[t.color][t.role]++}return ze.ok(e)},yn=t=>{const e=t.split("+");if(3===e.length&&""===e[0]){const t=fn(e[1]),n=fn(e[2]);return!nn(t)||t>3||!nn(n)||n>3?ze.err(new mn(pn.RemainingChecks)):ze.ok(new en(3-t,3-n))}if(2===e.length){const t=fn(e[0]),n=fn(e[1]);return!nn(t)||t>3||!nn(n)||n>3?ze.err(new mn(pn.RemainingChecks)):ze.ok(new en(t,n))}return ze.err(new mn(pn.RemainingChecks))},wn=t=>{const e=t.split(/[\s_]+/),n=e.shift();let o,r,s=ze.ok(void 0);if(n.endsWith("]")){const t=n.indexOf("[");if(-1===t)return ze.err(new mn(pn.Fen));o=vn(n.slice(0,t)),s=bn(n.slice(t+1,-1))}else{const t=((t,e,n)=>{let o=t.indexOf(e);for(;n-- >0&&-1!==o;)o=t.indexOf(e,o+e.length);return o})(n,"/",7);-1===t?o=vn(n):(o=vn(n.slice(0,t)),s=bn(n.slice(t+1)))}const i=e.shift();if(nn(i)&&"w"!==i){if("b"!==i)return ze.err(new mn(pn.Turn));r="black"}else r="white";return o.chain((t=>{const n=e.shift(),o=nn(n)?((t,e)=>{let n=Xe.empty();if("-"===e)return ze.ok(n);for(const o of e){const e=o.toLowerCase(),r=o===e?"black":"white",s=Xe.backrank(r).intersect(t[r]);let i;if("q"===e)i=s;else if("k"===e)i=s.reversed();else{if(!("a"<=e&&e<="h"))return ze.err(new mn(pn.Castling));i=Xe.fromSquare(e.charCodeAt(0)-"a".charCodeAt(0)).intersect(s)}for(const o of i){if(t.king.has(o))break;if(t.rook.has(o)){n=n.with(o);break}}}return Ve.some((t=>Xe.backrank(t).intersect(n).size()>2))?ze.err(new mn(pn.Castling)):ze.ok(n)})(t,n):ze.ok(Xe.empty()),i=e.shift();let a;if(nn(i)&&"-"!==i&&(a=ln(i),!nn(a)))return ze.err(new mn(pn.EpSquare));let c,l=e.shift();nn(l)&&l.includes("+")&&(c=yn(l),l=e.shift());const d=nn(l)?fn(l):0;if(!nn(d))return ze.err(new mn(pn.Halfmoves));const h=e.shift(),u=nn(h)?fn(h):1;if(!nn(u))return ze.err(new mn(pn.Fullmoves));const p=e.shift();let m=ze.ok(void 0);if(nn(p)){if(nn(c))return ze.err(new mn(pn.RemainingChecks));m=yn(p)}else nn(c)&&(m=c);return e.length>0?ze.err(new mn(pn.Fen)):s.chain((e=>o.chain((n=>m.map((o=>({board:t,pockets:e,turn:r,unmovedRooks:n,remainingChecks:o,epSquare:a,halfmoves:d,fullmoves:Math.max(1,u)})))))))}))},kn=t=>{let e=an(t.role);return"white"===t.color&&(e=e.toUpperCase()),t.promoted&&(e+="~"),e},Cn=t=>{let e="",n=0;for(let o=7;o>=0;o--)for(let r=0;r<8;r++){const s=r+8*o,i=t.get(s);i?(n>0&&(e+=n,n=0),e+=kn(i)):n++,7===r&&(n>0&&(e+=n,n=0),0!==o&&(e+="/"))}return e},xn=lichess.storage;function Mn(t,e){const n="analyse."+t,o=!0===e||!1===e;let r;return function(t){return _(t)&&t!=r?(r=t+"",xn.set(n,t)):_(r)||(r=xn.get(n),null===r&&(r=e+"")),o?"true"===r:r}}const Pn=(t,e)=>n=>{if(_(n))return xn.set(t,JSON.stringify(n)),n;const o=JSON.parse(xn.get(t));return null!==o?o:e()};const Sn=[["normal","normalAnalysis"],["practice","practiceWithComputer"],["conceal","hideNextMoves"],["gamebook","interactiveLesson"]],En=(t,e)=>{var n;return null===(n=t.target.querySelector("#chapter-"+e))||void 0===n?void 0:n.value};function An(t,e,n,o){const r={variants:[],open:!1,initial:q(!1),tab:Mn("study.form.tab","init"),editor:null,editorFen:q(null),isDefaultName:!0};function s(){r.variants.length||z("/variant",{cache:"default"}).then((function(t){r.variants=t,o.redraw()}))}function i(){lichess.pubsub.emit("tour.stop"),r.open=!0,s(),r.initial(!1)}function a(){lichess.pubsub.emit("tour.stop"),r.open=!1}return{vm:r,open:i,root:o,openInitial(){i(),r.initial(!0)},close:a,toggle(){r.open?a():i()},submit(e){const s=o.study,i={...e,sticky:s.vm.mode.sticky,initial:r.initial()};var c,l;i.pgn?(c=s.data.id,l=i,z(`/study/${c}/import-pgn?sri=${lichess.sri}`,{method:"POST",body:H(l)})):t("addChapter",i),a(),n()},chapters:e,startTour:()=>function(t){lichess.loadScript("javascripts/study/tour-chapter.js").then((()=>{window.lichess.studyTourChapter({setTab:t})}))}((t=>{r.tab(t),o.redraw()})),multiPgnMax:32,redraw:o.redraw}}function Tn(t){return"orientation"in t}function In(t,e){const n=e.practice?"practice":_(e.conceal)?"conceal":e.gamebook?"gamebook":"normal",o=t.trans.noarg;return[m("div.form-split",[m("div.form-group.form-half",[m("label.form-label",{attrs:{for:"chapter-orientation"}},o("orientation")),m("select#chapter-orientation.form-control",["white","black"].map((function(t){return Ne(t,e.orientation,o(t))})))]),m("div.form-group.form-half",[m("label.form-label",{attrs:{for:"chapter-mode"}},o("analysisMode")),m("select#chapter-mode.form-control",Sn.map((t=>Ne(t[0],n,o(t[1])))))])]),m("div.form-group",[m("label.form-label",{attrs:{for:"chapter-description"}},o("pinnedChapterComment")),m("select#chapter-description.form-control",[["",o("noPinnedComment")],["1",o("rightUnderTheBoard")]].map((t=>Ne(t[0],e.description?"1":"",t[1]))))]),m("div.form-actions-secondary.destructive",[m(Se,{hook:P("click",(n=>{confirm(o("clearAllCommentsInThisChapter"))&&t.clearAnnotations(e.id)}),t.redraw),attrs:{type:"button",title:o("clearAllCommentsInThisChapter")}},o("clearAnnotations")),m(Se,{hook:P("click",(n=>{confirm(o("clearVariations"))&&t.clearVariations(e.id)}),t.redraw),attrs:{type:"button"}},o("clearVariations"))]),m("div.form-actions",[m(Se,{hook:P("click",(n=>{confirm(o("deleteThisChapter"))&&t.delete(e.id)}),t.redraw),attrs:{type:"button",title:o("deleteThisChapter")}},o("deleteChapter")),m("button.button",{attrs:{type:"submit"}},o("saveChapter"))])]}function $n(t,e,n,o,r){const s=q(t),i=An(e,s,n,r),a=function(t,e,n,o){const r=q(null);function s(t){r({id:t.id,name:t.name}),e(t.id).then((t=>{r(t),o()}))}function i(t){const e=r();return!!e&&e.id===t}return{open:s,toggle(t){i(t.id)?r(null):s(t)},current:r,submit(e){const n=r();n&&(t("editChapter",{id:n.id,...e}),r(null))},delete(e){t("deleteChapter",e),r(null)},clearAnnotations(e){t("clearAnnotations",e),r(null)},clearVariations(e){t("clearVariations",e),r(null)},isEditing:i,trans:n,redraw:o}}(e,o,r.trans,r.redraw);return{newForm:i,editForm:a,list:s,get:t=>s().find((e=>e.id===t)),size:()=>s().length,sort(t){e("sortChapters",t)},firstChapterId:()=>s()[0].id,toggleNewForm(){i.vm.open||s().length<64?i.toggle():alert("You have reached the limit of 64 chapters per study. Please create a new study.")},localPaths:{}}}function _n(t){const e=Nn(t.tags,"result");return e&&"*"!==e}function Nn(t,e){const n=t.find((t=>t[0].toLowerCase()===e));return n&&n[1]}const Dn=t=>{var e;return!!(null===(e=Nn(t,"site"))||void 0===e?void 0:e.match(new RegExp(location.hostname+"/\\w{8}$")))};function On(t){const e=t.members.canContribute(),n=t.currentChapter();function o(o){const r=t.chapters.list().length,s=o.data.li,i=o.elm;if(s.count!==r?n.id!==t.chapters.firstChapterId()&&De(i,i.querySelector(".active")):t.vm.loading&&s.loadingId!==t.vm.nextChapterId&&(s.loadingId=t.vm.nextChapterId,De(i,i.querySelector(".loading"))),s.count=r,e&&r>1&&!s.sortable){const e=function(){s.sortable=window.Sortable.create(i,{draggable:".draggable",handle:"ontouchstart"in window?"span":void 0,onSort(){t.chapters.sort(s.sortable.toArray())}})};window.Sortable?e():lichess.loadScript("javascripts/vendor/Sortable.min.js").then(e)}}return m("div.study__chapters",{hook:{insert(e){e.elm.addEventListener("click",(e=>{const n=e.target,o=n.parentNode.getAttribute("data-id")||n.getAttribute("data-id");if(o)if("act"===n.className){const e=t.chapters.get(o);e&&t.chapters.editForm.toggle(e)}else t.setChapter(o)})),e.data.li={},o(e),lichess.pubsub.emit("chat.resize")},postpatch(t,e){e.data.li=t.data.li,o(e)},destroy:t=>{const e=t.data.li.sortable;e&&e.destroy()}}},t.chapters.list().map(((o,r)=>{var s;const i=t.chapters.editForm.isEditing(o.id),a=t.vm.loading&&o.id===t.vm.nextChapterId,c=!t.vm.loading&&n&&!(null===(s=t.relay)||void 0===s?void 0:s.tourShow.active)&&n.id===o.id;return m("div",{key:o.id,attrs:{"data-id":o.id},class:{active:c,editing:i,loading:a,draggable:e}},[m("span",a?m("span.ddloader"):[""+(r+1)]),m("h3",o.name),o.ongoing?m("ongoing",{attrs:{...A(""),title:"Ongoing"}}):null,!o.ongoing&&o.res?m("res",o.res):null,e?m("i.act",{attrs:A("")}):null])})).concat(t.members.canContribute()?[m("div.add",{hook:P("click",t.chapters.toggleNewForm,t.redraw)},[m("span",Ae("")),m("h3",t.trans.noarg("addNewChapter"))])]:[]))}const qn=t=>Rn(t)?!t.ceval.mate&&Math.abs(t.ceval.cp)<150:null,Ln=(t,e,n,o)=>{if(!Rn(e)){const n=t.position(e).unwrap();return!n.isStalemate()&&!n.isInsufficientMaterial()&&null}const r=e.ceval.mate>0?99999:e.ceval.mate<0?-99999:e.ceval.cp;return"white"===o?r>=n:r<=n},Rn=t=>t.ceval&&t.ceval.depth>=16;function Fn(t,e,n){const o=t.node;if(!o.uci)return null;const r=t.outcome();if(r&&r.winner&&r.winner!==t.bottomColor())return!1;if(r&&r.winner&&r.winner===t.bottomColor())return!0;if((s=t.practice.comment())&&("mistake"===s.verdict||"blunder"===s.verdict))return!1;var s;switch(e.result){case"drawIn":case"equalIn":if(o.threefold)return!0;if(!1===qn(o))return!1;if(n>e.moves)return!1;if(r&&!r.winner)return!0;if(n>=e.moves)return qn(o);break;case"evalIn":if(n>=e.moves)return Ln(t,o,e.cp,t.bottomColor());break;case"mateIn":{if(n>e.moves)return!1;const r=((t,e)=>{if(!Rn(t))return null;if(!t.ceval.mate)return!1;const n=t.ceval.mate*("white"===e?1:-1);return n>0&&n})(o,t.bottomColor());if(null===r)return null;if(!r||r+n>e.moves)return!1;break}case"promotion":return o.uci[4]?Ln(t,o,e.cp,t.bottomColor()):null}return null}function Bn(t,e,n){const o=q(t.data.practiceGoal),r=q(0),s=q(null),i=Mn("practice-auto-next",!0);function a(){t.showAutoShapes=Ee(!0),t.showGauge=Ee(!0),t.showComputer=Ee(!0),o(t.data.practiceGoal),r(0),s(null);const i=e.chapter;history.replaceState(null,i.name,n.url+"/"+i.id)}function c(){const e=t.study.gamebookPlay();if(e)return void("end"===e.state.feedback&&l());if(!t.study.data.chapter.practice)return d();if(null!==s())return;r(function(){let e=t.node.ply-t.tree.root.ply;return t.bottomColor()!==t.data.player.color&&e--,Math.ceil(e/2)}());const n=s(Fn(t,o(),r()));n?l():!1===n&&(t.node.fail=!0,lichess.sound.play("practiceFailure"))}function l(){d(),lichess.sound.play("practiceSuccess"),e.chapter.practice&&i()&&setTimeout(t.study.goToNextChapter,1e3)}function d(){const e=t.study.currentChapter().id,o=n.completion[e];(void 0===o||r()<o)&&(n.completion[e]=r(),((t,e)=>{z(`/practice/complete/${t}/${e}`,{method:"POST"})})(e,r()))}return lichess.sound.loadOggOrMp3("practiceSuccess",`${lichess.sound.baseUrl}/other/energy3`,!0),lichess.sound.loadOggOrMp3("practiceFailure",`${lichess.sound.baseUrl}/other/failure2`,!0),a(),{onLoad:a,onJump(){!1!==s()||t.nodeList.find((t=>!!t.fail))||s(null),c()},onCeval:c,data:n,goal:o,success:s,nbMoves:r,reset(){t.tree.root.children=[],t.userJump(""),t.practice.reset(),a(),t.practice.resume()},isWhite:t.bottomIsWhite,analysisUrl:()=>`/analysis/standard/${t.node.fen.replace(/ /g,"_")}?color=${t.bottomColor()}`,autoNext:i}}const zn=t=>"object"==typeof t,jn=t=>t?"string"==typeof t?t:t.name:"Unknown";function Gn(t,e){if(!t.node.comments)return;const n=t.node,o=t.study,r=o.currentChapter(),s=n.comments;return s.length?m("div",s.map((s=>{const i=s.by,a=zn(i)&&i.id===t.opts.userId;var c;if(e||!a)return m("div.study__comment."+s.id,[o.members.canContribute()&&o.vm.mode.write?m("a.edit",{attrs:{"data-icon":"",title:"Delete"},hook:P("click",(e=>{confirm("Delete "+jn(i)+"'s comment?")&&o.commentForm.delete(r.id,t.path,s.id)}),t.redraw)}):null,(c=i,c?"string"==typeof c?c:m("span.user-link.ulpt",{attrs:{"data-href":"/@/"+c.id}},c.name):"Unknown"),...n.san?[" on ",m("span.node",Te(n))]:[],": ",m("div.text",{hook:ht(s.text)})])}))):void 0}function Vn(t,e){return m("div.study__comments",[Gn(t,!0),m("div.study__message",e)])}function Hn(t,e){return function(n){return m("button",{hook:P("click",(e=>t.toggleGlyph(n.id)),t.redraw),attrs:{"data-symbol":n.symbol,type:"button"},class:{active:!!e.glyphs&&!!e.glyphs.find((t=>t.id===n.id))}},[n.name])}}function Un(t){const e=q(null);const n=Oe(500,(e=>{t.study.makeChange("toggleGlyph",t.study.withPosition({id:e}))}));return{root:t,all:e,loadGlyphs:function(){e()||z(`/study/glyphs/${document.documentElement.lang}.json`,{cache:"default"}).then((n=>{e(n),t.redraw()}))},toggleGlyph:n,redraw:t.redraw}}function Wn(t){return m("div.study__glyphs",[m("div.study__message",t)])}function Kn(t){return[m("label.form-label",{attrs:{for:"study-"+t.key}},t.name),m(`select#study-${t.key}.form-control`,t.choices.map((function(e){return m("option",{attrs:{value:e[0],selected:t.selected===e[0]}},e[1])})))]}const Jn=t=>m("div.study__topics",[...t.topics.getTopics().map((t=>m("a.topic",{attrs:{href:`/study/topic/${encodeURIComponent(t)}/hot`}},t))),t.members.canContribute()?m("a.manage",{hook:P("click",(()=>t.topics.open(!0)),t.redraw)},t.trans.noarg("manageTopics")):null]);let Yn;const Xn=(t,e)=>ge({class:"study-topics",onClose(){t.open(!1),t.redraw()},content:[m("h2",t.trans.noarg("topics")),m("form",{hook:E((e=>{const n=null==Yn?void 0:Yn.value;n&&t.save(n.map((t=>t.value)))}),t.redraw)},[m("textarea",{hook:M((t=>function(t,e){lichess.loadCssPath("tagify"),lichess.loadScript("vendor/tagify/tagify.min.js").then((()=>{const n=Yn=new window.Tagify(t,{pattern:/.{2,}/,maxTags:30});let o;n.on("input",(t=>{const r=t.detail.value.trim();r.length<2||(n.settings.whitelist.length=0,o&&o.abort(),o=new AbortController,n.loading(!0).dropdown.hide.call(n),z(U("/study/topic/autocomplete",{term:r,user:e}),{signal:o.signal}).then((t=>{n.settings.whitelist.splice(0,t.length,...t),n.loading(!1).dropdown.show.call(n,r)})))})),$(".tagify__input").each((function(){this.focus()}))}))}(t,e)))},t.getTopics().join(", ").replace(/[<>]/g,"")),m("button.button",{type:"submit"},t.trans.noarg("save"))])]});function Qn(t){const e=t.get();return e?m("div.notif."+e.class,e.text):void 0}const Zn=t=>{switch(t){case"standard":case"chess960":case"fromPosition":return"chess";case"threeCheck":return"3check";case"kingOfTheHill":return"kingofthehill";case"racingKings":return"racingkings";default:return t}};class to{constructor(){this.expectedPvs=1,this.options=new Map}connected(t){this.send=t,this.options=new Map([["Threads","1"],["Hash","16"],["MultiPV","1"],["UCI_Variant","chess"]]),this.send("uci")}setOption(t,e){e=e.toString(),this.send&&this.options.get(t)!==e&&(this.send(`setoption name ${t} value ${e}`),this.options.set(t,e))}disconnected(){this.work&&this.currentEval&&this.work.emit(this.currentEval),this.work=void 0,this.send=void 0}received(t){var e,n;const o=t.trim().split(/\s+/g);if("uciok"===o[0])this.setOption("UCI_AnalyseMode","true"),this.setOption("Analysis Contempt","Off"),this.setOption("UCI_Chess960","true"),null===(e=this.send)||void 0===e||e.call(this,"ucinewgame"),null===(n=this.send)||void 0===n||n.call(this,"isready");else if("readyok"===o[0])this.swapWork();else if("id"===o[0]&&"name"===o[1])this.engineName=o.slice(2).join(" ");else{if("bestmove"===o[0])return this.work&&this.currentEval&&this.work.emit(this.currentEval),this.work=void 0,void this.swapWork();if(this.work&&!this.work.stopRequested&&"info"===o[0]){let t,e,n,r,s=0,i=1,a=!1,c=[];for(let u=1;u<o.length;u++)switch(o[u]){case"depth":s=parseInt(o[++u]);break;case"nodes":t=parseInt(o[++u]);break;case"multipv":i=parseInt(o[++u]);break;case"time":e=parseInt(o[++u]);break;case"score":a="mate"===o[++u],r=parseInt(o[++u]),"lowerbound"!==o[u+1]&&"upperbound"!==o[u+1]||(n=o[++u]);break;case"pv":c=o.slice(++u),u=o.length}if(a&&!r)return;if(this.expectedPvs<i&&(this.expectedPvs=i),s<6||!_(t)||!_(e)||!_(a)||!_(r))return;const l=this.work.threatMode?0:1,d=this.work.ply%2===l?-r:r;if(n&&1===i)return;const h={moves:c,cp:a?void 0:d,mate:a?d:void 0,depth:s};1===i?this.currentEval={fen:this.work.currentFen,maxDepth:this.work.maxDepth,depth:s,knps:t/e,nodes:t,cp:a?void 0:d,mate:a?d:void 0,pvs:[h],millis:e}:this.currentEval&&(this.currentEval.pvs.push(h),this.currentEval.depth=Math.min(this.currentEval.depth,s)),i===this.expectedPvs&&this.currentEval&&(this.work.emit(this.currentEval),s>=this.work.maxDepth&&e>8e3&&t>4e3*Math.exp(.3*this.work.maxDepth)&&this.stop())}}}stop(){var t;this.work&&!this.work.stopRequested&&(this.work.stopRequested=!0,null===(t=this.send)||void 0===t||t.call(this,"stop"))}swapWork(){this.send&&!this.work&&(this.work=this.nextWork,this.nextWork=void 0,this.work&&(this.currentEval=void 0,this.expectedPvs=1,this.setOption("UCI_Variant","antichess"===this.work.variant?"giveaway":Zn(this.work.variant)),this.setOption("Threads",this.work.threads),this.setOption("Hash",this.work.hashSize||16),this.setOption("MultiPV",this.work.multiPv),this.send(["position fen",this.work.initialFen,"moves",...this.work.moves].join(" ")),this.send(this.work.maxDepth>=99?"go depth 245":"go movetime 90000")))}compute(t){this.nextWork=t,this.stop(),this.swapWork()}isComputing(){return!!this.work&&!this.work.stopRequested}}class eo{constructor(t){this.opts=t}start(t){this.booted||(this.boot(),this.booted=!0),this.getProtocol().compute(t)}stop(){this.getProtocol().compute(void 0)}isComputing(){return this.getProtocol().isComputing()}engineName(){return this.getProtocol().engineName}}class no extends eo{constructor(){super(...arguments),this.protocol=new to}getProtocol(){return this.protocol}boot(){this.worker=new Worker(lichess.assetUrl(this.opts.url,{sameDomain:!0})),this.worker.addEventListener("message",(t=>this.protocol.received(t.data)),!0),this.protocol.connected((t=>{var e;return null===(e=this.worker)||void 0===e?void 0:e.postMessage(t)}))}destroy(){var t;null===(t=this.worker)||void 0===t||t.terminate()}}class oo extends eo{getProtocol(){return oo.protocols[this.opts.module]}async boot(){if(!oo.sf[this.opts.module]){const t=this.opts.version,e=this.opts.cache;let n;if(e){const o=this.opts.baseUrl+"stockfish.wasm";if(e)try{const[r,s]=await e.get(o,t);r&&(n=s)}catch(Be){console.log("ceval: idb cache load failed:",Be)}n||(n=await new Promise(((e,n)=>{const r=new XMLHttpRequest;r.open("GET",lichess.assetUrl(o,{version:t}),!0),r.responseType="arraybuffer",r.onerror=t=>n(t),r.onprogress=t=>{var e,n;return null===(n=(e=this.opts).downloadProgress)||void 0===n?void 0:n.call(e,t.loaded)},r.onload=t=>{var n,o;null===(o=(n=this.opts).downloadProgress)||void 0===o||o.call(n,0),e(r.response)},r.send()})));try{await e.set(o,t,n)}catch(Be){console.log("ceval: idb cache store failed:",Be)}}await lichess.loadScript(this.opts.baseUrl+"stockfish.js",{version:t});const o=await window[this.opts.module]({wasmBinary:n,locateFile:e=>lichess.assetUrl(this.opts.baseUrl+e,{version:t,sameDomain:e.endsWith(".worker.js")}),wasmMemory:this.opts.wasmMemory}),r=this.getProtocol();o.addMessageListener(r.received.bind(r)),r.connected((t=>o.postMessage(t))),oo.sf[this.opts.module]=o}}destroy(){this.getProtocol().compute(void 0)}}oo.protocols={Stockfish:new to,StockfishMv:new to},oo.sf={};class ro extends eo{constructor(){super(...arguments),this.protocol=new to,this.session=Math.random().toString(36).slice(2,12)}getProtocol(){return this.protocol}boot(){const t=new URL(this.opts.url);t.searchParams.set("secret",this.opts.secret),t.searchParams.set("session",this.session);const e=this.ws=new WebSocket(t.href);e.onmessage=t=>this.protocol.received(t.data),e.onopen=()=>this.protocol.connected((t=>e.send(t))),e.onclose=()=>{this.protocol.disconnected(),this.ws&&setTimeout((()=>this.boot()),1e4)}}destroy(){const t=this.ws;this.ws=void 0,t&&t.readyState<=1&&t.close()}}function so(t){return 2/(1+Math.exp(-.004*t))-1}function io(t){return void 0!==t.mate?(n=t.mate,so(100*(21-Math.min(10,Math.abs(n)))*(n>0?1:-1))):(e=t.cp,so(Math.min(Math.max(-1e3,e),1e3)));var e,n}function ao(t,e){return function(t,e){return"white"===t?e:-e}(t,io(e))}function co(t,e,n){return(ao(t,e)-ao(t,n))/2}function lo(t,e){return t.depth>e.depth||t.depth===e.depth&&t.nodes>e.nodes}function ho(t){return((t=Math.max(Math.min(Math.round(t/10)/10,99),-99))>0?"+":"")+t.toFixed(1)}function uo(t,e){return!!e.startsWith("O-O")||"crazyhouse"!==t&&(!!e.includes("x")||(e.toLowerCase()===e||"threeCheck"===t&&e.includes("+")))}function po(t){return new Promise(((e,n)=>{t.oncomplete=t.onsuccess=()=>e(t.result),t.onabort=t.onerror=()=>n(t.error)}))}function mo(t,e){const n=(!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise((function(t){var e=function(){return indexedDB.databases().finally(t)};o=setInterval(e,100),e()})).finally((function(){return clearInterval(o)})):Promise.resolve()).then((()=>{const n=indexedDB.open(t);return n.onupgradeneeded=()=>n.result.createObjectStore(e),po(n)}));var o;return(t,o)=>n.then((n=>o(n.transaction(e,t).objectStore(e))))}let fo;function go(){return fo||(fo=mo("keyval-store","keyval")),fo}function vo(t,e=go()){return e("readonly",(e=>po(e.get(t))))}function bo(t,e,n=go()){return n("readwrite",(n=>(n.put(e,t),po(n.transaction))))}class yo{constructor(t){this.store=mo(`${t}--db`,`${t}--store`)}async get(t,e){if(await vo(`${t}--version`,this.store)!==e)return[!1,void 0];return[!0,await vo(`${t}--data`,this.store)]}async set(t,e,n){await vo(`${t}--version`,this.store)!==e&&(await function(t,e=go()){return e("readwrite",(e=>(e.delete(t),po(e.transaction))))}(`${t}--version`,this.store),await bo(`${t}--data`,n,this.store),await bo(`${t}--version`,e,this.store))}}const wo=(t,e)=>{let n=Xe.empty();for(const o of e){const e=t+o;0<=e&&e<64&&Math.abs(sn(t)-sn(e))<=2&&(n=n.with(e))}return n},ko=t=>{const e=[];for(let n=0;n<64;n++)e[n]=t(n);return e},Co=ko((t=>wo(t,[-9,-8,-7,-1,1,7,8,9]))),xo=ko((t=>wo(t,[-17,-15,-10,-6,6,10,15,17]))),Mo={white:ko((t=>wo(t,[7,9]))),black:ko((t=>wo(t,[-7,-9])))},Po=t=>Co[t],So=t=>xo[t],Eo=(t,e)=>Mo[t][e],Ao=ko((t=>Xe.fromFile(sn(t)).without(t))),To=ko((t=>Xe.fromRank(rn(t)).without(t))),Io=ko((t=>{const e=new Xe(134480385,2151686160),n=8*(rn(t)-sn(t));return(n>=0?e.shl64(n):e.shr64(-n)).without(t)})),$o=ko((t=>{const e=new Xe(270549120,16909320),n=8*(rn(t)+sn(t)-7);return(n>=0?e.shl64(n):e.shr64(-n)).without(t)})),_o=(t,e,n)=>{let o=n.intersect(e),r=o.bswap64();return o=o.minus64(t),r=r.minus64(t.bswap64()),o.xor(r.bswap64()).intersect(e)},No=(t,e)=>{const n=Xe.fromSquare(t);return _o(n,Io[t],e).xor(_o(n,$o[t],e))},Do=(t,e)=>((t,e)=>_o(Xe.fromSquare(t),Ao[t],e))(t,e).xor(((t,e)=>{const n=To[t];let o=e.intersect(n),r=o.rbit64();return o=o.minus64(Xe.fromSquare(t)),r=r.minus64(Xe.fromSquare(63-t)),o.xor(r.rbit64()).intersect(n)})(t,e)),Oo=(t,e)=>No(t,e).xor(Do(t,e)),qo=(t,e)=>{const n=Xe.fromSquare(e);return To[t].intersects(n)?To[t].with(t):$o[t].intersects(n)?$o[t].with(t):Io[t].intersects(n)?Io[t].with(t):Ao[t].intersects(n)?Ao[t].with(t):Xe.empty()},Lo=(t,e)=>qo(t,e).intersect(Xe.full().shl64(t).xor(Xe.full().shl64(e))).withoutFirst();var Ro;!function(t){t.Empty="ERR_EMPTY",t.OppositeCheck="ERR_OPPOSITE_CHECK",t.ImpossibleCheck="ERR_IMPOSSIBLE_CHECK",t.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",t.Kings="ERR_KINGS",t.Variant="ERR_VARIANT"}(Ro||(Ro={}));class Fo extends Error{}const Bo=(t,e)=>"white"===t?"a"===e?3:5:"a"===e?59:61;class zo{constructor(){}static default(){const t=new zo;return t.unmovedRooks=Xe.corners(),t.rook={white:{a:0,h:7},black:{a:56,h:63}},t.path={white:{a:new Xe(14,0),h:new Xe(96,0)},black:{a:new Xe(0,234881024),h:new Xe(0,1610612736)}},t}static empty(){const t=new zo;return t.unmovedRooks=Xe.empty(),t.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},t.path={white:{a:Xe.empty(),h:Xe.empty()},black:{a:Xe.empty(),h:Xe.empty()}},t}clone(){const t=new zo;return t.unmovedRooks=this.unmovedRooks,t.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},t.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},t}add(t,e,n,o){const r=un(t,e),s=Bo(t,e);this.unmovedRooks=this.unmovedRooks.with(o),this.rook[t][e]=o,this.path[t][e]=Lo(o,s).with(s).union(Lo(n,r).with(r)).without(n).without(o)}static fromSetup(t){const e=zo.empty(),n=t.unmovedRooks.intersect(t.board.rook);for(const o of Ve){const r=Xe.backrank(o),s=t.board.kingOf(o);if(!nn(s)||!r.has(s))continue;const i=n.intersect(t.board[o]).intersect(r),a=i.first();nn(a)&&a<s&&e.add(o,"a",s,a);const c=i.last();nn(c)&&s<c&&e.add(o,"h",s,c)}return e}discardRook(t){if(this.unmovedRooks.has(t)){this.unmovedRooks=this.unmovedRooks.without(t);for(const e of Ve)for(const n of Ue)this.rook[e][n]===t&&(this.rook[e][n]=void 0)}}discardColor(t){this.unmovedRooks=this.unmovedRooks.diff(Xe.backrank(t)),this.rook[t].a=void 0,this.rook[t].h=void 0}}class jo{constructor(t){this.rules=t}reset(){this.board=Qe.default(),this.pockets=void 0,this.turn="white",this.castles=zo.default(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(t){this.board=t.board.clone(),this.board.promoted=Xe.empty(),this.pockets=void 0,this.turn=t.turn,this.castles=zo.fromSetup(t),this.epSquare=Vo(this,t.epSquare),this.remainingChecks=void 0,this.halfmoves=t.halfmoves,this.fullmoves=t.fullmoves}kingAttackers(t,e,n){return((t,e,n,o)=>n[e].intersect(Do(t,o).intersect(n.rooksAndQueens()).union(No(t,o).intersect(n.bishopsAndQueens())).union(So(t).intersect(n.knight)).union(Po(t).intersect(n.king)).union(Eo(on(e),t).intersect(n.pawn))))(t,e,this.board,n)}playCaptureAt(t,e){this.halfmoves=0,"rook"===e.role&&this.castles.discardRook(t),this.pockets&&this.pockets[on(e.color)][e.promoted?"pawn":e.role]++}ctx(){const t=this.isVariantEnd(),e=this.board.kingOf(this.turn);if(!nn(e))return{king:e,blockers:Xe.empty(),checkers:Xe.empty(),variantEnd:t,mustCapture:!1};const n=Do(e,Xe.empty()).intersect(this.board.rooksAndQueens()).union(No(e,Xe.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[on(this.turn)]);let o=Xe.empty();for(const r of n){const t=Lo(e,r).intersect(this.board.occupied);t.moreThanOne()||(o=o.union(t))}return{king:e,blockers:o,checkers:this.kingAttackers(e,on(this.turn),this.board.occupied),variantEnd:t,mustCapture:!1}}clone(){var t,e;const n=new this.constructor;return n.board=this.board.clone(),n.pockets=null===(t=this.pockets)||void 0===t?void 0:t.clone(),n.turn=this.turn,n.castles=this.castles.clone(),n.epSquare=this.epSquare,n.remainingChecks=null===(e=this.remainingChecks)||void 0===e?void 0:e.clone(),n.halfmoves=this.halfmoves,n.fullmoves=this.fullmoves,n}validate(t){if(this.board.occupied.isEmpty())return ze.err(new Fo(Ro.Empty));if(2!==this.board.king.size())return ze.err(new Fo(Ro.Kings));if(!nn(this.board.kingOf(this.turn)))return ze.err(new Fo(Ro.Kings));const e=this.board.kingOf(on(this.turn));return nn(e)?this.kingAttackers(e,this.turn,this.board.occupied).nonEmpty()?ze.err(new Fo(Ro.OppositeCheck)):Xe.backranks().intersects(this.board.pawn)?ze.err(new Fo(Ro.PawnsOnBackrank)):(null==t?void 0:t.ignoreImpossibleCheck)?ze.ok(void 0):this.validateCheckers():ze.err(new Fo(Ro.Kings))}validateCheckers(){const t=this.board.kingOf(this.turn);if(nn(t)){const e=this.kingAttackers(t,on(this.turn),this.board.occupied);if(e.nonEmpty())if(nn(this.epSquare)){const n=8^this.epSquare,o=24^this.epSquare;if(e.moreThanOne()||e.first()!==n&&this.kingAttackers(t,on(this.turn),this.board.occupied.without(n).with(o)).nonEmpty())return ze.err(new Fo(Ro.ImpossibleCheck))}else if(e.size()>2||2===e.size()&&qo(e.first(),e.last()).has(t))return ze.err(new Fo(Ro.ImpossibleCheck))}return ze.ok(void 0)}dropDests(t){return Xe.empty()}dests(t,e){if((e=e||this.ctx()).variantEnd)return Xe.empty();const n=this.board.get(t);if(!n||n.color!==this.turn)return Xe.empty();let o,r;if("pawn"===n.role){o=Eo(this.turn,t).intersect(this.board[on(this.turn)]);const n="white"===this.turn?8:-8,s=t+n;if(0<=s&&s<64&&!this.board.occupied.has(s)){o=o.with(s);const e=s+n;("white"===this.turn?t<16:t>=48)&&!this.board.occupied.has(e)&&(o=o.with(e))}if(nn(this.epSquare)&&Uo(this,t,e)){const t=this.epSquare-n;(e.checkers.isEmpty()||e.checkers.singleSquare()===t)&&(r=Xe.fromSquare(this.epSquare))}}else o="bishop"===n.role?No(t,this.board.occupied):"knight"===n.role?So(t):"rook"===n.role?Do(t,this.board.occupied):"queen"===n.role?Oo(t,this.board.occupied):Po(t);if(o=o.diff(this.board[this.turn]),nn(e.king)){if("king"===n.role){const n=this.board.occupied.without(t);for(const t of o)this.kingAttackers(t,on(this.turn),n).nonEmpty()&&(o=o.without(t));return o.union(Wo(this,"a",e)).union(Wo(this,"h",e))}if(e.checkers.nonEmpty()){const t=e.checkers.singleSquare();if(!nn(t))return Xe.empty();o=o.intersect(Lo(t,e.king).with(t))}e.blockers.has(t)&&(o=o.intersect(qo(t,e.king)))}return r&&(o=o.union(r)),o}isVariantEnd(){return!1}variantOutcome(t){}hasInsufficientMaterial(t){if(this.board[t].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty())return!1;if(this.board[t].intersects(this.board.knight))return this.board[t].size()<=2&&this.board[on(t)].diff(this.board.king).diff(this.board.queen).isEmpty();if(this.board[t].intersects(this.board.bishop)){return(!this.board.bishop.intersects(Xe.darkSquares())||!this.board.bishop.intersects(Xe.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty()}return!0}toSetup(){var t,e;return{board:this.board.clone(),pockets:null===(t=this.pockets)||void 0===t?void 0:t.clone(),turn:this.turn,unmovedRooks:this.castles.unmovedRooks,epSquare:Ho(this),remainingChecks:null===(e=this.remainingChecks)||void 0===e?void 0:e.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return Ve.every((t=>this.hasInsufficientMaterial(t)))}hasDests(t){t=t||this.ctx();for(const e of this.board[this.turn])if(this.dests(e,t).nonEmpty())return!0;return this.dropDests(t).nonEmpty()}isLegal(t,e){if(We(t))return!(!this.pockets||this.pockets[this.turn][t.role]<=0)&&(("pawn"!==t.role||!Xe.backranks().has(t.to))&&this.dropDests(e).has(t.to));{if("pawn"===t.promotion)return!1;if("king"===t.promotion&&"antichess"!==this.rules)return!1;if(!!t.promotion!==(this.board.pawn.has(t.from)&&Xe.backranks().has(t.to)))return!1;const n=this.dests(t.from,e);return n.has(t.to)||n.has(Yo(this,t).to)}}isCheck(){const t=this.board.kingOf(this.turn);return nn(t)&&this.kingAttackers(t,on(this.turn),this.board.occupied).nonEmpty()}isEnd(t){return!!(t?t.variantEnd:this.isVariantEnd())||(this.isInsufficientMaterial()||!this.hasDests(t))}isCheckmate(t){return!(t=t||this.ctx()).variantEnd&&t.checkers.nonEmpty()&&!this.hasDests(t)}isStalemate(t){return!(t=t||this.ctx()).variantEnd&&t.checkers.isEmpty()&&!this.hasDests(t)}outcome(t){const e=this.variantOutcome(t);return e||(t=t||this.ctx(),this.isCheckmate(t)?{winner:on(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(t)?{winner:void 0}:void 0)}allDests(t){t=t||this.ctx();const e=new Map;if(t.variantEnd)return e;for(const n of this.board[this.turn])e.set(n,this.dests(n,t));return e}play(t){const e=this.turn,n=this.epSquare,o=Jo(this,t);if(this.epSquare=void 0,this.halfmoves+=1,"black"===e&&(this.fullmoves+=1),this.turn=on(e),We(t))this.board.set(t.to,{role:t.role,color:e}),this.pockets&&this.pockets[e][t.role]--,"pawn"===t.role&&(this.halfmoves=0);else{const r=this.board.take(t.from);if(!r)return;let s;if("pawn"===r.role){this.halfmoves=0,t.to===n&&(s=this.board.take(t.to+("white"===e?-8:8)));const o=t.from-t.to;16===Math.abs(o)&&8<=t.from&&t.from<=55&&(this.epSquare=t.from+t.to>>1),t.promotion&&(r.role=t.promotion,r.promoted=!!this.pockets)}else if("rook"===r.role)this.castles.discardRook(t.from);else if("king"===r.role){if(o){const t=this.castles.rook[e][o];if(nn(t)){const n=this.board.take(t);this.board.set(un(e,o),r),n&&this.board.set(Bo(e,o),n)}}this.castles.discardColor(e)}if(!o){const e=this.board.set(t.to,r)||s;e&&this.playCaptureAt(t.to,e)}}this.remainingChecks&&this.isCheck()&&(this.remainingChecks[e]=Math.max(this.remainingChecks[e]-1,0))}}class Go extends jo{constructor(){super("chess")}static default(){const t=new this;return t.reset(),t}static fromSetup(t,e){const n=new this;return n.setupUnchecked(t),n.validate(e).map((t=>n))}clone(){return super.clone()}}const Vo=(t,e)=>{if(!nn(e))return;const n="white"===t.turn?5:2,o="white"===t.turn?8:-8;if(rn(e)!==n)return;if(t.board.occupied.has(e+o))return;const r=e-o;return t.board.pawn.has(r)&&t.board[on(t.turn)].has(r)?e:void 0},Ho=t=>{if(!nn(t.epSquare))return;const e=t.ctx(),n=t.board.pieces(t.turn,"pawn").intersect(Eo(on(t.turn),t.epSquare));for(const o of n)if(t.dests(o,e).has(t.epSquare))return t.epSquare},Uo=(t,e,n)=>{if(!nn(t.epSquare))return!1;if(!Eo(t.turn,e).has(t.epSquare))return!1;if(!nn(n.king))return!0;const o=t.epSquare+("white"===t.turn?-8:8),r=t.board.occupied.toggle(e).toggle(t.epSquare).toggle(o);return!t.kingAttackers(n.king,on(t.turn),r).intersects(r)},Wo=(t,e,n)=>{if(!nn(n.king)||n.checkers.nonEmpty())return Xe.empty();const o=t.castles.rook[t.turn][e];if(!nn(o))return Xe.empty();if(t.castles.path[t.turn][e].intersects(t.board.occupied))return Xe.empty();const r=un(t.turn,e),s=Lo(n.king,r),i=t.board.occupied.without(n.king);for(const l of s)if(t.kingAttackers(l,on(t.turn),i).nonEmpty())return Xe.empty();const a=Bo(t.turn,e),c=t.board.occupied.toggle(n.king).toggle(o).toggle(a);return t.kingAttackers(r,on(t.turn),c).nonEmpty()?Xe.empty():Xe.fromSquare(o)},Ko=(t,e,n)=>{if(n.variantEnd)return Xe.empty();const o=t.board.get(e);if(!o||o.color!==t.turn)return Xe.empty();let r=((t,e,n)=>{switch(t.role){case"pawn":return Eo(t.color,e);case"knight":return So(e);case"bishop":return No(e,n);case"rook":return Do(e,n);case"queen":return Oo(e,n);case"king":return Po(e)}})(o,e,t.board.occupied);if("pawn"===o.role){let n=t.board[on(t.turn)];nn(t.epSquare)&&(n=n.with(t.epSquare)),r=r.intersect(n);const o="white"===t.turn?8:-8,s=e+o;if(0<=s&&s<64&&!t.board.occupied.has(s)){r=r.with(s);const n=s+o;("white"===t.turn?e<16:e>=48)&&!t.board.occupied.has(n)&&(r=r.with(n))}return r}return r=r.diff(t.board[t.turn]),e===n.king?r.union(Wo(t,"a",n)).union(Wo(t,"h",n)):r},Jo=(t,e)=>{if(We(e))return;const n=e.to-e.from;return(2===Math.abs(n)||t.board[t.turn].has(e.to))&&t.board.king.has(e.from)?n>0?"h":"a":void 0},Yo=(t,e)=>{const n=Jo(t,e);if(!n)return e;const o=t.castles.rook[t.turn][n];return{from:e.from,to:nn(o)?o:e.to}},Xo=t=>Ve.every((e=>((t,e)=>{const n=Math.max(t.pieces(e,"queen").size()-1,0)+Math.max(t.pieces(e,"rook").size()-2,0)+Math.max(t.pieces(e,"knight").size()-2,0)+Math.max(t.pieces(e,"bishop").intersect(Xe.lightSquares()).size()-1,0)+Math.max(t.pieces(e,"bishop").intersect(Xe.darkSquares()).size()-1,0);return t.pieces(e,"pawn").size()+n<=8})(t.board,e)));class Qo extends jo{constructor(){super("crazyhouse")}reset(){super.reset(),this.pockets=tn.empty()}setupUnchecked(t){super.setupUnchecked(t),this.board.promoted=t.board.promoted.intersect(t.board.occupied).diff(t.board.king).diff(t.board.pawn),this.pockets=t.pockets?t.pockets.clone():tn.empty()}static default(){const t=new this;return t.reset(),t}static fromSetup(t,e){const n=new this;return n.setupUnchecked(t),n.validate(e).map((t=>n))}clone(){return super.clone()}validate(t){return super.validate(t).chain((t=>{var e,n;return(null===(e=this.pockets)||void 0===e?void 0:e.count("king"))?ze.err(new Fo(Ro.Kings)):((null===(n=this.pockets)||void 0===n?void 0:n.size())||0)+this.board.occupied.size()>64?ze.err(new Fo(Ro.Variant)):ze.ok(void 0)}))}hasInsufficientMaterial(t){return this.pockets?this.board.occupied.size()+this.pockets.size()<=3&&this.board.pawn.isEmpty()&&this.board.promoted.isEmpty()&&this.board.rooksAndQueens().isEmpty()&&this.pockets.count("pawn")<=0&&this.pockets.count("rook")<=0&&this.pockets.count("queen")<=0:super.hasInsufficientMaterial(t)}dropDests(t){var e,n;const o=this.board.occupied.complement().intersect((null===(e=this.pockets)||void 0===e?void 0:e[this.turn].hasNonPawns())?Xe.full():(null===(n=this.pockets)||void 0===n?void 0:n[this.turn].hasPawns())?Xe.backranks().complement():Xe.empty());if(t=t||this.ctx(),nn(t.king)&&t.checkers.nonEmpty()){const e=t.checkers.singleSquare();return nn(e)?o.intersect(Lo(e,t.king)):Xe.empty()}return o}}class Zo extends jo{constructor(){super("atomic")}static default(){const t=new this;return t.reset(),t}static fromSetup(t,e){const n=new this;return n.setupUnchecked(t),n.validate(e).map((t=>n))}clone(){return super.clone()}validate(t){if(this.board.occupied.isEmpty())return ze.err(new Fo(Ro.Empty));if(this.board.king.size()>2)return ze.err(new Fo(Ro.Kings));const e=this.board.kingOf(on(this.turn));return nn(e)?this.kingAttackers(e,this.turn,this.board.occupied).nonEmpty()?ze.err(new Fo(Ro.OppositeCheck)):Xe.backranks().intersects(this.board.pawn)?ze.err(new Fo(Ro.PawnsOnBackrank)):(null==t?void 0:t.ignoreImpossibleCheck)?ze.ok(void 0):this.validateCheckers():ze.err(new Fo(Ro.Kings))}validateCheckers(){return nn(this.epSquare)?ze.ok(void 0):super.validateCheckers()}kingAttackers(t,e,n){const o=this.board.pieces(e,"king");return o.isEmpty()||Po(t).intersects(o)?Xe.empty():super.kingAttackers(t,e,n)}playCaptureAt(t,e){super.playCaptureAt(t,e),this.board.take(t);for(const n of Po(t).intersect(this.board.occupied).diff(this.board.pawn)){const t=this.board.take(n);"rook"===(null==t?void 0:t.role)&&this.castles.discardRook(n),"king"===(null==t?void 0:t.role)&&this.castles.discardColor(t.color)}}hasInsufficientMaterial(t){if(this.board.pieces(on(t),"king").isEmpty())return!1;if(this.board[t].diff(this.board.king).isEmpty())return!0;if(this.board[on(t)].diff(this.board.king).nonEmpty()){if(this.board.occupied.equals(this.board.bishop.union(this.board.king))){if(!this.board.bishop.intersect(this.board.white).intersects(Xe.darkSquares()))return!this.board.bishop.intersect(this.board.black).intersects(Xe.lightSquares());if(!this.board.bishop.intersect(this.board.white).intersects(Xe.lightSquares()))return!this.board.bishop.intersect(this.board.black).intersects(Xe.darkSquares())}return!1}return!this.board.queen.nonEmpty()&&!this.board.pawn.nonEmpty()&&(1===this.board.knight.union(this.board.bishop).union(this.board.rook).size()||!!this.board.occupied.equals(this.board.knight.union(this.board.king))&&this.board.knight.size()<=2)}dests(t,e){e=e||this.ctx();let n=Xe.empty();for(const o of Ko(this,t,e)){const e=this.clone();e.play({from:t,to:o});const r=e.board.kingOf(this.turn);!nn(r)||nn(e.board.kingOf(e.turn))&&!e.kingAttackers(r,e.turn,e.board.occupied).isEmpty()||(n=n.with(o))}return n}isVariantEnd(){return!!this.variantOutcome()}variantOutcome(t){for(const e of Ve)if(this.board.pieces(e,"king").isEmpty())return{winner:on(e)}}}class tr extends jo{constructor(){super("antichess")}reset(){super.reset(),this.castles=zo.empty()}setupUnchecked(t){super.setupUnchecked(t),this.castles=zo.empty()}static default(){const t=new this;return t.reset(),t}static fromSetup(t,e){const n=new this;return n.setupUnchecked(t),n.validate(e).map((t=>n))}clone(){return super.clone()}validate(t){return this.board.occupied.isEmpty()?ze.err(new Fo(Ro.Empty)):Xe.backranks().intersects(this.board.pawn)?ze.err(new Fo(Ro.PawnsOnBackrank)):ze.ok(void 0)}kingAttackers(t,e,n){return Xe.empty()}ctx(){const t=super.ctx();if(nn(this.epSquare)&&Eo(on(this.turn),this.epSquare).intersects(this.board.pieces(this.turn,"pawn")))return t.mustCapture=!0,t;const e=this.board[on(this.turn)];for(const n of this.board[this.turn])if(Ko(this,n,t).intersects(e))return t.mustCapture=!0,t;return t}dests(t,e){e=e||this.ctx();const n=Ko(this,t,e),o=this.board[on(this.turn)];return n.intersect(e.mustCapture?nn(this.epSquare)&&"pawn"===this.board.getRole(t)?o.with(this.epSquare):o:Xe.full())}hasInsufficientMaterial(t){if(this.board.occupied.equals(this.board.bishop)){const e=this.board[t].intersects(Xe.lightSquares()),n=this.board[t].intersects(Xe.darkSquares()),o=this.board[on(t)].isDisjoint(Xe.lightSquares()),r=this.board[on(t)].isDisjoint(Xe.darkSquares());return e&&o||n&&r}return!1}isVariantEnd(){return this.board[this.turn].isEmpty()}variantOutcome(t){if((t=t||this.ctx()).variantEnd||this.isStalemate(t))return{winner:this.turn}}}class er extends jo{constructor(){super("kingofthehill")}static default(){const t=new this;return t.reset(),t}static fromSetup(t,e){const n=new this;return n.setupUnchecked(t),n.validate(e).map((t=>n))}clone(){return super.clone()}hasInsufficientMaterial(t){return!1}isVariantEnd(){return this.board.king.intersects(Xe.center())}variantOutcome(t){for(const e of Ve)if(this.board.pieces(e,"king").intersects(Xe.center()))return{winner:e}}}class nr extends jo{constructor(){super("3check")}reset(){super.reset(),this.remainingChecks=en.default()}setupUnchecked(t){var e;super.setupUnchecked(t),this.remainingChecks=(null===(e=t.remainingChecks)||void 0===e?void 0:e.clone())||en.default()}static default(){const t=new this;return t.reset(),t}static fromSetup(t,e){const n=new this;return n.setupUnchecked(t),n.validate(e).map((t=>n))}clone(){return super.clone()}hasInsufficientMaterial(t){return this.board.pieces(t,"king").equals(this.board[t])}isVariantEnd(){return!!this.remainingChecks&&(this.remainingChecks.white<=0||this.remainingChecks.black<=0)}variantOutcome(t){if(this.remainingChecks)for(const e of Ve)if(this.remainingChecks[e]<=0)return{winner:e}}}class or extends jo{constructor(){super("racingkings")}reset(){this.board=(()=>{const t=Qe.empty();return t.occupied=new Xe(65535,0),t.promoted=Xe.empty(),t.white=new Xe(61680,0),t.black=new Xe(3855,0),t.pawn=Xe.empty(),t.knight=new Xe(6168,0),t.bishop=new Xe(9252,0),t.rook=new Xe(16962,0),t.queen=new Xe(129,0),t.king=new Xe(33024,0),t})(),this.pockets=void 0,this.turn="white",this.castles=zo.empty(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(t){super.setupUnchecked(t),this.castles=zo.empty()}static default(){const t=new this;return t.reset(),t}static fromSetup(t,e){const n=new this;return n.setupUnchecked(t),n.validate(e).map((t=>n))}clone(){return super.clone()}validate(t){return this.isCheck()||this.board.pawn.nonEmpty()?ze.err(new Fo(Ro.Variant)):super.validate(t)}dests(t,e){if(t===(e=e||this.ctx()).king)return super.dests(t,e);let n=Xe.empty();for(const o of super.dests(t,e)){const e={from:t,to:o},r=this.clone();r.play(e),r.isCheck()||(n=n.with(o))}return n}hasInsufficientMaterial(t){return!1}isVariantEnd(){const t=Xe.fromRank(7),e=this.board.king.intersect(t);if(e.isEmpty())return!1;if("white"===this.turn||e.intersects(this.board.black))return!0;const n=this.board.kingOf("black");if(nn(n)){const e=this.board.occupied.without(n);for(const o of Po(n).intersect(t).diff(this.board.black))if(this.kingAttackers(o,"white",e).isEmpty())return!1}return!0}variantOutcome(t){if(t?!t.variantEnd:!this.isVariantEnd())return;const e=Xe.fromRank(7),n=this.board.pieces("black","king").intersects(e),o=this.board.pieces("white","king").intersects(e);return n&&!o?{winner:"black"}:o&&!n?{winner:"white"}:{winner:void 0}}}class rr extends jo{constructor(){super("horde")}reset(){this.board=(()=>{const t=Qe.empty();return t.occupied=new Xe(4294967295,4294901862),t.promoted=Xe.empty(),t.white=new Xe(4294967295,102),t.black=new Xe(0,4294901760),t.pawn=new Xe(4294967295,16711782),t.knight=new Xe(0,1107296256),t.bishop=new Xe(0,603979776),t.rook=new Xe(0,2164260864),t.queen=new Xe(0,134217728),t.king=new Xe(0,268435456),t})(),this.pockets=void 0,this.turn="white",this.castles=zo.default(),this.castles.discardColor("white"),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}static default(){const t=new this;return t.reset(),t}static fromSetup(t,e){const n=new this;return n.setupUnchecked(t),n.validate(e).map((t=>n))}clone(){return super.clone()}validate(t){if(this.board.occupied.isEmpty())return ze.err(new Fo(Ro.Empty));if(1!==this.board.king.size())return ze.err(new Fo(Ro.Kings));const e=this.board.kingOf(on(this.turn));if(nn(e)&&this.kingAttackers(e,this.turn,this.board.occupied).nonEmpty())return ze.err(new Fo(Ro.OppositeCheck));for(const n of Ve){const t=this.board.pieces(n,"king").isEmpty()?Xe.backrank(on(n)):Xe.backranks();if(this.board.pieces(n,"pawn").intersects(t))return ze.err(new Fo(Ro.PawnsOnBackrank))}return(null==t?void 0:t.ignoreImpossibleCheck)?ze.ok(void 0):this.validateCheckers()}hasInsufficientMaterial(t){return!1}isVariantEnd(){return this.board.white.isEmpty()||this.board.black.isEmpty()}variantOutcome(t){return this.board.white.isEmpty()?{winner:"black"}:this.board.black.isEmpty()?{winner:"white"}:void 0}}const sr=(t,e,n)=>{switch(t){case"chess":return Go.fromSetup(e,n);case"antichess":return tr.fromSetup(e,n);case"atomic":return Zo.fromSetup(e,n);case"horde":return rr.fromSetup(e,n);case"racingkings":return or.fromSetup(e,n);case"kingofthehill":return er.fromSetup(e,n);case"3check":return nr.fromSetup(e,n);case"crazyhouse":return Qo.fromSetup(e,n)}};function ir(t,e){return new WebAssembly.Memory({shared:!0,initial:t,maximum:e})}function ar(t,e){switch(t){case"external":return e.name;case"wasm":case"asmjs":return"Stockfish 10+";case"hce":return"Stockfish 11+";case"nnue":return"Stockfish 14+"}}function cr(){return lichess.tempStorage.get("ceval.enabled-after")===(lichess.storage.get("ceval.disable")||"1")}function lr(t){var e,n;const o=e=>t.storageKeyPrefix?`${t.storageKeyPrefix}.${e}`:e,r=Mn("ceval.enable-nnue",!(null===(e=navigator.connection)||void 0===e?void 0:e.saveData)),s=Zn(t.variant.key),i=t.initialFen?wn(t.initialFen).chain((t=>sr(s,t))):ze.ok((t=>{switch(t){case"chess":return Go.default();case"antichess":return tr.default();case"atomic":return Zo.default();case"horde":return rr.default();case"racingkings":return or.default();case"kingofthehill":return er.default();case"3check":return nr.default();case"crazyhouse":return Qo.default()}})(s)),a=i.isOk,c="chess"==s&&(!a||Xo(i.value));let l="asmjs",d=!1,h=!1;const u=Uint8Array.from([0,97,115,109,1,0,0,0]);if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.validate&&WebAssembly.validate(u)){l="wasm";const t=function(t,e){if("object"!=typeof Atomics)return;if("function"!=typeof SharedArrayBuffer)return;const n=ir(t,e);if(n.buffer instanceof SharedArrayBuffer){try{window.postMessage(n,"*")}catch(Be){return}return n}}(8,16);if(t){l="hce";const e=Uint8Array.from([0,97,115,109,1,0,0,0,1,12,2,96,2,123,123,1,123,96,1,123,1,123,3,3,2,0,1,7,9,2,1,97,0,0,1,98,0,1,10,19,2,9,0,32,0,32,1,253,186,1,11,7,0,32,0,253,253,1,11]);h=WebAssembly.validate(e),h&&c&&r()&&(l="nnue");try{t.grow(8),d=!0}catch(Be){}}}const p=JSON.parse(lichess.storage.get("ceval.external")||"null");p&&(c||(null===(n=p.variants)||void 0===n?void 0:n.includes(s)))&&(l="external");const m=c?2:1,f="external"==l?p.maxThreads:"nnue"==l||"hce"==l?Math.min(Math.max((navigator.hardwareConcurrency||1)-1,1),d?32:m):1,g=()=>{const t=lichess.storage.get(o("ceval.threads"));return Math.min(f,t?parseInt(t,10):Math.ceil((navigator.hardwareConcurrency||1)/4))},v="hce"==l||"nnue"==l?2:.5,b="external"==l?p.maxHash||16:Math.min(1024*(navigator.deviceMemory||v)/8,d?1024:16),y=()=>{const t=lichess.storage.get(o("ceval.hash-size"));return Math.min(b,t?parseInt(t,10):16)},w=Mn(o("ceval.multipv"),t.multiPvDefault||1),k=Mn("ceval.infinite",!1);let C=null;const x=q(!0),M=q(t.possible&&a&&x()&&cr()),P=q(0);let S=!1,E=!1;const A=q(null),T=q(null),I=q(!1);let $,_=null;const N=Oe(200,((e,n)=>{L(e.pvs,n.ply%2==(n.threatMode?1:0)?"white":"black"),C=e,t.emit(e,n),e.fen!==_&&cr()&&(_=e.fen,lichess.storage.fire("ceval.fen",e.fen))})),D=()=>C?C.depth:0,O=()=>I()||k()?99:function(t,e,n){switch(t){case"asmjs":return 18;case"wasm":return 20;default:return 22+Math.min(Math.max(e-n,0),6)}}(l,g(),parseInt(w())),L=(t,e)=>t.sort((function(t,n){return ao(e,n)-ao(e,t)})),R=(e,n,o)=>{if(!M()||!t.possible||!cr())return;const r=O(),s=n[n.length-1],i=o?s.threat:s.ceval;if(i&&i.depth>=r)return void(E={path:e,steps:n,threatMode:o});const a={variant:t.variant.key,threads:g(),hashSize:y(),stopRequested:!1,initialFen:n[0].fen,moves:[],currentFen:s.fen,path:e,ply:s.ply,maxDepth:r,multiPv:parseInt(w()),threatMode:o,emit(t){M()&&N(t,a)}};if(o){const t=s.ply%2==1?"w":"b",e=s.fen.replace(/ (w|b) /," "+t+" ");a.currentFen=e,a.initialFen=e}else for(let c=1;c<n.length;c++){const e=n[c];uo(t.variant.key,e.san)?(a.moves=[],a.initialFen=e.fen):a.moves.push(e.uci)}lichess.storage.fire("ceval.disable"),lichess.tempStorage.set("ceval.enabled-after",lichess.storage.get("ceval.disable")),$||($="external"==l?new ro(p):"nnue"==l?new oo({baseUrl:"vendor/stockfish-nnue.wasm/",module:"Stockfish",downloadProgress:Oe(200,(e=>{P(e),t.redraw()})),version:"b6939d",wasmMemory:ir(2048,d?32768:2048),cache:new yo("ceval-wasm-cache")}):"hce"==l?new oo({baseUrl:c?"vendor/stockfish.wasm/":"vendor/stockfish-mv.wasm/",module:c?"Stockfish":"StockfishMv",version:"a022fa",wasmMemory:ir(1024,d?32768:1088)}):new no({url:"wasm"==l?"vendor/stockfish.js/stockfish.wasm.js":"vendor/stockfish.js/stockfish.js"})),$.start(a),S=!0,E={path:e,steps:n,threatMode:o}};function F(){M()&&S&&(null==$||$.stop(),S=!1)}return{technology:l,start:(t,e,n)=>{I(!1),R(t,e,!!n)},stop:F,allowed:x,possible:t.possible,enabled:M,downloadProgress:P,multiPv:w,threads:g,setThreads(t){lichess.storage.set(o("ceval.threads"),t.toString())},maxThreads:f,hashSize:y,setHashSize(t){lichess.storage.set(o("ceval.hash-size"),t.toString())},maxHashSize:b,infinite:k,supportsNnue:h,enableNnue:r,hovering:A,setHovering(e,n){A(n?{fen:e,uci:n}:null),t.setAutoShapes()},pvBoard:T,setPvBoard(e){T(e),t.redraw()},toggle(){if(t.possible&&x())if(F(),M()||document.hidden)lichess.tempStorage.set("ceval.enabled-after",""),M(!1);else{const t=lichess.storage.get("ceval.disable")||"1";t&&lichess.tempStorage.set("ceval.enabled-after",t),M(!0)}},curDepth:D,effectiveMaxDepth:O,variant:t.variant,isDeeper:I,goDeeper:function(){I(!0),E&&(k()?C&&t.emit(C,E):(F(),R(E.path,E.steps,E.threatMode)))},canGoDeeper:()=>D()<99&&!I()&&(!k()&&!(null==$?void 0:$.isComputing())||(()=>{var t;return!!E&&!!(null===(t=E.steps[E.steps.length-1].ceval)||void 0===t?void 0:t.cloud)})()),isComputing:()=>!!S&&!!(null==$?void 0:$.isComputing()),engineName:ar(l,p),longEngineName:()=>null==$?void 0:$.engineName(),destroy:()=>null==$?void 0:$.destroy(),redraw:t.redraw,cachable:"nnue"==l||"hce"==l||"external"==l&&p.officialStockfish,analysable:a,disconnectExternalEngine(){lichess.storage.remove("ceval.external")}}}function dr(t){let e=0;return n=>{e+=n.deltaY*(n.deltaMode?40:1),Math.abs(e)>=4?(t(n,!0),e=0):t(n,!1)}}const hr=(t,e)=>{var n;const o=((t,e)=>{let n="";if(We(e))"pawn"!==e.role&&(n=an(e.role).toUpperCase()),n+="@"+dn(e.to);else{const o=t.board.getRole(e.from);if(!o)return"--";if("king"!==o||!t.board[t.turn].has(e.to)&&2!==Math.abs(e.to-e.from)){const r=t.board.occupied.has(e.to)||"pawn"===o&&sn(e.from)!==sn(e.to);if("pawn"!==o){let r;if(n=an(o).toUpperCase(),r="king"===o?Po(e.to).intersect(t.board.king):"queen"===o?Oo(e.to,t.board.occupied).intersect(t.board.queen):"rook"===o?Do(e.to,t.board.occupied).intersect(t.board.rook):"bishop"===o?No(e.to,t.board.occupied).intersect(t.board.bishop):So(e.to).intersect(t.board.knight),r=r.intersect(t.board[t.turn]).without(e.from),r.nonEmpty()){const o=t.ctx();for(const n of r)t.dests(n,o).has(e.to)||(r=r.without(n));if(r.nonEmpty()){let t=!1,o=r.intersects(Xe.fromRank(rn(e.from)));r.intersects(Xe.fromFile(sn(e.from)))?t=!0:o=!0,o&&(n+=je[sn(e.from)]),t&&(n+=Ge[rn(e.from)])}}}else r&&(n=je[sn(e.from)]);r&&(n+="x"),n+=dn(e.to),e.promotion&&(n+="="+an(e.promotion).toUpperCase())}else n=e.to>e.from?"O-O":"O-O-O"}return n})(t,e);return t.play(e),(null===(n=t.outcome())||void 0===n?void 0:n.winner)?o+"#":t.isCheck()?o+"+":o};let ur=0;const pr=[...Array(8).keys()].map((t=>m(3===t?"tick.zero":"tick",{attrs:{style:`height: ${12.5*(t+1)}%`}})));function mr(t,e){const n=t.getCeval(),o=t.trans;if(!e.client){if(!n.analysable)return["Engine cannot analyze this position"];const r=n.downloadProgress()/1024/1024;return[e.server&&t.nextNodeBest()?o.noarg("usingServerAnalysis"):o.noarg("loadingEngine")+(r>=1?` (${r.toFixed(1)} MiB)`:"")]}const r=e.client.depth||0,s=e.client.cloud?[o("depthX",r),m("span.cloud",{attrs:{title:o.noarg("cloudAnalysis")}},"Cloud")]:[o("depthX",r+"/"+Math.max(r,e.client.maxDepth))];return n.canGoDeeper()?s.push(m("a.deeper",{attrs:{title:o.noarg("goDeeper"),"data-icon":""},hook:{insert:t=>t.elm.addEventListener("click",(()=>{n.goDeeper(),n.redraw()}))}})):!e.client.cloud&&e.client.knps&&s.push(", "+Math.round(e.client.knps)+"k nodes/s"),s}function fr(t,e){if(!e)return t.trans.noarg("loadingEngine");let n=t.trans("depthX",(e.depth||0)+"/"+e.maxDepth);return e.knps&&(n+=", "+Math.round(e.knps)+"k nodes/s"),n}function gr(t){return t.disableThreatMode&&t.disableThreatMode()?null:m("a.show-threat",{class:{active:t.threatMode(),hidden:!!t.getNode().check},attrs:{"data-icon":"",title:t.trans.noarg("showThreat")+" (x)"},hook:{insert:e=>e.elm.addEventListener("click",t.toggleThreatMode)}})}function vr(t){return[m("span",{attrs:{title:t.longEngineName()||""}},t.engineName),"external"==t.technology?m("span.technology.good",{attrs:{title:"Engine running outside of the browser"}},"EXTERNAL"):"nnue"==t.technology?m("span.technology.good",{attrs:{title:"Multi-threaded WebAssembly with SIMD (efficiently updatable neural network, using 4x smaller net by Sopel97)"}},"NNUE"):"hce"==t.technology?m("span.technology.good",{attrs:{title:"Multi-threaded WebAssembly (classical hand crafted evaluation)"}},"HCE"):"wasm"==t.technology?m("span.technology",{attrs:{title:"Single-threaded WebAssembly fallback (slow)"}},"WASM"):m("span.technology",{attrs:{title:"Single-threaded JavaScript fallback (very slow)"}},"ASMJS")]}function br(t){const e=t.server,n=t.client;return e?n&&(n.nodes>4e6||void 0!==n.mate&&(void 0===e.mate||Math.abs(n.mate)<Math.abs(e.mate)))?n:e:n}function yr(t){if(t.ongoing||!t.showEvalGauge())return;const e=br(t.currentEvals());let n;return e?(n=ao("white",e),ur=n):n=ur,m("div.eval-gauge",{class:{empty:null===n,reverse:"black"===t.getOrientation()}},[m("div.black",{attrs:{style:`height: ${100-50*(n+1)}%`}}),...pr])}function wr(t){const e=t.getCeval(),n=t.trans;if(!e.allowed()||!e.possible||!t.showComputer())return;const o=e.enabled(),r=t.currentEvals(),s=t.threatMode(),i=s&&t.getNode().threat,a=i||br(r);let c,l;a&&void 0!==a.cp?(c=ho(a.cp),l=r.client?r.client.cloud?100:Math.min(100,Math.round(100*r.client.depth/r.client.maxDepth)):0):a&&_(a.mate)?(c="#"+a.mate,l=100):t.outcome()?(c="-",l=0):(c=m(o?"i.ddloader":"i"),l=0),s&&(l=i?Math.min(100,Math.round(100*i.depth/i.maxDepth)):0);const d=o?m("div.bar",m("span",{class:{threat:s},attrs:{style:`width: ${l}%`},hook:{postpatch:(t,e)=>{if(t.data.percent>l||!!t.data.threatMode!=s){const t=e.elm,n=t.parentNode;n.removeChild(t),n.appendChild(t)}e.data.percent=l,e.data.threatMode=s}}})):null,h=o?[m("pearl",[c]),m("div.engine",[...s?[n.noarg("showThreat")]:vr(e),m("span.info",t.outcome()?[n.noarg("gameOver")]:s?[fr(t,i)]:mr(t,r))])]:[c?m("pearl",[c]):null,m("help",[...vr(e),m("br"),e.analysable?n.noarg("inLocalBrowser"):"Engine cannot analyse this game"])],u=t.mandatoryCeval&&t.mandatoryCeval()?null:m("div.switch",{attrs:{title:n.noarg("toggleLocalEvaluation")+" (L)"}},[m("input#analyse-toggle-ceval.cmn-toggle.cmn-toggle--subtle",{attrs:{type:"checkbox",checked:o,disabled:!e.analysable},hook:{insert:e=>e.elm.addEventListener("change",t.toggleCeval)}}),m("label",{attrs:{for:"analyse-toggle-ceval"}})]);return m("div.ceval"+(o?".enabled":""),{class:{computing:l<100&&e.isComputing()}},[d,...h,gr(t),u])}function kr(t){return t.getAttribute("data-fen")}function Cr(t){return xr(t).filter(N).map((t=>t.split("|")[1]))}function xr(t){const e=[];return $(t.target).closest("div.pv").children().filter("span.pv-san").each((function(){e.push($(this).attr("data-board"))})),e}function Mr(t,e){lichess.requestIdleCallback((()=>e.setHovering(kr(t),$(t).find("div.pv:hover").attr("data-uci")||void 0)),500)}function Pr(t){const e=t.getCeval();if(!e.allowed()||!e.possible||!e.enabled())return;const n=parseInt(e.multiPv()),o=t.getNode(),r=wn(o.fen).unwrap();let s,i,a,c=!1;t.threatMode()&&o.threat?(s=o.threat.pvs,c=!0):s=o.ceval?o.ceval.pvs:[],c&&(r.turn=on(r.turn),"white"==r.turn&&(r.fullmoves+=1));const l=sr(Zn(e.variant.key),r);return m("div.pv_box",{attrs:{"data-fen":o.fen},hook:{insert:n=>{const o=n.elm;o.addEventListener("mouseover",(e=>{const n=t.getCeval();n.setHovering(kr(o),function(t){return $(t.target).closest("div.pv").attr("data-uci")||void 0}(e));const r=e.target.dataset.board;if(r){a=Number(e.target.dataset.moveIndex),i=xr(e);const[t,o]=r.split("|");n.setPvBoard({fen:t,uci:o})}})),o.addEventListener("wheel",dr(((e,n)=>{if(e.preventDefault(),null!=a&&null!=i){e.deltaY<0&&a>0&&n?a-=1:e.deltaY>0&&a<i.length-1&&n&&(a+=1);const o=i[a];if(o){const[e,n]=o.split("|");t.getCeval().setPvBoard({fen:e,uci:n})}}}))),o.addEventListener("mouseout",(()=>t.getCeval().setHovering(kr(o))));for(const e of["touchstart","mousedown"])o.addEventListener(e,(e=>{const n=Cr(e);n.length>(null!=a?a:0)&&!t.threatMode()&&(t.playUciList(n.slice(0,(null!=a?a:0)+1)),e.preventDefault())}));o.addEventListener("mouseleave",(()=>{t.getCeval().setPvBoard(null),a=null})),Mr(o,e)},postpatch:(t,n)=>Mr(n.elm,e)}},[...[...Array(n).keys()].map((t=>function(t,e,n,o){const r={},s=[Sr()];n&&(t||(r.attrs={"data-uci":n.moves[0]}),e>1&&s.push(m("strong",_(n.mate)?"#"+n.mate:ho(n.cp))),o&&s.push(...function(t,e){const n=[];let o=Cn(t.board);for(let r=0;r<e.length;r++){let s;"white"===t.turn?s=`${t.fullmoves}.`:0===r&&(s=`${t.fullmoves}...`),s&&n.push(m("span",{key:s},s));const i=e[r],a=hr(t,hn(i)),c=Cn(t.board);if("--"===a)break;o+="|"+i,n.push(m("span.pv-san",{key:o,attrs:{"data-move-index":r,"data-board":`${c}|${i}`}},a))}return n}(o.clone(),n.moves.slice(0,16))));return m("div.pv.pv--nowrap",r,s)}(c,n,s[t],l.isOk?l.value:void 0))),Er(t)])}function Sr(){return m("span.pv-wrap-toggle",{hook:{insert:t=>{const e=t.elm;for(const n of["touchstart","mousedown"])e.addEventListener(n,(t=>{t.stopPropagation(),t.preventDefault(),$(e).closest(".pv").toggleClass("pv--nowrap")}))}}})}function Er(t){const e=t.getCeval().pvBoard();if(!e)return;const{fen:n,uci:o}=e,r={fen:n,lastMove:"@"===o[1]?[o.slice(2)]:[o.slice(0,2),o.slice(2,4)],orientation:t.getOrientation(),coordinates:!1,viewOnly:!0,drawable:{enabled:!1,visible:!1}},s=m("div.cg-wrap.is2d",{hook:{insert:t=>t.elm._cg=window.Chessground(t.elm,r),update:t=>t.elm._cg.set(r),destroy:t=>t.elm._cg.destroy()}});return m("div.pv-board",m("div.pv-board-square",s))}lichess.storage.make("ceval.disable").listen((()=>{const t=document.getElementById("analyse-toggle-ceval");(null==t?void 0:t.checked)&&t.click()}));const Ar=t=>m("glyph",{attrs:{title:t.name}},t.symbol),Tr=t=>m("eval",t.replace("-","−")),Ir=(t,e)=>(t=>Math.floor((t-1)/2)+1)(t)+(e?t%2==1?".":"...":""),$r=(t,e)=>m("index",Ir(t,e));function _r(t,e){var n;const o=br({client:e.ceval,server:e.eval}),r=[m("san",Dt(e.san))];return e.glyphs&&t.showGlyphs&&e.glyphs.forEach((t=>r.push(Ar(t)))),(null===(n=e.shapes)||void 0===n?void 0:n.length)&&r.push(m("shapes")),o&&t.showEval&&(_(o.cp)?r.push(Tr(ho(o.cp))):_(o.mate)&&r.push(Tr("#"+o.mate))),r}const Nr=(t,e)=>e.san?[$r(e.ply,t.withDots),..._r(t,e)]:void 0;function Dr(t){const e=Nr({withDots:!0,showEval:!1},t.currentNode());return m("div.ply-wrap",t.onMainline()?m("label.ply",[m("input",{attrs:{type:"checkbox",checked:t.withPly()},hook:P("change",(e=>{t.withPly(e.target.checked)}),t.redraw)}),...e?t.trans.vdom("startAtX",m("strong",e)):[t.trans.noarg("startAtInitialPosition")]]):null)}function Or(t,e){return m("input",{key:t,attrs:{spellcheck:!1,value:t},hook:M((t=>{t.onblur=function(){e(t.value,t)},t.onkeydown=function(e){"Enter"===e.key&&t.blur()}}))})}function qr(t){return m("span",t)}let Lr;function Rr(t){return m("div",function(t,e,n,o,r){let s=[];if("standard"!==t.setup.variant.key&&s.push(["Variant",qr(t.setup.variant.name)]),s=s.concat(t.tags.filter((e=>!r||!["WhiteElo","BlackElo"].includes(e[0])||!Dn(t.tags))).map((t=>[t[0],e?Or(t[1],e(t[0])):qr(t[1])]))),e){const r=t.tags.map((t=>t[0]));s.push([m("select",{hook:{insert:t=>{const e=t.elm;Lr=e.value,e.addEventListener("change",(t=>{Lr=e.value,$(e).parents("tr").find("input").each((function(){this.focus()}))}))},postpatch:(t,e)=>{Lr=e.elm.value}}},[m("option",o.noarg("newTag")),...n.map((t=>{if(!r.includes(t))return Ne(t,"",t)}))]),Or("",((t,n)=>{Lr&&(e(Lr)(t),n.value="")}))])}return m("table.study__tags.slist",m("tbody",s.map((function(t){return m("tr",{key:""+t[0]},[m("th",[t[0]]),m("td",[t[1]])])}))))}(t.tags.getChapter(),t.vm.mode.write&&t.tags.submit,t.tags.types,t.trans,t.data.hideRatings))}function Fr(t){const e=t.tags.getChapter(),n=e.tags.map((t=>t[1])).join(","),o=e.id+t.data.name+e.name+t.data.likes+n+t.vm.mode.write;return b("div."+e.id,Rr,[t,o])}class Br{constructor(t,e){this.root=t,this.chapterId=e,this.requested=q(!1),this.lastPly=q(!1),this.chartEl=q(null),this.unselect=t=>t.getSelectedPoints().forEach((t=>t.select(!1))),this.reset=()=>{this.requested(!1),this.lastPly(!1)},this.onMergeAnalysisData=()=>{var t;return(null===(t=window.LichessChartGame)||void 0===t?void 0:t.acpl.update)&&window.LichessChartGame.acpl.update(this.root.data,this.root.mainline)},this.request=()=>{this.root.socket.send("requestAnalysis",this.chapterId()),this.requested(!0)},lichess.pubsub.on("analysis.change",((e,n,o)=>{if(!window.LichessChartGame||this.lastPly()===o)return;const r=this.lastPly(void 0===o?this.lastPly():o),s=this.chartEl(),i=s&&s.highcharts;if(i)if(!1===r)this.unselect(i);else{const e=i.series[0].data[r-1-t.tree.root.ply];_(e)?e.select():this.unselect(i)}else this.lastPly(!1)}))}}function zr(t){const e=t.root.data.analysis;return t.root.showComputer()?e?m("div.study__server-eval.ready."+e.id,{hook:M((e=>{t.lastPly(!1),lichess.requestIdleCallback((async()=>{await lichess.loadModule("chart.game"),window.LichessChartGame.acpl(t.root.data,t.root.mainline,t.root.trans,e),t.chartEl(e)}),800)}))},[m("div.study__message",ke())]):t.requested()?Gr():function(t){const e=t.root,n=e.trans.noarg;return m("div.study__message",e.mainline.length<5?m("p",n("theChapterIsTooShortToBeAnalysed")):e.study.members.canContribute()?[m("p",[n("getAFullComputerAnalysis"),m("br"),n("makeSureTheChapterIsComplete")]),m("a.button.text",{attrs:{"data-icon":"",disabled:e.mainline.length<5},hook:P("click",t.request,e.redraw)},n("requestAComputerAnalysis"))]:[n("onlyContributorsCanRequestAnalysis")])}(t):jr()}const jr=()=>m("div.study__server-eval.disabled.padded","You disabled computer analysis."),Gr=()=>m("div.study__server-eval.requested.padded",ke());const Vr=["white","black"],Hr=["a","b","c","d","e","f","g","h"],Ur=["1","2","3","4","5","6","7","8"],Wr=[...Ur].reverse(),Kr=Array.prototype.concat(...Hr.map((t=>Ur.map((e=>t+e))))),Jr=t=>Kr[8*t[0]+t[1]],Yr=t=>[t.charCodeAt(0)-97,t.charCodeAt(1)-49],Xr=Kr.map(Yr);const Qr=()=>{let t;return{start(){t=performance.now()},cancel(){t=void 0},stop(){if(!t)return 0;const e=performance.now()-t;return t=void 0,e}}},Zr=t=>"white"===t?"black":"white",ts=(t,e)=>{const n=t[0]-e[0],o=t[1]-e[1];return n*n+o*o},es=(t,e)=>t.role===e.role&&t.color===e.color,ns=t=>(e,n)=>[(n?e[0]:7-e[0])*t.width/8,(n?7-e[1]:e[1])*t.height/8],os=(t,e)=>{t.style.transform=`translate(${e[0]}px,${e[1]}px)`},rs=(t,e,n=1)=>{t.style.transform=`translate(${e[0]}px,${e[1]}px) scale(${n})`},ss=(t,e)=>{t.style.visibility=e?"visible":"hidden"},is=t=>{var e;return t.clientX||0===t.clientX?[t.clientX,t.clientY]:(null===(e=t.targetTouches)||void 0===e?void 0:e[0])?[t.targetTouches[0].clientX,t.targetTouches[0].clientY]:void 0},as=t=>2===t.buttons||2===t.button,cs=(t,e)=>{const n=document.createElement(t);return e&&(n.className=e),n};function ls(t,e,n){const o=Yr(t);return e||(o[0]=7-o[0],o[1]=7-o[1]),[n.left+n.width*o[0]/8+n.width/16,n.top+n.height*(7-o[1])/8+n.height/16]}const ds=(t,e,n)=>({orig:t,piece:{color:n,role:e,scale:.8},brush:"green"});function hs(t,e,n,o){if("Current Position"===e)return[];const r=hn(e),s=dn(r.to);if(We(r))return[{orig:s,brush:n},ds(s,r.role,t)];const i=[{orig:dn(r.from),dest:s,brush:n,modifiers:o}];return r.promotion&&i.push(ds(s,r.promotion,t)),i}const us=t=>'\n<defs>\n  <filter id="shadow">\n    <feDropShadow dx="4" dy="7" stdDeviation="5" flood-opacity="0.5" />\n  </filter>\n</defs>'+t,ps={"?!":us('\n<g transform="translate(77 -18) scale(0.4)">\n  <circle style="fill:#56b4e9;filter:url(#shadow)" cx="50" cy="50" r="50" />\n  <path fill="#fff" d="M37.734 21.947c-3.714 0-7.128.464-10.242 1.393-3.113.928-6.009 2.13-8.685 3.605l4.343 8.766c2.35-1.202 4.644-2.157 6.883-2.867a22.366 22.366 0 0 1 6.799-1.065c2.294 0 4.07.464 5.326 1.393 1.311.874 1.967 2.186 1.967 3.933 0 1.748-.546 3.277-1.639 4.588-1.038 1.257-2.786 2.758-5.244 4.506-2.786 2.021-4.751 3.961-5.898 5.819-1.147 1.857-1.721 4.15-1.721 6.88v2.952h10.568v-2.377c0-1.147.137-2.103.41-2.868.328-.764.93-1.557 1.803-2.376.874-.82 2.104-1.803 3.688-2.95 2.13-1.584 3.906-3.058 5.326-4.424 1.42-1.42 2.485-2.95 3.195-4.59.71-1.638 1.065-3.576 1.065-5.816 0-4.206-1.584-7.675-4.752-10.406-3.114-2.731-7.51-4.096-13.192-4.096zm24.745.819l2.048 39.084h9.75l2.047-39.084zM35.357 68.73c-1.966 0-3.632.52-4.998 1.557-1.365.983-2.047 2.732-2.047 5.244 0 2.404.682 4.152 2.047 5.244 1.366 1.038 3.032 1.557 4.998 1.557 1.912 0 3.55-.519 4.916-1.557 1.366-1.092 2.05-2.84 2.05-5.244 0-2.512-.684-4.26-2.05-5.244-1.365-1.038-3.004-1.557-4.916-1.557zm34.004 0c-1.966 0-3.632.52-4.998 1.557-1.365.983-2.049 2.732-2.049 5.244 0 2.404.684 4.152 2.05 5.244 1.365 1.038 3.03 1.557 4.997 1.557 1.912 0 3.55-.519 4.916-1.557 1.366-1.092 2.047-2.84 2.047-5.244 0-2.512-.681-4.26-2.047-5.244-1.365-1.038-3.004-1.557-4.916-1.557z"/>\n</g>\n'),"?":us('\n<g transform="translate(77 -18) scale(0.4)">\n  <circle style="fill:#e69f00;filter:url(#shadow)" cx="50" cy="50" r="50" />\n  <path fill="#fff" d="M40.436 60.851q0-4.66 1.957-7.83 1.958-3.17 6.712-6.619 4.195-2.983 5.967-5.127 1.864-2.237 1.864-5.22 0-2.983-2.237-4.475-2.144-1.585-6.06-1.585-3.915 0-7.737 1.212t-7.83 3.263l-4.941-9.975q4.568-2.517 9.881-4.101 5.314-1.585 11.653-1.585 9.695 0 15.008 4.661 5.407 4.661 5.407 11.839 0 3.822-1.212 6.619-1.212 2.796-3.635 5.22-2.424 2.33-6.06 5.034-2.703 1.958-4.195 3.356-1.491 1.398-2.05 2.703-.467 1.305-.467 3.263v2.703H40.436zm-1.492 18.924q0-4.288 2.33-5.966 2.331-1.771 5.687-1.771 3.263 0 5.594 1.771 2.33 1.678 2.33 5.966 0 4.102-2.33 5.966-2.331 1.772-5.594 1.772-3.356 0-5.686-1.772-2.33-1.864-2.33-5.966z"/>\n</g>\n'),"??":us('\n<g transform="translate(77 -18) scale(0.4)">\n  <circle style="fill:#df5353;filter:url(#shadow)" cx="50" cy="50" r="50" />\n  <path fill="#fff" d="M31.8 22.22c-3.675 0-7.052.46-10.132 1.38-3.08.918-5.945 2.106-8.593 3.565l4.298 8.674c2.323-1.189 4.592-2.136 6.808-2.838a22.138 22.138 0 0 1 6.728-1.053c2.27 0 4.025.46 5.268 1.378 1.297.865 1.946 2.16 1.946 3.89s-.541 3.242-1.622 4.539c-1.027 1.243-2.756 2.73-5.188 4.458-2.756 2-4.7 3.918-5.836 5.755-1.134 1.837-1.702 4.107-1.702 6.808v2.92h10.457v-2.35c0-1.135.135-2.082.406-2.839.324-.756.918-1.54 1.783-2.35.864-.81 2.079-1.784 3.646-2.918 2.107-1.568 3.863-3.026 5.268-4.376 1.405-1.405 2.46-2.92 3.162-4.541.703-1.621 1.054-3.54 1.054-5.755 0-4.161-1.568-7.592-4.702-10.294-3.08-2.702-7.43-4.052-13.05-4.052zm38.664 0c-3.675 0-7.053.46-10.133 1.38-3.08.918-5.944 2.106-8.591 3.565l4.295 8.674c2.324-1.189 4.593-2.136 6.808-2.838a22.138 22.138 0 0 1 6.728-1.053c2.27 0 4.026.46 5.269 1.378 1.297.865 1.946 2.16 1.946 3.89s-.54 3.242-1.62 4.539c-1.027 1.243-2.757 2.73-5.189 4.458-2.756 2-4.7 3.918-5.835 5.755-1.135 1.837-1.703 4.107-1.703 6.808v2.92h10.457v-2.35c0-1.135.134-2.082.404-2.839.324-.756.918-1.54 1.783-2.35.865-.81 2.081-1.784 3.648-2.918 2.108-1.568 3.864-3.026 5.269-4.376 1.405-1.405 2.46-2.92 3.162-4.541.702-1.621 1.053-3.54 1.053-5.755 0-4.161-1.567-7.592-4.702-10.294-3.08-2.702-7.43-4.052-13.05-4.052zM29.449 68.504c-1.945 0-3.593.513-4.944 1.54-1.351.973-2.027 2.703-2.027 5.188 0 2.378.676 4.108 2.027 5.188 1.35 1.027 3 1.54 4.944 1.54 1.892 0 3.512-.513 4.863-1.54 1.35-1.08 2.026-2.81 2.026-5.188 0-2.485-.675-4.215-2.026-5.188-1.351-1.027-2.971-1.54-4.863-1.54zm38.663 0c-1.945 0-3.592.513-4.943 1.54-1.35.973-2.026 2.703-2.026 5.188 0 2.378.675 4.108 2.026 5.188 1.351 1.027 2.998 1.54 4.943 1.54 1.891 0 3.513-.513 4.864-1.54 1.351-1.08 2.027-2.81 2.027-5.188 0-2.485-.676-4.215-2.027-5.188-1.35-1.027-2.973-1.54-4.864-1.54z"/>\n</g>\n'),"!?":us('\n<g transform="translate(77 -18) scale(0.4)">\n  <circle style="fill:#ea45d8;filter:url(#shadow)" cx="50" cy="50" r="50"/>\n    <path fill="#fff" d="M60.823 58.9q0-4.098 1.72-6.883 1.721-2.786 5.9-5.818 3.687-2.622 5.243-4.506 1.64-1.966 1.64-4.588t-1.967-3.933q-1.885-1.393-5.326-1.393t-6.8 1.065q-3.36 1.065-6.883 2.868l-4.343-8.767q4.015-2.212 8.685-3.605 4.67-1.393 10.242-1.393 8.521 0 13.192 4.097 4.752 4.096 4.752 10.405 0 3.36-1.065 5.818-1.066 2.458-3.196 4.588-2.13 2.048-5.326 4.424-2.376 1.72-3.687 2.95-1.31 1.229-1.802 2.376-.41 1.147-.41 2.868v2.376h-10.57zm-1.311 16.632q0-3.77 2.048-5.244 2.049-1.557 4.998-1.557 2.868 0 4.916 1.557 2.049 1.475 2.049 5.244 0 3.605-2.049 5.244-2.048 1.556-4.916 1.556-2.95 0-4.998-1.556-2.048-1.64-2.048-5.244zM36.967 61.849h-9.75l-2.049-39.083h13.847zM25.004 75.532q0-3.77 2.049-5.244 2.048-1.557 4.998-1.557 2.867 0 4.916 1.557 2.048 1.475 2.048 5.244 0 3.605-2.048 5.244-2.049 1.556-4.916 1.556-2.95 0-4.998-1.556-2.049-1.64-2.049-5.244z" vector-effect="non-scaling-stroke"/>\n</g>\n'),"!":us('\n<g transform="translate(77 -18) scale(0.4)">\n  <circle style="fill:#22ac38;filter:url(#shadow)" cx="50" cy="50" r="50" />\n  <path fill="#fff" d="M54.967 62.349h-9.75l-2.049-39.083h13.847zM43.004 76.032q0-3.77 2.049-5.244 2.048-1.557 4.998-1.557 2.867 0 4.916 1.557 2.048 1.475 2.048 5.244 0 3.605-2.048 5.244-2.049 1.556-4.916 1.556-2.95 0-4.998-1.556-2.049-1.64-2.049-5.244z" vector-effect="non-scaling-stroke"/>\n</g>\n'),"!!":us('\n<g transform="translate(77 -18) scale(0.4)">\n  <circle style="fill:#168226;filter:url(#shadow)" cx="50" cy="50" r="50" />\n  <path fill="#fff" d="M71.967 62.349h-9.75l-2.049-39.083h13.847zM60.004 76.032q0-3.77 2.049-5.244 2.048-1.557 4.998-1.557 2.867 0 4.916 1.557 2.048 1.475 2.048 5.244 0 3.605-2.048 5.244-2.049 1.556-4.916 1.556-2.95 0-4.998-1.556-2.049-1.64-2.049-5.244zM37.967 62.349h-9.75l-2.049-39.083h13.847zM26.004 76.032q0-3.77 2.049-5.244 2.048-1.557 4.998-1.557 2.867 0 4.916 1.557 2.048 1.475 2.048 5.244 0 3.605-2.048 5.244-2.049 1.556-4.916 1.556-2.95 0-4.998-1.556-2.049-1.64-2.049-5.244z" vector-effect="non-scaling-stroke"/>\n</g>\n')};class ms{constructor(t,e,n,o){this.root=t,this.chapterId=e,this.trans=n,this.redraw=o,this.makeState=()=>{const t=this.root.node,e=(t.comments||[])[0],n={init:""===this.root.path,comment:e?e.text:void 0,showHint:!1},o=Ht(this.root.path),r=this.root.tree.nodeAtPath(o);this.root.onMainline&&!t.children[0]||!this.root.onMainline&&!this.root.tree.pathIsMainline(o)?n.feedback="end":this.isMyMove()?(n.feedback="play",n.hint=(t.gamebook||{}).hint):this.root.onMainline?n.feedback="good":(n.feedback="bad",n.comment||(n.comment=r.children[0].gamebook.deviation)),this.state=n,n.comment||("good"===n.feedback?setTimeout(this.next,this.root.path?1e3:300):"bad"===n.feedback&&setTimeout(this.retry,800))},this.isMyMove=()=>this.root.turnColor()===this.root.data.orientation,this.movableColor=()=>["play","good"].includes(this.state.feedback)?this.root.data.orientation:void 0,this.retry=()=>{let t=this.root.path;for(;t&&!this.root.tree.pathIsMainline(t);)t=Ht(t);this.root.userJump(t),this.redraw()},this.next=()=>{if(!this.isMyMove()){const t=this.root.node.children[0];t&&this.root.userJump(this.root.path+t.id)}this.redraw()},this.onSpace=()=>{switch(this.state.feedback){case"bad":this.retry();break;case"end":this.root.study.goToNextChapter();break;default:this.next()}},this.onPremoveSet=()=>{this.next()},this.hint=()=>{this.state.hint&&(this.state.showHint=!this.state.showHint)},this.solution=()=>{this.root.chessground.setShapes(hs(this.root.turnColor(),this.root.node.children[0].uci,"green"))},this.canJumpTo=t=>Ut(this.root.path,t),this.onJump=()=>{this.makeState(),setTimeout((()=>this.root.withCg((t=>t.playPremove()))),100)},this.onShapeChange=t=>{const e=this.root.node;e.gamebook&&e.gamebook.shapes&&!t.length&&(e.shapes=e.gamebook.shapes.slice(0),this.root.jump(this.root.path))},ie(t.tree.root,(t=>{t.gamebook=t.gamebook||{},t.shapes&&(t.gamebook.shapes=t.shapes.slice(0))})),this.makeState()}}class fs{constructor(t,e,n){this.text=t,this.doSave=e,this.redraw=n,this.edit=!1}save(t){this.text=t,this.doSave(t),this.redraw()}set(t){this.text=t||void 0}}const gs=t=>(t?"Chapter":"Study")+" pinned comment";function vs(t,e){const n=e?t.chapterDesc:t.studyDesc,o=t.members.canContribute()&&!t.gamebookPlay();if(n.edit)return bs(n,e?t.data.chapter.id:t.data.id,e);const r="-"===n.text;return!n.text||r&&!o?void 0:m(`div.study-desc${e?".chapter-desc":""}${r?".empty":""}`,[o&&!r?m("div.contrib",[m("span",gs(e)),r?null:m("a",{attrs:{"data-icon":"",title:"Edit"},hook:P("click",(t=>{n.edit=!0}),n.redraw)}),m("a",{attrs:{"data-icon":"",title:"Delete"},hook:P("click",(()=>{confirm("Delete permanent description?")&&n.save("")}))})]):null,r?m("a.text.button",{hook:P("click",(t=>{n.edit=!0}),n.redraw)},gs(e)):m("div.text",{hook:ht(n.text)})])}const bs=(t,e,n)=>m("div.study-desc-form",[m("div.title",[gs(n),m("button.button.button-empty.button-red",{attrs:{"data-icon":"",title:"Close"},hook:P("click",(()=>{t.edit=!1}),t.redraw)})]),m("form.form3",[m("div.form-group",[m("textarea#form-control.desc-text."+e,{hook:M((e=>{e.value="-"===t.text?"":t.text||"",e.oninput=()=>{t.save(e.value.trim())},e.focus()}))})])])]);class ys{constructor(t,e,n,o,r,s){this.id=t,this.data=e,this.send=n,this.redraw=o,this.members=r,this.log=[],this.cooldown=!1,this.setSync=t=>{this.send("relaySync",t),this.redraw()},this.loading=()=>{var t;return!this.cooldown&&(null===(t=this.data.sync)||void 0===t?void 0:t.ongoing)},this.applyChapterRelay=(t,e)=>{this.clockInterval&&clearInterval(this.clockInterval),e&&(t.relay=this.convertDate(e),_n(t)||(this.clockInterval=setInterval(this.redraw,1e3)))},this.roundById=t=>this.data.rounds.find((e=>e.id==t)),this.currentRound=()=>this.roundById(this.id),this.tourPath=()=>`/broadcast/${this.data.tour.slug}/${this.data.tour.id}`,this.roundPath=t=>{const e=t||this.currentRound();return e&&`/broadcast/${this.data.tour.slug}/${e.slug}/${e.id}`},this.convertDate=t=>(void 0===t.secondsSinceLastMove||t.lastMoveAt||(t.lastMoveAt=Date.now()-1e3*t.secondsSinceLastMove),t),this.socketHandlers={relayData:t=>{var e;t.sync&&(t.sync.log=(null===(e=this.data.sync)||void 0===e?void 0:e.log)||[]),this.data=t,this.redraw()},relaySync:t=>{var e;this.data.sync={...t,log:(null===(e=this.data.sync)||void 0===e?void 0:e.log)||t.log},this.redraw()},relayLog:t=>{this.data.sync&&(this.data.sync.log.push(t),this.data.sync.log=this.data.sync.log.slice(-20),this.cooldown=!0,setTimeout((()=>{this.cooldown=!1,this.redraw()}),4500),this.redraw(),t.error&&(lichess.sound.play("wrapAround"),console.warn(`relay synchronisation error: ${t.error}`)))}},this.socketHandler=(t,e)=>{const n=this.socketHandlers[t];return!(!n||e.id!==this.id)&&(n(e),!0)},this.applyChapterRelay(s,s.relay),this.tourShow={active:(location.pathname.match(/\//g)||[]).length<5,disable:()=>{this.tourShow.active=!1}}}}class ws{constructor(t,e,n){this.studyId=t,this.redraw=e,this.trans=n,this.loading=!1,this.page=1,this.playing=!1,this.addNode=(t,e)=>{const n=this.pager&&this.pager.currentPageResults.find((e=>e.id==t.chapterId));n&&n.playing&&(n.fen=e.fen,n.lastMove=e.uci,this.redraw())},this.reload=t=>{this.pager&&!t&&(this.loading=!0,this.redraw()),((t,e,n)=>z(`/study/${t}/multi-board?page=${e}&playing=${n}`))(this.studyId,this.page,this.playing).then((t=>{this.pager=t,t.nbPages<this.page&&(t.nbPages?this.setPage(t.nbPages):this.page=1),this.loading=!1,this.redraw()}))},this.reloadEventually=J(this.reload,1e3),this.setPage=t=>{this.page!=t&&(this.page=t,this.reload())},this.nextPage=()=>this.setPage(this.page+1),this.prevPage=()=>this.setPage(this.page-1),this.lastPage=()=>{this.pager&&this.setPage(this.pager.nbPages)},this.setPlaying=t=>{this.playing=t,this.reload()}}}function ks(t,e){const n=e.chapters.list().map((t=>t.id)).join("");return m("div.study__multiboard",{class:{loading:t.loading,nopager:!t.pager},hook:{insert(e){t.reload(!0),e.data.chapterIds=n},postpatch(e,o){e.data.chapterIds!==n&&t.reloadEventually(),o.data.chapterIds=n}}},t.pager?function(t,e){const n=e.multiBoard;return[m("div.top",[xs(t,n),Cs(n)]),m("div.now-playing",t.currentPageResults.map(Ps(e)))]}(t.pager,e):[ke()])}function Cs(t){return m("label.playing",[m("input",{attrs:{type:"checkbox",checked:t.playing},hook:P("change",(e=>{t.setPlaying(e.target.checked)}))}),t.trans.noarg("playing")])}function xs(t,e){const n=e.page,o=Math.min(t.nbResults,(n-1)*t.maxPerPage+1),r=Math.min(t.nbResults,n*t.maxPerPage);return m("div.pager",[Ms(e.trans.noarg("first"),"",(()=>e.setPage(1)),n>1,e),Ms(e.trans.noarg("previous"),"",e.prevPage,n>1,e),m("span.page",`${o}-${r} / ${t.nbResults}`),Ms(e.trans.noarg("next"),"",e.nextPage,n<t.nbPages,e),Ms(e.trans.noarg("last"),"",e.lastPage,n<t.nbPages,e)])}function Ms(t,e,n,o,r){return m("button.fbt",{attrs:{"data-icon":e,disabled:!o,title:t},hook:P("mousedown",n,r.redraw)})}function Ps(t){return e=>{var n;const o=e.players?[Ss(e.players[Zr(e.orientation)]),Es(e),Ss(e.players[e.orientation])]:[m("div.name",e.name),Es(e)];return m("a."+e.id,{attrs:{title:e.name},class:{active:!t.multiBoard.loading&&t.vm.chapterId==e.id&&!(null===(n=t.relay)||void 0===n?void 0:n.tourShow.active)},hook:P("mousedown",(n=>t.setChapter(e.id)))},o)}}function Ss(t){return m("span.player",[t.title?`${t.title} ${t.name}`:t.name,t.rating&&m("span",""+t.rating)])}function Es(t){return m("span.mini-board.cg-wrap.is2d",{attrs:{"data-state":`${t.fen},${t.orientation},${t.lastMove}`},hook:{insert(e){lichess.miniBoard.init(e.elm),e.data.fen=t.fen},postpatch(e,n){if(e.data.fen!==t.fen){const e=t.lastMove;(o=n.elm,r="chessground",o[(t=>`lichess-${t}`)(r)]).set({fen:t.fen,lastMove:[e[0]+e[1],e[2]+e[3]]})}var o,r;n.data.fen=t.fen}}})}function As(t,e,n,o,r){const s=e.socket.send,i=e.redraw,a=Mn("relay.rec",!0),c=((t,e,n)=>{const o=Pn(t,(()=>[])),r=new Map(o());return(t,s)=>{_(s)&&(r.delete(t),r.set(t,s),o(Array.from(r.entries()).slice(-e)));const i=r.get(t);return _(i)?i:n()}})("study.rec",100,(()=>!1)),l=(()=>{const n=t.chapter.id!==t.position.chapterId,s=t.features.sticky&&!e.initialPath&&!n&&!o;return{loading:!1,tab:q(r||t.chapters.length>1?"chapters":"members"),toolTab:q("tags"),chapterId:s?t.position.chapterId:t.chapter.id,mode:{sticky:s,write:r?a():c(t.id)},behind:0,updatedAt:Date.now()-1e3*t.secondsSinceUpdate,gamebookOverride:void 0}})(),d=function(t){let e,n;return{set(o){clearTimeout(n),e=o,n=setTimeout((function(){e=void 0,t()}),o.duration)},get:()=>e}}(i),h=()=>function(t){var e;(null===(e=t.study)||void 0===e?void 0:e.data.chapter.gamebook)||lichess.loadScript("javascripts/study/tour.js").then((()=>{window.lichess.studyTour({userId:t.opts.userId,isContrib:t.study.members.canContribute(),isOwner:t.study.members.isOwner(),setTab:e=>{t.study.vm.tab(e),t.redraw()},closeActionMenu:()=>{t.actionMenu.open=!1,t.redraw()}})}))}(e),u=qe({initDict:t.members,myId:o?void 0:e.opts.userId,ownerId:t.ownerId,send:s,tab:l.tab,startTour:h,notif:d,onBecomingContributor(){l.mode.write=!r||a()},admin:t.admin,redraw:i,trans:e.trans}),p=$n(t.chapters,s,(()=>l.tab("chapters")),(e=>((t,e)=>z(`/study/${t}/${e}/meta`))(t.id,e)),e),m=()=>p.get(l.chapterId),f=()=>e.opts.userId===t.chapter.ownerId,g=new ws(t.id,i,e.trans),v=r?new ys(t.id,r,s,i,u,t.chapter):void 0,b=function(t,e,n,o,r){const s=Date.now();function i(){const t=e();return"scratch"===t.from&&!!t.isNew&&Date.now()-s<9e3}const a=q(!1);return{open:a,openIfNew(){i()&&a(!0)},save(e,n){t(e,n),a(!1)},getData:e,isNew:i,trans:n,redraw:o,relay:r}}(((n,o)=>{s("editStudy",n),!o||"standard"!==t.chapter.setup.variant.key||1!==e.mainline.length||t.chapter.setup.fromFen||v||p.newForm.openInitial()}),(()=>t),e.trans,i,v);function y(){return l.mode.write&&!T()}function w(...t){return y()?(s(...t),!0):l.mode.sticky=!1}const k=function(t){const e=q(null),n=q(!1),o=Oe(500,(n=>{const o=e();o&&t.study.makeChange("setComment",{ch:o.chapterId,path:o.path,text:n})}));return{root:t,current:e,opening:n,submit:function(t){e()&&o(t)},start:function(o,r,s){n(!0),e({chapterId:o,path:r,node:s}),t.userJump(r)},onSetPath(t,n,o){const r=e();!r||n===r.path&&t===r.chapterId&&r.node===o||(r.chapterId=t,r.path=n,r.node=o)},redraw:t.redraw,delete(e,n,o){t.study.makeChange("deleteComment",{ch:e,path:n,id:o})}}}(e),C=Un(e),x=function(t,e,n){const o=Oe(500,(function(n,o){t.study.makeChange("setTag",{chapterId:e().id,name:n,value:o.substr(0,140)})}));return{submit:t=>e=>o(t,e),getChapter:e,types:n}}(e,(()=>t.chapter),n),M=new fs(t.description,J((e=>{t.description=e,s("descStudy",e)}),500),i),P=new fs(t.chapter.description,J((e=>{t.chapter.description=e,s("descChapter",{id:l.chapterId,desc:e})}),500),i),S=new Br(e,(()=>l.chapterId)),E=function(t,e,n,o){const r=q(!1);return{open:r,getTopics:e,save(e){t(e),r(!1)},trans:n,redraw:o}}((t=>s("setTopics",t)),(()=>t.topics||[]),e.trans,i);function A(t){return{...t,ch:l.chapterId}}function T(){return t.chapter.gamebook&&"analyse"!==l.gamebookOverride&&("play"===l.gamebookOverride||!u.canContribute())}function I(){if(e.embed)return;const n=u.canContribute();l.mode.write=l.mode.write&&n,lichess.pubsub.emit("chat.writeable",t.features.chat),lichess.pubsub.emit("chat.permissions",{local:n}),lichess.pubsub.emit("palantir.toggle",t.features.chat&&!!u.myMember());const o=!(T()||!t.chapter.features.computer&&!t.chapter.practice);o||e.getCeval().enabled(!1),e.getCeval().allowed(o),t.chapter.features.explorer||e.explorer.disable(),e.explorer.allowed(t.chapter.features.explorer)}function $(n){const o=n.study,r=e.path,s=t.chapter.id===o.chapter.id;l.mode.sticky=l.mode.sticky&&o.features.sticky||!t.features.sticky&&o.features.sticky,l.mode.sticky&&(l.behind=0),t.position=o.position,t.name=o.name,t.visibility=o.visibility,t.features=o.features,t.settings=o.settings,t.chapter=o.chapter,t.likes=o.likes,t.liked=o.liked,t.description=o.description,P.set(t.chapter.description),M.set(t.description),document.title=t.name,u.dict(o.members),p.list(o.chapters),e.flipped=!1;const a=!l.mode.write&&s;let c;e.reloadData(n.analysis,a),l.gamebookOverride=void 0,I(),l.loading=!1,B(),v&&v.applyChapterRelay(t.chapter,o.chapter.relay),l.mode.sticky?(l.chapterId=t.position.chapterId,c=l.justSetChapterId===l.chapterId&&p.localPaths[l.chapterId]||t.position.path):c=s?r:t.chapter.relay?t.chapter.relay.path:p.localPaths[l.chapterId]||"",e.userJump(e.tree.longestValidPath(c)),l.justSetChapterId=void 0,!t.chapter.practice&&e.practice&&e.togglePractice(),t.chapter.practice&&e.restartPractice(),R&&R.onLoad(),S.reset(),k.onSetPath(t.chapter.id,e.path,e.node),i(),e.startCeval()}l.mode.sticky&&!T()?e.userJump(t.position.path):t.chapter.relay&&!e.initialPath&&e.userJump(t.chapter.relay.path),I();const N=Oe(700,(()=>(l.loading=!0,((t,e,n)=>{let o="/"+t+"/"+e;return n&&(o+="/"+n),z(o)})(R?"practice/load":"study",t.id,l.mode.sticky?void 0:l.chapterId).then($,lichess.reload)))),D=Oe(300,(e=>{l.mode.sticky&&e!==t.position.path&&w("setPath",A({path:e}))}));u.canContribute()&&b.openIfNew();const O=()=>e.node,L=function(t,e,n,o,r,s,i,a){const c=q(!1);return{studyId:t.id,variantKey:t.chapter.setup.variant.key,chapter:e,bottomColor:r,isPrivate:()=>"private"===t.visibility,currentNode:n,onMainline:o,withPly:c,relay:s,cloneable:t.features.cloneable,redraw:i,trans:a}}(t,m,O,(()=>e.tree.pathIsMainline(e.path)),(()=>e.flipped?on(t.chapter.setup.orientation):t.chapter.setup.orientation),v,i,e.trans),R=o&&Bn(e,t,o);let F;function B(){if(!T())return F=void 0;F&&F.chapterId===l.chapterId||(F=new ms(e,l.chapterId,e.trans,i),l.mode.sticky=!1)}function j(t){return t.p.chapterId!==l.chapterId&&(l.mode.sticky&&t.s&&N(),!0)}function G(t){t&&u.setActive(t.u),l.updatedAt=Date.now()}function V(t){return{...t,ch:l.chapterId,path:e.path}}B();const H=J((()=>s("like",{liked:t.liked})),1e3);function U(t,e){const n=t===l.chapterId&&!e;(null==v?void 0:v.tourShow.active)&&(v.tourShow.disable(),n&&i()),n||(l.mode.sticky&&w("setChapter",t)||(l.mode.sticky=!1,l.behind||(l.behind=1),l.chapterId=t,N()),l.loading=!0,l.nextChapterId=t,l.justSetChapterId=t,i())}const[W,K]=[-1,1].map((t=>()=>{const e=p.list(),n=e.findIndex((t=>t.id===l.chapterId));return n<0?void 0:e[n+t]})),Y={path(n){const o=n.p,r=n.w;return G(r),l.mode.sticky?o.chapterId===t.position.chapterId&&e.tree.pathExists(o.path)?(t.position.path=o.path,void(r&&r.s===lichess.sri||(e.userJump(o.path),i()))):N():(l.behind++,i())},addNode(n){const o=n.p,r=n.n,s=n.w,a=n.s;if(G(s),("multiBoard"==l.toolTab()||v&&v.tourShow.active)&&g.addNode(n.p,n.n),a&&!l.mode.sticky&&l.behind++,j(n))return void(a&&!l.mode.sticky&&i());if(a&&s&&s.s===lichess.sri)return void(t.position.path=o.path+r.id);v&&v.applyChapterRelay(t.chapter,n.relay);const c=e.tree.addNode(r,o.path);if(!c)return N();e.tree.addDests(n.d,c),a&&(t.position.path=c),(a&&l.mode.sticky||o.path===e.path&&o.path===Wt(e.mainline))&&e.jump(c),i()},deleteNode(t){const n=t.p,o=t.w;if(G(o),!(j(t)||o&&o.s===lichess.sri)){if(!e.tree.pathExists(t.p.path))return N();e.tree.deleteNodeAt(n.path),l.mode.sticky&&e.jump(e.path),i()}},promote(t){const n=t.p,o=t.w;if(G(o),!(j(t)||o&&o.s===lichess.sri)){if(!e.tree.pathExists(t.p.path))return N();e.tree.promoteAt(n.path,t.toMainline),l.mode.sticky&&e.jump(e.path),i()}},reload:N,changeChapter(e){G(e.w),l.mode.sticky||l.behind++,t.position=e.p,l.mode.sticky?N():i()},updateChapter(t){G(t.w),N()},descChapter(e){G(e.w),e.w&&e.w.s===lichess.sri||(t.chapter.id===e.chapterId&&(t.chapter.description=e.desc,P.set(e.desc)),i())},descStudy(e){G(e.w),e.w&&e.w.s===lichess.sri||(t.description=e.desc,M.set(e.desc),i())},setTopics(e){G(e.w),t.topics=e.topics,i()},addChapter(e){G(e.w),e.s&&!l.mode.sticky&&l.behind++,e.s?t.position=e.p:e.w&&e.w.s===lichess.sri&&(l.mode.write=r?a():c(t.id),l.chapterId=e.p.chapterId),N()},members(t){u.update(t),I(),i()},chapters(t){p.list(t),m()||(l.chapterId=t[0].id,l.mode.sticky||N()),i()},shapes(t){const n=t.p,o=t.w;if(G(o),t.p.chapterId===l.chapterId){if(o&&o.s===lichess.sri)return i();e.tree.setShapes(t.s,e.path),e.path===n.path&&e.withCg((e=>e.setShapes(t.s))),i()}},validationError(t){alert(t.error)},setComment(t){const n=t.p;G(t.w),j(t)||(e.tree.setCommentAt(t.c,n.path),i())},setTags(e){G(e.w),e.chapterId===l.chapterId&&(t.chapter.tags=e.tags,i())},deleteComment(t){const n=t.p;G(t.w),j(t)||(e.tree.deleteCommentAt(t.id,n.path),i())},glyphs(t){const n=t.p;G(t.w),j(t)||(e.tree.setGlyphsAt(t.g,n.path),e.path===n.path&&e.setAutoShapes(),i())},clock(t){const n=t.p;G(t.w),j(t)||(e.tree.setClockAt(t.c,n.path),i())},forceVariation(t){const n=t.p;G(t.w),j(t)||(e.tree.forceVariationAt(n.path,t.force),i())},conceal(e){j(e)||(t.chapter.conceal=e.ply,i())},liking(e){t.likes=e.l.likes,e.w&&e.w.s===lichess.sri&&(t.liked=e.l.me),i()},error(t){alert(t)}};return{data:t,form:b,members:u,chapters:p,notif:d,commentForm:k,glyphForm:C,serverEval:S,share:L,tags:x,studyDesc:M,chapterDesc:P,topics:E,vm:l,relay:v,multiBoard:g,isUpdatedRecently:()=>Date.now()-l.updatedAt<3e5,toggleLike(){t.liked=!t.liked,i(),H()},position:()=>t.position,currentChapter:m,isChapterOwner:f,canJumpTo:n=>F?F.canJumpTo(n):void 0===t.chapter.conceal||f()||Ut(e.path,n)||e.tree.lastMainlineNode(n).ply<=t.chapter.conceal,onJump(){F?F.onJump():p.localPaths[l.chapterId]=e.path,R&&R.onJump()},withPosition:V,setPath(t,e){D(t),k.onSetPath(l.chapterId,t,e)},deleteNode(t){w("deleteNode",A({path:t,jumpTo:e.path}))},promote(t,e){w("promote",A({toMainline:e,path:t}))},forceVariation(t,e){w("forceVariation",A({force:e,path:t}))},setChapter:U,toggleSticky(){l.mode.sticky=!l.mode.sticky&&t.features.sticky,N()},toggleWrite(){l.mode.write=!l.mode.write&&u.canContribute(),r?a(l.mode.write):c(t.id,l.mode.write),N()},isWriting:y,makeChange:w,startTour:h,userJump:e.userJump,currentNode:O,practice:R,gamebookPlay:()=>F,prevChapter:W,nextChapter:K,hasNextChapter:()=>{const t=p.list();return t[t.length-1].id!=l.chapterId},goToPrevChapter(){const t=W();t&&U(t.id)},goToNextChapter(){const t=K();t&&U(t.id)},setGamebookOverride(t){l.gamebookOverride=t,B(),I(),e.userJump(e.path),t||N()},mutateCgConfig:function(t){t.drawable.onChange=t=>{l.mode.write&&(e.tree.setShapes(t,e.path),w("shapes",A({path:e.path,shapes:t}))),F&&F.onShapeChange(t)}},explorerGame(t,e){w("explorerGame",V({gameId:t,insert:e}))},onPremoveSet(){F&&F.onPremoveSet()},looksNew(){const t=p.list();return 1==t.length&&"Chapter 1"==t[0].name&&!m().ongoing},redraw:i,trans:e.trans,socketHandler:(t,e)=>{const n=Y[t];return n?(n(e),!0):!!v&&v.socketHandler(t,e)}}}class Ts{constructor(t){this.ctrl=t,this.active=t=>!(t&&t!==this.delay||!this.timeout),this.getDelay=()=>this.delay}move(){const t=this.ctrl.node.children[0];if(t){const e=this.ctrl.path+t.id;if(this.ctrl.canJumpTo(e))return this.ctrl.jump(e),this.lastMoveAt=Date.now(),this.ctrl.redraw(),!0}return this.stop(),this.ctrl.redraw(),!1}evalToCp(t){return t.eval?t.eval.mate?t.eval.mate>0?990:-990:t.eval.cp:t.ply%2?990:-990}nextDelay(){if("string"!=typeof this.delay||this.ctrl.onMainline){if("realtime"===this.delay){if(this.ctrl.node.ply<2)return 1e3;const t=this.ctrl.data.game.moveCentis;if(!t)return 1500;return 10*t[this.ctrl.node.ply-this.ctrl.tree.root.ply]+130||2e3}if("cpl"===this.delay){const t=30;if(this.ctrl.node.ply>=this.ctrl.mainline.length-1)return 0;const e=this.evalToCp(this.ctrl.node),n=this.evalToCp(this.ctrl.node.children[0]);return Math.max(500,Math.min(1e4,Math.abs(e-n)*t))}return this.delay}return 1500}schedule(){this.timeout=setTimeout((()=>{this.move()&&this.schedule()}),this.nextDelay())}start(t){this.stop(),this.delay=t,this.schedule(),"realtime"==t&&(this.redrawInterval=setInterval(this.ctrl.redraw,100))}stop(){this.delay=void 0,this.timeout&&(clearTimeout(this.timeout),this.timeout=void 0),this.redrawInterval&&(clearInterval(this.redrawInterval),this.redrawInterval=void 0),this.lastMoveAt=void 0}toggle(t){this.active(t)?this.stop():(this.active()||this.move()||this.ctrl.jump(""),this.start(t))}}function Is(t,e,n){const o="abset-"+t.id;return m("div.setting."+o,t.title?{attrs:{title:e.noarg(t.title)}}:{},[m("label",{attrs:{for:o}},e.noarg(t.name)),m("div.switch",[m("input#"+o+".cmn-toggle",{attrs:{type:"checkbox",checked:t.checked,disabled:!!t.disabled},hook:P("change",(e=>t.change(e.target.checked)),n)}),m("label",{attrs:{for:o}})])])}function $s(t,e,n){return(n?"/embed/":"/")+(t.game?t.game.id:t)+(e?"/"+e:"")}function _s(t,e){return $s(t)+"/continue/"+e}const Ns=t=>`${Math.floor((t.ply+1)/2)}${t.ply%2==1?". ":"... "}`;function Ds(t,e){if(0===t.children.length)return"";let n="";const o=t.children[0];(e||o.ply%2==1)&&(n+=Ns(o)),n+=Dt(o.san);for(let s=1;s<t.children.length;s++){const e=t.children[s];n+=` (${Ns(e)}${Dt(e.san)}`;const o=Ds(e,!1);o&&(n+=" "+o),n+=")"}const r=Ds(o,t.children.length>1);return r&&(n+=" "+r),n}function Os(t){const e=t.data.game;let n=Ds(t.tree.root,!0);const o=[];return"standard"!==e.variant.key&&o.push(["Variant",e.variant.name]),e.initialFen&&"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"!==e.initialFen&&o.push(["FEN",e.initialFen]),o.length&&(n=o.map((function(t){return"["+t[0]+' "'+t[1]+'"]'})).join("\n")+"\n\n"+n),n}function qs(t){if(!t[0])return[];if(t[0].san||(t=t.slice(1)),!t[0])return[];const e=[];return t[0].ply%2==0&&e.push(m("index",Math.floor((t[0].ply+1)/2)+"...")),t.forEach((t=>{0!==t.ply&&(t.ply%2==1&&e.push(m("index",(t.ply+1)/2+".")),e.push(m("san",Dt(t.san))))})),e}const Ls=[{name:"fast",delay:1e3},{name:"slow",delay:5e3}],Rs={name:"realtimeReplay",delay:"realtime"},Fs={name:"byCPL",delay:"cpl"};function Bs(t,e){const n=t.data.game;if("import"===n.source&&n.importedBy&&n.importedBy===e)return m("form.delete",{attrs:{method:"post",action:`/${n.id}/delete`},hook:S("submit",(e=>confirm(t.trans.noarg("deleteThisImportedGame"))))},[m("button.button.text.button-thin.button-red",{attrs:{type:"submit","data-icon":""}},t.trans.noarg("delete"))])}function zs(t){const e=t.data;return m("div.autoplay",[...Ls,..."correspondence"===e.game.speed||D(e.game.moveCentis)?[]:[Rs],...e.analysis?[Fs]:[]].map((e=>{const n=t.autoplay.getDelay()==e.delay;return m("a.button",{class:{active:n,"button-empty":!n},hook:P("click",(()=>t.togglePlay(e.delay)),t.redraw)},t.trans.noarg(e.name))})))}function js(t,e){return{insert:n=>{const o=n.elm;o.value=""+t(),o.addEventListener("input",(t=>e(parseInt(o.value)))),o.addEventListener("mouseout",(t=>o.blur()))}}}function Gs(t,e){return m("input",{attrs:{type:"hidden",name:t,value:e}})}function Vs(t){return t.study&&t.embed&&!t.ongoing?m("a.button.button-empty",{attrs:{href:"/study/"+t.study.data.id+"#"+t.study.currentChapter().id,target:"_blank",rel:"noopener","data-icon":""}},t.trans.noarg("openStudy")):t.study||t.ongoing||t.embed?void 0:m("form",{attrs:{method:"post",action:"/study/as"},hook:P("submit",(e=>{const n=e.target.querySelector("input[name=pgn]");n&&(n.value=Os(t))}))},[t.synthetic?Gs("pgn",""):Gs("gameId",t.data.game.id),Gs("orientation",t.chessground.state.orientation),Gs("variant",t.data.game.variant.key),Gs("fen",t.tree.root.fen),m("button.button.button-empty",{attrs:{type:"submit","data-icon":""}},t.trans.noarg("toStudy"))])}class Hs{constructor(){this.open=!1,this.toggle=()=>{this.open=!this.open}}}function Us(t){const e=t.data,n=t.trans.noarg,o=!t.ongoing&&!t.embed&&"standard"===e.game.variant.key,r=t.getCeval(),s=t.mandatoryCeval(),i=[m("div.action-menu__tools",[m("a.button.button-empty",{hook:P("click",t.flip),attrs:{"data-icon":"",title:"Hotkey: f"}},n("flipBoard")),t.ongoing?null:m("a.button.button-empty",{attrs:{href:e.userAnalysis?"/editor?"+new URLSearchParams({fen:t.node.fen,variant:e.game.variant.key}):`/${e.game.id}/edit?fen=${t.node.fen}`,"data-icon":"",...t.embed?{target:"_blank",rel:"noopener nofollow"}:{rel:"nofollow"}}},n("boardEditor")),o?m("a.button.button-empty",{hook:P("click",(t=>fe({content:$(".continue-with.g_"+e.game.id)}))),attrs:A("")},n("continueFromHere")):null,Vs(t)])],a=("external"==(null==r?void 0:r.technology)?"Engine":"Browser")+" does not support this option",c=r&&r.possible&&r.allowed()?[m("h2",n("computerAnalysis"))].concat([Ws({name:"enable",title:(s?"Required by practice mode":"Stockfish")+" (Hotkey: z)",id:"all",checked:t.showComputer(),disabled:s,change:t.toggleComputer},t)]).concat(t.showComputer()?[Ws({name:"bestMoveArrow",title:"Hotkey: a",id:"shapes",checked:t.showAutoShapes(),change:t.toggleAutoShapes},t),Ws({name:"evaluationGauge",id:"gauge",checked:t.showGauge(),change:t.toggleGauge},t),Ws({name:"Annotations on board",title:"Display analysis symbols on the board",id:"move-annotation",checked:t.showMoveAnnotation(),change:t.toggleMoveAnnotation},t),Ws({name:"infiniteAnalysis",title:"removesTheDepthLimit",id:"infinite",checked:r.infinite(),change:t.cevalSetInfinite},t),"external"!=r.technology?Ws({name:"Use NNUE",title:r.supportsNnue?"Downloads 6 MB neural network evaluation file (page reload required after change)":a,id:"enable-nnue",checked:r.supportsNnue&&r.enableNnue(),change:r.enableNnue,disabled:!r.supportsNnue},t):null,(l="analyse-multipv",m("div.setting",[m("label",{attrs:{for:l}},n("multipleLines")),m("input#"+l,{attrs:{type:"range",min:0,max:5,step:1},hook:js((()=>parseInt(r.multiPv())),t.cevalSetMultiPv)}),m("div.range_value",r.multiPv()+" / 5")])),(e=>m("div.setting",[m("label",{attrs:{for:e}},n("cpus")),m("input#"+e,{attrs:{type:"range",min:1,max:r.maxThreads,step:1,disabled:r.maxThreads<=1,...r.maxThreads<=1?{title:a}:null},hook:js((()=>r.threads()),t.cevalSetThreads)}),m("div.range_value",`${r.threads?r.threads():1} / ${r.maxThreads}`)]))("analyse-threads"),(e=>{return m("div.setting",[m("label",{attrs:{for:e}},n("memory")),m("input#"+e,{attrs:{type:"range",min:4,max:Math.floor(Math.log2(r.maxHashSize)),step:1,disabled:r.maxHashSize<=16,...r.maxHashSize<=16?{title:a}:null},hook:js((()=>Math.floor(Math.log2(r.hashSize()))),(e=>t.cevalSetHashSize(Math.pow(2,e))))}),m("div.range_value",(o=r.hashSize(),o<1e3?o+"MB":Math.round(o/1024)+"GB"))]);var o})("analyse-memory"),"external"==r.technology?m("div.setting",[m("label","External engine"),m("button.button.text.button-thin.button-red",{attrs:{"data-icon":""},hook:S("click",(()=>{confirm("Disconnect external engine and reload?")&&(r.disconnectExternalEngine(),lichess.reload())}))},"Disconnect")]):null]:[]):[];var l;const d=[Ws({name:n("inlineNotation"),title:"Shift+I",id:"inline",checked:t.treeView.inline(),change(e){t.treeView.set(e),t.actionMenu.toggle()}},t)];return m("div.action-menu",i.concat(d).concat(c).concat(t.mainline.length>4?[m("h2",n("replayMode")),zs(t)]:[]).concat([Bs(t,t.opts.userId),o?m("div.continue-with.none.g_"+e.game.id,[m("a.button",{attrs:{href:e.userAnalysis?"/?fen="+t.encodeNodeFen()+"#ai":_s(e,"ai")+"?fen="+t.node.fen,rel:"nofollow"}},n("playWithTheMachine")),m("a.button",{attrs:{href:e.userAnalysis?"/?fen="+t.encodeNodeFen()+"#friend":_s(e,"friend")+"?fen="+t.node.fen,rel:"nofollow"}},n("playWithAFriend"))]):null]))}function Ws(t,e){return Is(t,e.trans,e.redraw)}function Ks(t){const e={};return t&&(e[t]=!0),m("move.empty",{class:e},"...")}function Js(t,e,n){const o=e.children,r=o[0];if(!r)return;const s=n.noConceal?null:n.conceal||t.concealOf(!0)(n.parentPath+r.id,r);if("hide"!==s){if(n.isMainline){const e=r.ply%2==1,i=Zs(t,r,s,!0).filter(Ni);if(!o[1]&&D(i)&&!r.forceVariation)return(e?[$r(r.ply,!1)]:[]).concat(Qs(t,r,{parentPath:n.parentPath,isMainline:!0,conceal:s})||[]);const a=r.forceVariation?void 0:Js(t,r,{parentPath:n.parentPath+r.id,isMainline:!0,conceal:s}),c={parentPath:n.parentPath,isMainline:!r.forceVariation,conceal:s};return(e?[$r(r.ply,!1)]:[]).concat(r.forceVariation?[]:[Xs(t,r,c),e?Ks(c.conceal):null]).concat([m("interrupt",i.concat(Ys(t,r.forceVariation?o:o.slice(1),{parentPath:n.parentPath,isMainline:c.isMainline,conceal:s,noConceal:!s})))]).concat(e&&a?[$r(r.ply,!1),Ks(c.conceal)]:[]).concat(a||[])}return o[1]?function(t,e,n){if(!e[1]||e[2])return;if(re(e[1],6))return;return Qs(t,e[0],{parentPath:n.parentPath,isMainline:!1,noConceal:n.noConceal,inline:e[1]})}(t,o,n)||[Ys(t,o,n)]:Qs(t,r,n)}}function Ys(t,e,n){return m("lines",{class:{single:!e[1]}},e.map((e=>Ii(t,e)||m("line",Qs(t,e,{parentPath:n.parentPath,isMainline:!1,withIndex:!0,noConceal:n.noConceal,truncate:e.comp&&!Ut(t.ctrl.path,n.parentPath+e.id)?3:void 0})))))}function Xs(t,e,n){return n.isMainline?function(t,e,n){const o=n.parentPath+e.id,r=Pi(t,e,o);n.conceal&&(r[n.conceal]=!0);return m("move",{attrs:{p:o},class:r},_r(t,e))}(t,e,n):function(t,e,n){const o=n.withIndex||e.ply%2==1,r=n.parentPath+e.id,s=[o?$r(e.ply,!0):null,Dt(e.san)],i=Pi(t,e,r);n.conceal&&(i[n.conceal]=!0);e.glyphs&&e.glyphs.forEach((t=>s.push(Ar(t))));return m("move",{attrs:{p:r},class:i},s)}(t,e,n)}function Qs(t,e,n){const o=n.parentPath+e.id;return 0===n.truncate?[m("move",{attrs:{p:o}},[m("index","[...]")])]:[Xs(t,e,n)].concat(Ei(t,e)).concat(n.inline?function(t,e,n){return m("inline",Qs(t,e,{withIndex:!0,parentPath:n.parentPath,isMainline:!1,noConceal:n.noConceal,truncate:n.truncate}))}(t,n.inline,n):null).concat(Js(t,e,{parentPath:o,isMainline:n.isMainline,noConceal:n.noConceal,truncate:n.truncate?n.truncate-1:void 0})||[])}function Zs(t,e,n,o){if(!t.ctrl.showComments||D(e.comments))return[];const r=o?e.ply%2==0?".black ":".white ":"";return e.comments.map((o=>{if("lichess"===o.by&&!t.showComputer)return;let s="comment"+r;o.text.startsWith("Inaccuracy.")?s+=".inaccuracy":o.text.startsWith("Mistake.")?s+=".mistake":o.text.startsWith("Blunder.")&&(s+=".blunder"),n&&(s+="."+n);const i=e.comments[1]?`<span class="by">${jn(o.by)}</span>`:"";return m(s,{hook:ct(Ai(o.text,400,t),(t=>i+dt(t)))})}))}const ti=function(){return function(){return null}};function ei(t){return m("select.selector",{hook:P("change",(t=>{location.href="/practice/"+t.target.value}))},[m("option",{attrs:{disabled:!0,selected:!0}},"Practice list"),...t.structure.map((t=>m("optgroup",{attrs:{label:t.name}},t.studies.map((e=>Ne(t.id+"/"+e.slug+"/"+e.id,"",e.name))))))])}function ni(t,e){const n=t.goal();switch(n.result){case"mate":return"Checkmate the opponent";case"mateIn":return"Checkmate the opponent in "+Ie("move",e);case"drawIn":return"Hold the draw for "+Ie("more move",e);case"equalIn":return"Equalize in "+Ie("move",e);case"evalIn":return t.isWhite()===n.cp>=0?"Get a winning position in "+Ie("move",e):"Defend for "+Ie("move",e);case"promotion":return"Safely promote your pawn";default:return}}function oi(t){const e=t.currentChapter(),n=t.practice.data;return m("div.practice__side",[m("div.practice__side__title",[m("i."+n.study.id),m("div.text",[m("h1",n.study.name),m("em",n.study.desc)])]),m("div.practice__side__chapters",{hook:S("click",(e=>{e.preventDefault();const n=e.target,o=n.parentNode.getAttribute("data-id")||n.getAttribute("data-id");return o&&t.setChapter(o,!0),!1}))},t.chapters.list().map((function(o){const r=t.vm.loading&&o.id===t.vm.nextChapterId,s=!t.vm.loading&&e&&e.id===o.id,i=n.completion[o.id]>=0?"done":"ongoing";return[m("a.ps__chapter",{key:o.id,attrs:{href:n.url+"/"+o.id,"data-id":o.id},class:{active:s,loading:r}},[m("span.status."+i,{attrs:{"data-icon":(r||s)&&"ongoing"===i?"":""}}),m("h3",o.name)])]})).reduce(((t,e)=>t.concat(e)),[])),m("div.finally",[m("a.back",{attrs:{"data-icon":"",href:"/practice",title:"More practice"}}),b("select.selector",ei,[n])])])}function ri(t){const e=t.study,n=e.gamebookPlay();if(!n)return;const o="play"===n.state.feedback;return m("div.gamebook-buttons",[t.path?m("button.fbt.text.back",{attrs:{"data-icon":"",type:"button"},hook:P("click",(()=>t.userJump("")),n.redraw)},t.trans.noarg("back")):null,o?m("button.fbt.text.solution",{attrs:{"data-icon":"",type:"button"},hook:P("click",n.solution,n.redraw)},t.trans.noarg("viewTheSolution")):void 0,si(e)])}function si(t){if(t.data.chapter.gamebook){const e=t.vm.gamebookOverride;if(t.members.canContribute())return m("button.fbt.text.preview",{class:{active:"play"===e},attrs:{"data-icon":"",type:"button"},hook:P("click",(()=>{t.setGamebookOverride("play"===e?void 0:"play")}),t.redraw)},"Preview");{const n="analyse"===e,o=t.gamebookPlay();if(n||o&&"end"===o.state.feedback)return m("a.fbt.text.preview",{class:{active:n},attrs:A(""),hook:P("click",(()=>{t.setGamebookOverride(n?void 0:"analyse")}),t.redraw)},t.trans.noarg("analysis"))}}}const ii=t=>m("div.relay-tour__text__schedule",[m("h2","Schedule"),m("table.slist.slist-invert",m("tbody",t.data.rounds.map((e=>m("tr",[m("th",m("a.link",{attrs:{href:t.roundPath(e)}},e.name)),m("td",e.startsAt?lichess.dateFormat()(new Date(e.startsAt)):void 0),m("td",ai(e)||(e.startsAt?lichess.timeago(e.startsAt):void 0))])))))]),ai=t=>t.ongoing?m("ongoing",{attrs:{...A(""),title:"Ongoing"}}):t.finished?m("finished",{attrs:{...A(""),title:"Finished"}}):null;function ci(t){return m("span."+t.tab,{attrs:{role:"tab",title:t.hint},class:{active:t.tab===t.ctrl.vm.toolTab()},hook:P("mousedown",(()=>{t.onClick&&t.onClick(),t.ctrl.vm.toolTab(t.tab)}),t.ctrl.redraw)},[t.count?m("count.data-count",{attrs:{"data-count":t.count}}):null,t.icon])}function li(t){const e=t.study,n=e.members.canContribute(),o=e.data.features.sticky&&(n||e.vm.behind&&e.isUpdatedRecently()),r=t.trans.noarg;return m("div.study__buttons",[m("div.left-buttons.tabs-horiz",{attrs:{role:"tablist"}},[o?m("a.mode.sync",{attrs:{title:r("allSyncMembersRemainOnTheSamePosition")},class:{on:e.vm.mode.sticky},hook:P("click",e.toggleSticky)},[e.vm.behind?m("span.behind",""+e.vm.behind):m("i.is"),"SYNC"]):null,e.members.canContribute()?m("a.mode.write",{attrs:{title:r("shareChanges")},class:{on:e.vm.mode.write},hook:P("click",e.toggleWrite)},[m("i.is"),"REC"]):null,ci({ctrl:e,tab:"tags",hint:r("pgnTags"),icon:Ae("")}),ci({ctrl:e,tab:"comments",hint:r("commentThisPosition"),icon:Ae(""),onClick(){e.commentForm.start(e.vm.chapterId,t.path,t.node)},count:(t.node.comments||[]).length}),n?ci({ctrl:e,tab:"glyphs",hint:r("annotateWithGlyphs"),icon:m("i.glyph-icon"),count:(t.node.glyphs||[]).length}):null,ci({ctrl:e,tab:"serverEval",hint:r("computerAnalysis"),icon:Ae(""),count:t.data.analysis&&"✓"}),ci({ctrl:e,tab:"multiBoard",hint:"Multiboard",icon:Ae("")}),ci({ctrl:e,tab:"share",hint:r("shareAndExport"),icon:Ae("")}),e.relay?null:m("span.help",{attrs:{title:"Need help? Get the tour!","data-icon":""},hook:P("click",e.startTour)})]),m("div.right",[si(e)])])}function di(t){var e;const n=t.data,o=null===(e=t.relay)||void 0===e?void 0:e.data.tour.credit,r=`${n.name}: ${t.currentChapter().name}`;return m("div.study__metadata",[m("h2",[m("span.name",{attrs:{title:r}},[r,o?m("span.credit",{hook:ht(o,!1)}):void 0]),m("span.liking.text",{class:{liked:n.liked},attrs:{"data-icon":n.liked?"":"",title:t.trans.noarg(n.liked?"unlike":"like")},hook:P("click",t.toggleLike)},""+n.likes)]),Jn(t),Fr(t)])}function hi(t){var e;const n=t.vm.tab(),o=null===(e=t.relay)||void 0===e?void 0:e.tourShow,r=(e,r)=>m("span."+e,{class:{active:!(null==o?void 0:o.active)&&n===e},attrs:{role:"tab"},hook:P("mousedown",(()=>{null==o||o.disable(),t.vm.tab(e)}),t.redraw)},r),s=o&&m("span.relay-tour.text",{class:{active:o.active},hook:P("mousedown",(()=>{o.active=!0}),t.redraw),attrs:{"data-icon":"",role:"tab"}},"Broadcast"),i=m("div.tabs-horiz",{attrs:{role:"tablist"}},[s,o&&t.looksNew()&&!t.members.canContribute()?null:r("chapters",t.trans.plural(t.relay?"nbGames":"nbChapters",t.chapters.size())),!s||t.members.canContribute()||t.data.admin?r("members",t.trans.plural("nbMembers",t.members.size())):null,t.members.isOwner()?m("span.more",{attrs:{role:"tab"},hook:P("click",(()=>t.form.open(!t.form.open())),t.redraw)},[Ae("")]):null]),a=(null==o?void 0:o.active)?function(t){const e=t.members.canContribute(),n=t.relay;return m("div.study__relay__rounds",n.data.rounds.map((o=>m("div",{key:o.id,class:{active:t.data.id==o.id}},[m("a.link",{attrs:{href:n.roundPath(o)}},o.name),ai(o),e?m("a.act",{attrs:{...A(""),href:`/broadcast/round/${o.id}/edit`}}):null]))).concat(e?[m("div.add",m("a.text",{attrs:{href:`/broadcast/${n.data.tour.id}/new`,"data-icon":""}},t.trans.noarg("addRound")))]:[]))}(t):("members"===n?Le:On)(t);return m("div.study__side",[i,a])}function ui(t){return t.chapters.newForm.vm.open?function(t){const e=t.root.trans,n=t.root.study,o=t.vm.tab(),r=function(e,n,r){return m("span."+e,{class:{active:o===e},attrs:{role:"tab",title:r},hook:P("click",(()=>t.vm.tab(e)),t.root.redraw)},n)},s="game"===o||"pgn"===o,i=n.data.chapter,a=i.practice?"practice":_(i.conceal)?"conceal":i.gamebook?"gamebook":"normal",c=e.noarg;return ge({class:"chapter-new",onClose(){t.close(),t.redraw()},noClickAway:!0,content:["edit"===o?null:m("h2",[c("newChapter"),m("i.help",{attrs:{"data-icon":""},hook:P("click",t.startTour)})]),m("form.form3",{hook:E((e=>{t.submit({name:En(e,"name"),game:En(e,"game"),variant:En(e,"variant"),pgn:En(e,"pgn"),orientation:En(e,"orientation"),mode:En(e,"mode"),fen:En(e,"fen")||("edit"===t.vm.tab()?t.vm.editorFen():null),isDefaultName:t.vm.isDefaultName})}),t.redraw)},[m("div.form-group",[m("label.form-label",{attrs:{for:"chapter-name"}},c("name")),m("input#chapter-name.form-control",{attrs:{minlength:2,maxlength:80},hook:M((n=>{n.value||(n.value=e("chapterX",t.vm.initial()?1:t.chapters().length+1),n.onchange=function(){t.vm.isDefaultName=!1},n.select(),n.focus())}))})]),m("div.tabs-horiz",{attrs:{role:"tablist"}},[r("init",c("empty"),c("startFromInitialPosition")),r("edit",c("editor"),c("startFromCustomPosition")),r("game","URL",c("loadAGameByUrl")),r("fen","FEN",c("loadAPositionFromFen")),r("pgn","PGN",c("loadAGameFromPgn"))]),"edit"===o?m("div.board-editor-wrap",{hook:{insert(e){Promise.all([lichess.loadModule("editor"),z("/editor.json")]).then((([n,o])=>{o.fen=t.root.node.fen,o.embed=!0,o.options={inlineCastling:!0,orientation:i.setup.orientation,onChange:t.vm.editorFen},t.vm.editor=window.LichessEditor(e.elm,o),t.vm.editorFen(t.vm.editor.getFen())}))},destroy:e=>{t.vm.editor=null}}},[ke()]):null,"game"===o?m("div.form-group",[m("label.form-label",{attrs:{for:"chapter-game"}},e("loadAGameFromXOrY","lichess.org","chessgames.com")),m("textarea#chapter-game.form-control",{attrs:{placeholder:c("urlOfTheGame")},hook:M((t=>{t.addEventListener("change",(()=>t.reportValidity())),t.addEventListener("input",(e=>{const n=t.value.trim().split("\n").every((t=>t.trim().match(new RegExp(`^((.*${location.host}/\\w{8,12}.*)|\\w{8}|\\w{12}|(.*chessgames\\.com/.*[?&]gid=\\d+.*)|)$`))));t.setCustomValidity(n?"":"Invalid game ID(s) or URL(s)")}))}))})]):null,"fen"===o?m("div.form-group",[m("input#chapter-fen.form-control",{attrs:{value:t.root.node.fen,placeholder:c("loadAPositionFromFen")},hook:M((t=>{t.addEventListener("change",(()=>t.reportValidity())),t.addEventListener("input",(e=>t.setCustomValidity(wn(t.value.trim()).isOk?"":"Invalid FEN")))}))})]):null,"pgn"===o?m("div.form-group",[m("textarea#chapter-pgn.form-control",{attrs:{placeholder:e.plural("pasteYourPgnTextHereUpToNbGames",t.multiPgnMax)}}),m("a.button.button-empty",{hook:P("click",(()=>{G(`/study/${n.data.id}/${i.id}.pgn`).then((t=>$("#chapter-pgn").val(t)))}))},e("importFromChapterX",n.currentChapter().name)),window.FileReader?m("input#chapter-pgn-file.form-control",{attrs:{type:"file",accept:".pgn"},hook:P("change",(t=>{const e=t.target.files[0];if(!e)return;const n=new FileReader;n.onload=function(){document.getElementById("chapter-pgn").value=n.result},n.readAsText(e)}))}):null]):null,m("div.form-split",[m("div.form-group.form-half",[m("label.form-label",{attrs:{for:"chapter-variant"}},c("Variant")),m("select#chapter-variant.form-control",{attrs:{disabled:s}},s?[m("option",{attrs:{value:"standard"}},c("automatic"))]:t.vm.variants.map((t=>Ne(t.key,i.setup.variant.key,t.name))))]),m("div.form-group.form-half",[m("label.form-label",{attrs:{for:"chapter-orientation"}},c("orientation")),m("select#chapter-orientation.form-control",{hook:P("change",(e=>{t.vm.editor&&t.vm.editor.setOrientation(e.target.value)}))},[..."pgn"===o?["automatic"]:[],"white","black"].map((t=>Ne(t,i.setup.orientation,c(t)))))])]),m("div.form-group",[m("label.form-label",{attrs:{for:"chapter-mode"}},c("analysisMode")),m("select#chapter-mode.form-control",Sn.map((t=>Ne(t[0],a,c(t[1])))))]),m("div.form-actions.single",m("button.button",{attrs:{type:"submit"}},c("createChapter")))])]})}(t.chapters.newForm):t.chapters.editForm.current()?function(t){const e=t.current(),n=t.trans.noarg;return e?ge({class:"edit-"+e.id,onClose(){t.current(null),t.redraw()},content:[m("h2",n("editChapter")),m("form.form3",{hook:E((e=>{t.submit({name:En(e,"name"),mode:En(e,"mode"),orientation:En(e,"orientation"),description:En(e,"description")})}),t.redraw)},[m("div.form-group",[m("label.form-label",{attrs:{for:"chapter-name"}},n("name")),m("input#chapter-name.form-control",{attrs:{minlength:2,maxlength:80},hook:M((t=>{t.value||(t.value=e.name,t.select(),t.focus())}))})]),...Tn(e)?In(t,e):[ke()]])]}):void 0}(t.chapters.editForm):t.members.inviteForm.open()?function(t){const e=t.spectators().filter((e=>!t.members()[$e(e)])).sort();return ge({class:"study__invite",onClose(){t.open(!1),t.redraw()},content:[m("h2",t.trans.noarg("inviteToTheStudy")),m("p.info",{attrs:{"data-icon":""}},t.trans.noarg("pleaseOnlyInvitePeopleYouKnow")),m("div.input-wrapper",[m("input",{attrs:{placeholder:t.trans.noarg("searchByUsername")},hook:M((e=>lichess.userComplete().then((n=>{n({input:e,tag:"span",onSelect(n){e.value="",t.invite(n.name),t.redraw()}}),e.focus()}))))})]),e.length?m("div.users",e.map((function(e){return m("span.button.button-metal",{key:e,hook:P("click",(n=>t.invite(e)))},e)}))):void 0]})}(t.members.inviteForm):t.topics.open()?Xn(t.topics,t.members.myId):t.form.open()?function(t){const e=t.getData(),n=t.isNew(),o=(t,o)=>{const r=t.elm;o||r.value||(r.value=e.name,n&&r.select(),r.focus())},r=[["nobody",t.trans.noarg("nobody")],["owner",t.trans.noarg("onlyMe")],["contributor",t.trans.noarg("contributors")],["member",t.trans.noarg("members")],["everyone",t.trans.noarg("everyone")]];return ge({class:"study-edit",onClose(){t.open(!1),t.redraw()},content:[m("h2",t.trans.noarg(t.relay?"configureLiveBroadcast":n?"createStudy":"editStudy")),m("form.form3",{hook:E((e=>{const o=t=>{const n=e.target.querySelector("#study-"+t);if(n)return n.value;throw`Missing form input: ${t}`};t.save({name:o("name"),visibility:o("visibility"),computer:o("computer"),explorer:o("explorer"),cloneable:o("cloneable"),chat:o("chat"),sticky:o("sticky"),description:o("description")},n)}),t.redraw)},[m("div.form-group"+(t.relay?".none":""),[m("label.form-label",{attrs:{for:"study-name"}},t.trans.noarg("name")),m("input#study-name.form-control",{attrs:{minlength:3,maxlength:100},hook:{insert:t=>o(t,!1),postpatch:(t,e)=>o(e,!0)}})]),m("div.form-split",[m("div.form-group.form-half",Kn({key:"visibility",name:t.trans.noarg("visibility"),choices:[["public",t.trans.noarg("public")],["unlisted",t.trans.noarg("unlisted")],["private",t.trans.noarg("inviteOnly")]],selected:e.visibility})),m("div.form-group.form-half",Kn({key:"cloneable",name:t.trans.noarg("allowCloning"),choices:r,selected:e.settings.cloneable}))]),m("div.form-split",[m("div.form-group.form-half",Kn({key:"computer",name:t.trans.noarg("computerAnalysis"),choices:r.map((e=>[e[0],t.trans.noarg(e[1])])),selected:e.settings.computer})),m("div.form-group.form-half",Kn({key:"explorer",name:t.trans.noarg("openingExplorerAndTablebase"),choices:r,selected:e.settings.explorer}))]),m("div.form-split",[m("div.form-group.form-half",Kn({key:"chat",name:t.trans.noarg("chat"),choices:r,selected:e.settings.chat})),m("div.form-group.form-half",Kn({key:"sticky",name:t.trans.noarg("enableSync"),choices:[["true",t.trans.noarg("yesKeepEveryoneOnTheSamePosition")],["false",t.trans.noarg("noLetPeopleBrowseFreely")]],selected:""+e.settings.sticky}))]),m("div.form-group.form-half",Kn({key:"description",name:t.trans.noarg("pinnedStudyComment"),choices:[["false",t.trans.noarg("noPinnedComment")],["true",t.trans.noarg("rightUnderTheBoard")]],selected:""+e.settings.description})),t.relay?m("div.form-actions-secondary",[m("a.text",{attrs:{"data-icon":"",href:`/broadcast/${t.relay.data.tour.id}/edit`}},"Tournament settings"),m("a.text",{attrs:{"data-icon":"",href:`/broadcast/round/${e.id}/edit`}},"Round settings")]):null,m("div.form-actions",[m("div",{attrs:{style:"display: flex"}},[m("form",{attrs:{action:"/study/"+e.id+"/delete",method:"post"},hook:S("submit",(o=>{var r;return n||(null===(r=prompt(t.trans("confirmDeleteStudy",e.name)))||void 0===r?void 0:r.trim())===e.name.trim()}))},[m(Se,t.trans.noarg(n?"cancel":"deleteStudy"))]),n?null:m("form",{attrs:{action:"/study/"+e.id+"/clear-chat",method:"post"},hook:S("submit",(e=>confirm(t.trans.noarg("deleteTheStudyChatHistory"))))},[m(Se,t.trans.noarg("clearChat"))])]),m("button.button",{attrs:{type:"submit"}},t.trans.noarg(n?"start":"save"))])])]})}(t.form):void 0}function pi(t){if(t.embed)return[];if(t.studyPractice)return function(t){if(t.vm.loading)return[m("div.feedback",ke())];const e=t.practice,n=t.gamebookPlay(),o=t.data.chapter.description;if(n)return o?[m("div.feedback.ongoing",[m("div.comment",{hook:ht(o)})])]:[];if(!t.data.chapter.practice)return[vs(t,!0)];switch(e.success()){case!0:return[m("a.feedback.win",t.nextChapter()?{hook:P("click",t.goToNextChapter)}:{attrs:{href:"/practice"}},[m("span","Success!"),t.nextChapter()?"Go to next exercise":"Back to practice menu"])];case!1:return[m("a.feedback.fail",{hook:P("click",e.reset,t.redraw)},[m("span",[ni(e,e.goal().moves)]),m("strong","Click to retry")])];default:return[m("div.feedback.ongoing",[m("div.goal",[ni(e,e.goal().moves-e.nbMoves())]),o?m("div.comment",{hook:ht(o)}):null]),Is({name:"Load next exercise immediately",id:"autoNext",checked:e.autoNext(),change:e.autoNext},t.trans,t.redraw)]}}(t.study);const e=t.study,n=e.vm.toolTab();if(e.gamebookPlay())return[ri(t),vs(e,!0),vs(e,!1),di(e)];let o;switch(n){case"tags":o=di(e);break;case"comments":o=e.vm.mode.write?function(t){const e=t.study,n=e.commentForm,o=n.current();if(!o)return Vn(t,"Select a move to comment");const r=(t,e)=>{const r=t.elm,s=o.chapterId+o.path;if((null==e?void 0:e.data.path)!==s){const t=(o.node.comments||[]).find((function(t){return zn(t.by)&&t.by.id&&t.by.id===n.root.opts.userId}));r.value=t?t.text:""}t.data.path=s,n.opening()&&(requestAnimationFrame((()=>r.focus())),n.opening(!1))};return m("div.study__comments",{hook:M((()=>t.enableWiki(!0)))},[Gn(t,!e.members.canContribute()),m("form.form3",[m("textarea#comment-text.form-control",{hook:{insert(t){r(t);const e=t.elm;e.oninput=()=>setTimeout((()=>n.submit(e.value)),50);const o=lichess.storage.make("study.comment.height");e.onmouseup=()=>o.set(""+e.offsetHeight),e.style.height=parseInt(o.get()||"80")+"px"},postpatch:(t,e)=>r(e,t)}})]),m("div.analyse__wiki.study__wiki")])}(t):Vn(t,e.members.canContribute()?"Press REC to comment moves":"Only the study members can comment on moves");break;case"glyphs":o=t.path?e.vm.mode.write?function(t){const e=t.all(),n=t.root.node;return m("div.study__glyphs"+(e?"":".empty"),{hook:{insert:t.loadGlyphs}},e?[m("div.move",e.move.map(Hn(t,n))),m("div.position",e.position.map(Hn(t,n))),m("div.observation",e.observation.map(Hn(t,n)))]:[m("div.study__message",ke())])}(e.glyphForm):Wn("Press REC to annotate moves"):Wn("Select a move to annotate");break;case"serverEval":o=zr(e.serverEval);break;case"share":o=function(t){const e=t.studyId,n=t.chapter(),o=t.isPrivate(),r=e=>t.onMainline()?t.withPly()?`${e}#${t.currentNode().ply}`:e:`${e}#last`;return m("div.study__share",[m("div.downloads",[t.cloneable?m("a.button.text",{attrs:{"data-icon":"",href:`/study/${e}/clone`}},t.trans.noarg("cloneStudy")):null,t.relay&&m("a.button.text",{attrs:{"data-icon":"",href:`/api/broadcast/${t.relay.data.tour.id}.pgn`,download:!0}},t.trans.noarg("downloadAllRounds")),m("a.button.text",{attrs:{"data-icon":"",href:t.relay?`${t.relay.roundPath()}.pgn`:`/study/${e}.pgn`,download:!0}},t.trans.noarg(t.relay?"downloadAllGames":"studyPgn")),m("a.button.text",{attrs:{"data-icon":"",href:`/study/${e}/${n.id}.pgn`,download:!0}},t.trans.noarg(t.relay?"downloadGame":"chapterPgn")),m("a.button.text",{attrs:{"data-icon":"",href:U(`/export/gif/${t.currentNode().fen.replace(/ /g,"_")}`,{color:t.bottomColor(),lastMove:t.currentNode().uci,variant:t.variantKey}),download:!0}},"Board"),m("a.button.text",{attrs:{"data-icon":"",href:`/study/${e}/${n.id}.gif`,download:!0}},"GIF")]),m("form.form3",[...(t.relay?[["broadcastUrl",t.relay.tourPath()],["currentRoundUrl",t.relay.roundPath()],["currentGameUrl",r(`${t.relay.roundPath()}/${n.id}`),!0]]:[["studyUrl",`/study/${e}`],["currentChapterUrl",r(`/study/${e}/${n.id}`),!0]]).map((([e,n,r])=>m("div.form-group",[m("label.form-label",t.trans.noarg(e)),m("input.form-control.autoselect",{attrs:{readonly:!0,value:`${_e()}${n}`}}),...r?[Dr(t),o?null:m("p.form-help.text",{attrs:{"data-icon":""}},t.trans.noarg("youCanPasteThisInTheForumToEmbed"))]:[]]))),m("div.form-group",[m("label.form-label",t.trans.noarg("embedInYourWebsite")),m("input.form-control.autoselect",{attrs:{readonly:!0,disabled:o,value:o?t.trans.noarg("onlyPublicStudiesCanBeEmbedded"):`<iframe width=600 height=371 src="${_e()}${r(`/study/embed/${e}/${n.id}`)}" frameborder=0></iframe>`}})].concat(o?[]:[Dr(t),m("a.form-help.text",{attrs:{href:"/developers#embed-study",target:"_blank",rel:"noopener","data-icon":""}},t.trans.noarg("readMoreAboutEmbedding"))])),m("div.form-group",[m("label.form-label","FEN"),m("input.form-control.autoselect",{attrs:{readonly:!0,value:t.currentNode().fen}})])])])}(e.share);break;case"multiBoard":o=ks(e.multiBoard,e)}return[Qn(e.notif),vs(e,!0),vs(e,!1),li(t),o]}function mi(t,e){const n=t.offsetWidth+4,o=t.offsetHeight+4,r=window.innerWidth,s=window.innerHeight;t.style.left=r-e.x<n?r-n+"px":t.style.left=e.x+"px",t.style.top=s-e.y<o?s-o+"px":t.style.top=e.y+"px"}function fi(t,e,n){return m("a",{attrs:{"data-icon":t},hook:P("click",n)},e)}function gi(t,e){const n=t.root,o=n.tree.nodeAtPath(t.path),r=n.tree.pathIsMainline(t.path)&&!n.tree.pathIsForcedVariation(t.path),s=n.trans.noarg;return m("div#analyse-cm.visible",{hook:{...M((t=>{t.addEventListener("contextmenu",(t=>(t.preventDefault(),!1))),mi(t,e)})),postpatch:(t,n)=>mi(n.elm,e)}},[m("p.title",Te(o)),r?null:fi("",s("promoteVariation"),(()=>n.promote(t.path,!1))),r?null:fi("",s("makeMainLine"),(()=>n.promote(t.path,!0))),fi("",s("deleteFromHere"),(()=>n.deleteNode(t.path)))].concat(n.study?function(t,e,n){return t.vm.mode.write?[m("a",{attrs:A(""),hook:P("click",(()=>{t.vm.toolTab("comments"),t.commentForm.start(t.currentChapter().id,e,n)}))},t.trans.noarg("commentThisMove")),m("a.glyph-icon",{hook:P("click",(()=>{t.vm.toolTab("glyphs"),t.userJump(e)}))},t.trans.noarg("annotateWithGlyphs"))]:[]}(n.study,t.path,o):[]).concat([r?fi("",s("forceVariation"),(()=>n.forceVariation(t.path,!0))):null]))}function vi(t,e){let n=function(t){let e=t;return"touches"in t&&t.touches.length>0&&(e=t.touches[0]),e.pageX||e.pageY?{x:e.pageX,y:e.pageY}:e.clientX||e.clientY?{x:e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,y:e.clientY+document.body.scrollTop+document.documentElement.scrollTop}:null}(t);if(null===n){if(e.root.contextMenuPath)return;n={x:0,y:0}}const o=$("#analyse-cm")[0]||$('<div id="analyse-cm">').appendTo($("body"))[0];e.root.contextMenuPath=e.path,document.addEventListener("click",(function t(n){2!==n.button&&(e.root.contextMenuPath=void 0,document.removeEventListener("click",t,!1),$("#analyse-cm").removeClass("visible"),e.root.redraw())}),!1),o.innerHTML="",$d(o,gi(e,n))}function bi(t,e,n){const o=e.children,r=o[0];if(r)return n.isMainline?o[1]||r.forceVariation?yi(t,o,n)||[...r.forceVariation?[]:[Ci(t,r,{parentPath:n.parentPath,isMainline:!0,withIndex:n.withIndex}),...Ei(t,r)],m("interrupt",wi(t,r.forceVariation?o:o.slice(1),{parentPath:n.parentPath,isMainline:!0})),...r.forceVariation?[]:bi(t,r,{parentPath:n.parentPath+r.id,isMainline:!0,withIndex:!0})||[]]:ki(t,r,{parentPath:n.parentPath,isMainline:!0,withIndex:n.withIndex}):o[1]?yi(t,o,n)||[wi(t,o,n)]:ki(t,r,n)}function yi(t,e,n){if(e[1]&&!e[2]&&!e[0].forceVariation&&!re(e[1],6))return ki(t,e[0],{parentPath:n.parentPath,isMainline:n.isMainline,inline:e[1]})}function wi(t,e,n){return m("lines",e.map((e=>Ii(t,e)||m("line",ki(t,e,{parentPath:n.parentPath,isMainline:!1,withIndex:!0,truncate:e.comp&&!Ut(t.ctrl.path,n.parentPath+e.id)?3:void 0})))))}function ki(t,e,n){const o=n.parentPath+e.id,r=Ei(t,e);return 0===n.truncate?[m("move",{attrs:{p:o}},"[...]")]:[Ci(t,e,n)].concat(r).concat(n.inline?function(t,e,n){const o=Ii(t,e);return o?m("interrupt",m("lines",o)):m("inline",ki(t,e,{withIndex:!0,parentPath:n.parentPath,isMainline:!1}))}(t,n.inline,n):null).concat(bi(t,e,{parentPath:o,isMainline:n.isMainline,truncate:n.truncate?n.truncate-1:void 0,withIndex:!!r[0]})||[])}function Ci(t,e,n){const o=n.parentPath+e.id,r=[n.withIndex||1&e.ply?$r(e.ply,!0):null,Dt(e.san)];return e.glyphs&&t.showGlyphs&&e.glyphs.forEach((t=>r.push(Ar(t)))),m("move",{attrs:{p:o},class:Pi(t,e,o)},r)}let xi="init";function Mi(t,e){return!t.treeView.inline()&&("string"==typeof xi&&("init"==xi&&(window.addEventListener("resize",(()=>{xi="rec"})),navigator.userAgent.indexOf("Edge/")>-1&&requestAnimationFrame((()=>{xi="rec"}))),xi=!!getComputedStyle(document.body).getPropertyValue("--col1")),!xi)||e?function(t,e){const n=t.tree.root,o={ctrl:t,truncateComments:!t.embed,concealOf:e||ti,showComputer:t.showComputer()&&!t.retro,showGlyphs:!!t.study||t.showComputer(),showEval:t.showComputer(),currentPath:Si(t)},r=Zs(o,n,!1,!1);return m("div.tview2.tview2-column",{hook:Ti(t)},[D(r)?null:m("interrupt",r),1&n.ply?$r(n.ply,!1):null,1&n.ply?Ks():null].concat(Js(o,n,{parentPath:"",isMainline:!0})||[]))}(t,e):function(t){const e={ctrl:t,truncateComments:!1,showComputer:t.showComputer()&&!t.retro,showGlyphs:!!t.study||t.showComputer(),showEval:!!t.study||t.showComputer(),currentPath:Si(t)};return m("div.tview2.tview2-inline",{hook:Ti(t)},[...Ei(e,t.tree.root),...bi(e,t.tree.root,{parentPath:"",isMainline:!0})||[]])}(t)}function Pi(t,e,n){const o=t.showGlyphs&&e.glyphs?e.glyphs.map((t=>t.id)):[];return{active:n===t.ctrl.path,"context-menu":n===t.ctrl.contextMenuPath,current:n===t.currentPath,nongame:!t.currentPath&&!!t.ctrl.gamePath&&Ut(n,t.ctrl.gamePath)&&n!==t.ctrl.gamePath,inaccuracy:o.includes(6),mistake:o.includes(2),blunder:o.includes(4)}}function Si(t){let e;return!t.synthetic&&Ft(t.data)&&t.initialPath||t.retro&&(e=t.retro.current())&&e.prev.path||t.study&&t.study.data.chapter.relay&&t.study.data.chapter.relay.path}function Ei(t,e){return!t.ctrl.showComments||D(e.comments)?[]:e.comments.map((n=>{if("lichess"===n.by&&!t.showComputer)return;const o=e.comments[1]?`<span class="by">${jn(n.by)}</span>`:"";return m("comment",{hook:ct(Ai(n.text,300,t),(t=>o+dt(t)))})})).filter(Ni)}function Ai(t,e,n){return n.truncateComments&&t.length>e?t.slice(0,e-10)+" [...]":t}function Ti(t){return{insert:e=>{const n=e.elm;""!==t.path&&_i(t,n);const o=e=>{const n=$i(e);return null!==n&&vi(e,{path:n,root:t}),t.redraw(),!1};n.oncontextmenu=o,function(t,e,n){let o;t.addEventListener("touchstart",(t=>{o=setTimeout((()=>{e(t),n&&n()}),610)})),t.addEventListener("touchmove",(()=>{clearTimeout(o)})),t.addEventListener("touchcancel",(()=>{clearTimeout(o)})),t.addEventListener("touchend",(()=>{clearTimeout(o)}))}(n,o,t.redraw),n.addEventListener("mousedown",(e=>{if(_(e.button)&&0!==e.button)return;const n=$i(e);n&&t.userJump(n),t.redraw()}))},postpatch:(e,n)=>{t.autoScrollRequested&&(_i(t,n.elm),t.autoScrollRequested=!1)}}}function Ii(t,e){return e.comp&&t.ctrl.retro&&t.ctrl.retro.hideComputerLine(e)?m("line",t.ctrl.trans.noarg("learnFromThisMistake")):void 0}function $i(t){return t.target.getAttribute("p")||t.target.parentElement.getAttribute("p")}const _i=Oe(200,((t,e)=>{var n;const o=null===(n=e.parentElement)||void 0===n?void 0:n.parentElement;if(!o)return;const r=e.querySelector(".active");o.scrollTop=r?r.offsetTop-o.offsetHeight/2+r.offsetHeight:t.path?99999:0})),Ni=t=>!!t;function Di(t){const e={fen:t.fen,nodes:1e3*t.knodes,depth:t.depth,pvs:t.pvs.map((t=>{const e={moves:t.moves.split(" ")};return _(t.cp)?e.cp=t.cp:e.mate=t.mate,e})),cloud:!0};return _(e.pvs[0].cp)?e.cp=e.pvs[0].cp:e.mate=e.pvs[0].mate,e.cloud=!0,e}function Oi(t){let e={};const n=q(!1);return lichess.pubsub.on("socket.in.crowd",(t=>n(t.nb>2&&t.nb<99999))),{onCeval:Oe(500,(()=>{const n=t.getNode(),o=n.ceval,r=e[n.fen];o&&!o.cloud&&n.fen in e&&(!r||r.depth<o.depth)&&function(t){return t.nodes>5e5&&(t.depth>=20||t.nodes>3e6)}(o)&&t.canPut()&&t.send("evalPut",function(t,e){const n={fen:e.fen,knodes:Math.round(e.nodes/1e3),depth:e.depth,pvs:e.pvs.map((t=>({cp:t.cp,mate:t.mate,moves:t.moves.slice(0,10).join(" ")})))};return"standard"!==t&&(n.variant=t),n}(t.variant,o))})),fetch(o,r){const s=t.getNode();if(s.ceval&&s.ceval.cloud||!t.canGet())return;const i=e[s.fen];if(i)return t.receive(Di(i),o);if(s.fen in e)return;e[s.fen]=void 0;const a={fen:s.fen,path:o};"standard"!==t.variant&&(a.variant=t.variant),r>1&&(a.mpv=r),n()&&(a.up=!0),t.send("evalGet",a)},onCloudEval(n){e[n.fen]=n,t.receive(Di(n),n.path)},clear(){e={}}}}function qi(t,e,n){const o=`/${e.game.id}${e.player.id}/forecasts`;let r=t.steps||[];const s=q(!1);function i(t){return t.map((t=>t.ply+":"+t.uci)).join(",")}function a(t,e){return t.length>=e.length&&i(t).startsWith(i(e))}function c(t){return r.filter((e=>a(e,[t])))}function l(e){return t.onMyTurn?(e.length%2!=1?e.slice(0,-1):e).slice(0,30):(e.length%2!=0?e.slice(0,-1):e).slice(0,30)}function d(){r=r.filter((function(t,e){return 0===r.filter((function(n,o){return e!==o&&a(n,t)})).length})),r=r.filter((function(e,n){return 0===r.filter((function(o,r){return n<r&&function(e,n){for(let o=0,r=Math.min(e.length,n.length);o<r;o++)if(e[o].uci!==n[o].uci)return t.onMyTurn?0!==o&&o%2==0:o%2==1;return!0}(o,e)})).length}))}function h(){s(!0),n(),history.replaceState(null,"","#last"),lichess.reload()}function u(e){if(!function(e){return e.length>=(t.onMyTurn?1:2)}(e=l(e)))return!1;return!r.filter((t=>a(t,e))).length}function p(){t.onMyTurn||(s(!0),n(),z(o,{method:"POST",body:JSON.stringify(r),headers:{"Content-Type":"application/json"}}).then((t=>{t.reload?h():(s(!1),r=t.steps||[]),n()})))}return d(),{addNodes(t){u(t=l(t))&&(r.push(t),d(),p())},isCandidate:u,removeIndex(t){r=r.filter(((e,n)=>n!==t)),p()},list:()=>r,truncate:l,loading:s,onMyTurn:!!t.onMyTurn,findStartingWithNode:c,playAndSave:function(e){t.onMyTurn&&(s(!0),n(),z(`${o}/${e.uci}`,{method:"POST",body:JSON.stringify(c(e).filter(O).map((t=>t.slice(1)))),headers:{"Content-Type":"application/json"}}).then((t=>{t.reload?h():(s(!1),r=t.steps||[]),n()})))},reloadToLastPly:h}}const Li=t=>{const e=t.target;return parseInt(e.parentNode.getAttribute("data-it")||e.getAttribute("data-it")||"")};function Ri(t,e){if(t.embed||t.retro)return;const n=t.fork.state();if(!n.displayed)return;const o=e&&t.onMainline;return m("div.analyse__fork",{hook:M((e=>{e.addEventListener("click",(e=>{t.fork.proceed(Li(e)),t.redraw()})),e.addEventListener("mouseover",(e=>t.fork.highlight(Li(e)))),e.addEventListener("mouseout",(()=>t.fork.highlight()))}))},n.node.children.map(((r,s)=>{if(!(o&&e(!0)(t.path+r.id,r)))return m("move",{class:{selected:s===n.selected},attrs:{"data-it":s}},Nr({withDots:!0,showEval:t.showComputer(),showGlyphs:t.showComputer()},r))})))}const Fi=t=>!!t.children.find((t=>!!t.comp));const Bi=t=>t.split(" ").slice(0,4).join(" ");function zi(t){const e={sync:void 0,promise:t.then((t=>(e.sync=t,t)))};return e}async function ji(t,e){const n=t.config,o=n.byDb(),r=new URL(`/${t.db}`,t.endpoint),s=r.searchParams;if(s.set("variant",t.variant||"standard"),s.set("fen",t.rootFen),s.set("play",t.play.join(",")),"masters"===t.db?(o.since()&&s.set("since",o.since().split("-")[0]),o.until()&&s.set("until",o.until().split("-")[0])):(o.since()&&s.set("since",o.since()),o.until()&&s.set("until",o.until()),s.set("speeds",n.speed().join(","))),"lichess"===t.db&&s.set("ratings",n.rating().join(",")),"player"===t.db){const t=n.playerName.value();if(!t)return Gi(new Error("Missing player name"));s.set("player",t),s.set("color",n.color()),s.set("modes",n.mode().join(","))}let i;t.withGames||(s.set("topGames","0"),s.set("recentGames","0"));try{if(i=await fetch(r.href,{cache:"default",headers:{},credentials:"omit"}),!i.ok)throw new Error(`Status ${i.status}`)}catch(c){return Gi(c)}return(a=n=>{const o=n;o.isOpening=!0,o.fen=t.fen,e(o)},t=>{const e=t.body.getReader(),n=/\r?\n/,o=new TextDecoder;let r="";const s=()=>e.read().then((({done:t,value:e})=>{r+=o.decode(e||new Uint8Array,{stream:!t});const i=r.split(n);t||(r=i.pop());for(const n of i)n&&a(JSON.parse(n));return t?Promise.resolve(!0):s()}));return{cancel:()=>e.cancel(),end:zi(s())}})(i);var a}const Gi=t=>({cancel(){},end:zi(Promise.resolve(t))});async function Vi(t,e,n){const o="fromPosition"===e||"chess960"===e?"standard":e,r=await z(U(`${t}/${o}`,{fen:n}),{cache:"default",headers:{},credentials:"omit"});return r.tablebase=!0,r.fen=n,r}function Hi(t){return"w"===t.split(" ")[1]?"white":"black"}function Ui(t,e){const n=Hi(t);return e.checkmate||e.variant_loss||e.dtz&&e.dtz<0?n:e.variant_win||e.dtz&&e.dtz>0?on(n):void 0}const Wi=t=>`${t[0].toUpperCase()}${t.slice(1)}`,Ki=(t,e)=>({attrs:{"data-fen":e.fen},hook:{insert(n){const o=n.elm;o.addEventListener("mouseover",(e=>{t.explorer.setHovering($(o).attr("data-fen"),$(e.target).parents("tr").attr("data-uci"))})),o.addEventListener("mouseout",(e=>{t.explorer.setHovering($(o).attr("data-fen"),null)})),o.addEventListener("click",(t=>{const n=$(t.target).parents("tr").attr("data-uci");e.onClick(t,n)}))}}}),Ji={icons:{ultraBullet:"",bullet:"",blitz:"",rapid:"",classical:"",correspondence:"",chess960:"",kingOfTheHill:"",threeCheck:"",antichess:"",atomic:"",horde:""}},Yi=["ultraBullet","bullet","blitz","rapid","classical","correspondence"],Xi=["casual","rated"],Qi=[1600,1800,2e3,2200,2500],Zi=1952;class ta{constructor(t,e,n){var o,r;this.root=t,this.variant=e,this.onClose=n,this.allDbs=["lichess","player"],this.selectPlayer=t=>{if(t="me"==t?this.myName:t){if(t!=this.myName&&!this.participants.includes(t)){const e=this.data.playerName.previous().filter((e=>e!==t));e.unshift(t),this.data.playerName.previous(e.slice(0,20))}this.data.db("player"),this.data.playerName.value(t),this.data.playerName.open(!1)}},this.toggleMany=t=>e=>{t().includes(e)?t().length>1&&t(t().filter((t=>t!==e))):t(t().concat([e]))},this.toggleColor=()=>this.data.color(Zr(this.data.color())),this.toggleOpen=()=>{this.data.open(!this.data.open()),this.data.open()||("player"!=this.data.db()||this.data.playerName.value()||this.data.db("lichess"),this.onClose())},this.fullHouse=()=>this.data.byDb().since()<="1952-01"&&(!this.data.byDb().until()||(new Date).toISOString().slice(0,7)<=this.data.byDb().until())&&("masters"===this.data.db()||this.data.speed().length==Yi.length)&&("lichess"!==this.data.db()||this.data.rating().length==Qi.length)&&("player"!==this.data.db()||this.data.mode().length==Xi.length),this.myName=document.body.dataset.user,this.participants=[null===(o=t.data.player.user)||void 0===o?void 0:o.username,null===(r=t.data.opponent.user)||void 0===r?void 0:r.username].filter((t=>t&&t!=this.myName)),"standard"===e&&this.allDbs.unshift("masters");const s={};for(const i of this.allDbs)s[i]={since:Mn("explorer.since-2."+i,("masters"===i?Zi:2012)+"-01"),until:Mn("explorer.until-2."+i,(new Date).toISOString().slice(0,7))};this.data={open:q(!1),db:Mn("explorer.db."+e,this.allDbs[0]),rating:Pn("explorer.rating",(()=>Qi)),speed:Pn("explorer.speed",(()=>Yi)),mode:Pn("explorer.mode",(()=>Xi)),byDbData:s,playerName:{open:q(!1),value:Mn("explorer.player.name",document.body.dataset.user||""),previous:Pn("explorer.player.name.previous",(()=>[]))},color:q("white"),byDb(){return this.byDbData[this.db()]||this.byDbData.lichess}}}}function ea(t){return["masters"===t.data.db()?ra(t):"lichess"===t.data.db()?ia(t):oa(t),m("section.save",m("button.button.button-green.text",{attrs:A(""),hook:P("click",t.toggleOpen)},t.root.trans.noarg("allSet")))]}const na="Select a Lichess player",oa=t=>{const e=t.data.playerName.value();return m("div.player-db",[t.data.playerName.open()?ua(t):void 0,m("section.name",[m("label",t.root.trans("player")),m("div",[m("div.choices",m("button.player-name"+(e?".active":""),{hook:P("click",(()=>t.data.playerName.open(!0)),t.root.redraw),attrs:e?{title:na}:void 0},e||na)),m("button.button-link.text.color",{attrs:A(""),hook:P("click",t.toggleColor,t.root.redraw)}," "+t.root.trans("white"==t.data.color()?"asWhite":"asBlack"))])]),aa(t),ca(t),ha(t)])},ra=t=>m("div",[m("section.date",[m("label",[t.root.trans.noarg("since"),da(t.data.byDb().since,(()=>""),t.root.redraw)]),m("label",[t.root.trans.noarg("until"),da(t.data.byDb().until,t.data.byDb().since,t.root.redraw)])])]),sa=(t,e,n)=>o=>m("button",{attrs:{"aria-pressed":`${e().includes(o)}`,title:n?Wi(""+o):""},hook:P("click",(n=>t.toggleMany(e)(o)),t.root.redraw)},n?n(o):t.root.trans.noarg(""+o)),ia=t=>m("div",[aa(t),m("section.rating",[m("label",t.root.trans.noarg("averageElo")),m("div.choices",Qi.map(sa(t,t.data.rating)))]),ha(t)]),aa=t=>m("section.speed",[m("label",t.root.trans.noarg("timeControl")),m("div.choices",Yi.map(sa(t,t.data.speed,(t=>Ae(Ji.icons[t])))))]),ca=t=>m("section.mode",[m("label",t.root.trans.noarg("mode")),m("div.choices",Xi.map(sa(t,t.data.mode)))]),la=(t,e,n)=>{const o=t=>t.setCustomValidity(!t.value||e()<=t.value?"":"Invalid date range"),r=(new Date).toISOString().slice(0,7);return m("input",{key:e()?"until-month":"since-month",attrs:{type:"month",title:"Insert year and month in YYYY-MM format starting from 1952-01",pattern:"^(19|20)[0-9]{2}-(0[1-9]|1[012])$",placeholder:"YYYY-MM",min:"1952-01",max:r,value:t()>r?r:t()},hook:{insert:e=>{const r=e.elm;o(r),r.addEventListener("change",(e=>{const r=e.target;r.setCustomValidity(""),r.checkValidity()&&(o(r),t(r.value),n())}))},update:(t,e)=>o(e.elm)}})},da=(t,e,n)=>{const o=t=>t.setCustomValidity(!t.value||e().split("-")[0]<=t.value?"":"Invalid date range");return m("input",{attrs:{key:e()?"until-year":"since-year",type:"number",title:"Insert year in YYYY format starting from 1952",placeholder:"YYYY",min:Zi,max:(new Date).toISOString().slice(0,4),value:t().split("-")[0]},hook:{insert:r=>{const s=r.elm;o(s),s.addEventListener("change",(r=>{const s=r.target;s.setCustomValidity(""),s.checkValidity()&&(o(s),t(s.value?`${s.value}-${e()?"12":"01"}`:""),n())}))},update:(t,e)=>o(e.elm)}})},ha=t=>m("section.date",[m("label",[t.root.trans.noarg("since"),la(t.data.byDb().since,(()=>""),t.root.redraw)]),m("label",[t.root.trans.noarg("until"),la(t.data.byDb().until,t.data.byDb().since,t.root.redraw)])]),ua=t=>{const e=e=>{t.selectPlayer(e),t.root.redraw()};return ge({class:"explorer__config__player__choice",onClose(){t.data.playerName.open(!1),t.root.redraw()},content:[m("h2","Personal opening explorer"),m("div.input-wrapper",[m("input",{attrs:{placeholder:t.root.trans.noarg("searchByUsername")},hook:M((t=>lichess.userComplete().then((n=>{n({input:t,tag:"span",onSelect:t=>e(t.name)}),t.focus()}))))})]),m("div.previous",[...t.myName?[t.myName]:[],...t.participants,...t.data.playerName.previous()].map((n=>m("button.button"+(n==t.myName?".button-green":""),{hook:P("click",(()=>e(n)))},n))))]})};function pa(t,e,n){if(n.dtm)return m("result."+Ui(e,n),{attrs:{title:t.trans.plural("mateInXHalfMoves",Math.abs(n.dtm))+" (Depth To Mate)"}},"DTM "+Math.abs(n.dtm))}function ma(t,e,n){const o=t.trans.noarg;return n.checkmate?m("result."+Ui(e,n),o("checkmate")):n.variant_win?m("result."+Ui(e,n),o("variantLoss")):n.variant_loss?m("result."+Ui(e,n),o("variantWin")):n.stalemate?m("result.draws",o("stalemate")):n.insufficient_material?m("result.draws",o("insufficientMaterial")):null===n.dtz?null:0===n.dtz?m("result.draws",o("draw")):n.zeroing?n.san.includes("x")?m("result."+Ui(e,n),o("capture")):m("result."+Ui(e,n),o("pawnMove")):m("result."+Ui(e,n),{attrs:{title:o("dtzWithRounding")+" (Distance To Zeroing)"}},"DTZ "+Math.abs(n.dtz))}function fa(t){const e=t.white+t.draws+t.black;return m("div.bar",["white","draws","black"].map((n=>{const o=100*t[n]/e;return m("span."+n,{attrs:{style:"width: "+Math.round(1e3*t[n]/e)/10+"%"}},o>12?Math.round(o)+(o>20?"%":""):"")})))}function ga(t,e){if(!e.uci)return"Total";if(e.game){const n=e.game,o="white"===n.winner?"1-0":"black"===n.winner?"0-1":"½-½";return t.explorer.opts.showRatings?`${n.white.name} (${n.white.rating}) ${o} ${n.black.name} (${n.black.rating})`:`${n.white.name} ${o} ${n.black.name}`}if(t.explorer.opts.showRatings){if(e.averageRating)return t.trans("averageRatingX",e.averageRating);if(e.averageOpponentRating)return`Performance rating: ${e.performance}, average opponent: ${e.averageOpponentRating}`}return""}const va=t=>"white"===t?m("result.white","1-0"):"black"===t?m("result.black","0-1"):m("result.draws","½-½");function ba(t,e,n,o){if(!t.explorer.withGames||!o.length)return null;const r=t.explorer.gameMenu(),s="masters"==t.explorer.db();return m("table.games",[m("thead",[m("tr",[m("th.title",{attrs:{colspan:s?4:5}},n)])]),m("tbody",Ki(t,{fen:e,onClick:(e,n)=>{const o=$(e.target).parents("tr");if(!o.length)return;const r=o.data("id");t.study&&t.study.members.canContribute()?(t.explorer.gameMenu(r),t.redraw()):ya(t,r)}}),o.map((e=>r===e.id?function(t,e){function n(n){t.study.explorerGame(e.id,n),t.explorer.gameMenu(null),t.redraw()}return m("tr",{key:e.id+"-m"},[m("td.game_menu",{attrs:{colspan:"masters"==t.explorer.db()?4:5}},[m("div.game_title",`${e.white.name} - ${e.black.name}, ${va(e.winner).text}, ${e.year}`),m("div.menu",[m("a.text",{attrs:A(""),hook:P("click",(n=>ya(t,e.id)))},"View"),...t.study?[m("a.text",{attrs:A(""),hook:P("click",(t=>n(!1)),t.redraw)},"Cite"),m("a.text",{attrs:A(""),hook:P("click",(t=>n(!0)),t.redraw)},"Insert")]:[],m("a.text",{attrs:A(""),hook:P("click",(e=>t.explorer.gameMenu(null)),t.redraw)},"Close")])])])}(t,e):m("tr",{key:e.id,attrs:{"data-id":e.id,"data-uci":e.uci||""}},[t.explorer.opts.showRatings?m("td",[e.white,e.black].map((t=>m("span",""+t.rating)))):null,m("td",[e.white,e.black].map((t=>m("span",t.name)))),m("td",va(e.winner)),m("td",e.month||e.year),s?void 0:m("td",e.speed&&m("i",{attrs:{title:Wi(e.speed),...A(Ji.icons[e.speed])}}))]))))])}function ya(t,e){let n="/"+e+"/"+t.chessground.state.orientation+(t.node.ply>0?"?fen="+t.node.fen:"");"masters"===t.explorer.db()&&(n="/import/master"+n),window.open(n,"_blank","noopener")}function wa(t){return m("button.button.button-empty.text",{attrs:A(""),hook:P("click",t.toggleExplorer,t.redraw)},t.trans.noarg("close"))}function ka(t,e){return m("div.data.empty",[Ea(t.explorer),xa(t,e),m("div.message",[m("strong",t.trans.noarg("noGameFound")),t.explorer.config.fullHouse()?null:m("p.explanation",t.trans.noarg("maybeIncludeMoreGamesFromThePreferencesMenu"))])])}function Ca(t,e){return m("div.data.empty",[m("div.title",t.trans.noarg("gameOver")),m("div.message",[m("i",{attrs:A("")}),m("h3",t.trans.noarg(e)),wa(t)])])}const xa=(t,e)=>{const n=null==e?void 0:e.opening;return m("div.title",{attrs:n?{title:n&&`${n.eco} ${n.name}`}:{}},n?[m("strong",n.eco)," ",n.name]:[Aa(t,t.data.game.variant)])};let Ma;const Pa=()=>{Ma=void 0};function Sa(t){const e=t.trans.noarg,n=t.explorer.current();if(n&&n.isOpening){const o=function(t,e){if(!e.moves.length)return null;const n=t.trans.noarg,o=e.white+e.black+e.draws,r=e.moves.length>1?[...e.moves,{white:e.white,black:e.black,draws:e.draws,uci:"",san:"Σ"}]:e.moves;return m("table.moves",[m("thead",[m("tr",[m("th",n("move")),m("th",n("games")),m("th",n("whiteDrawBlack"))])]),m("tbody",Ki(t,{fen:e.fen,onClick:(e,n)=>n&&t.explorerMove(n)}),r.map((e=>{const n=e.white+e.draws+e.black;return m("tr"+(e.uci?"":".sum"),{key:e.uci,attrs:{"data-uci":e.uci}},[m("td","P"===e.san[0]?e.san.slice(1):e.san),m("td",{attrs:{title:(n/o*100).toFixed(1)+"%"}},tt(n)),m("td",{attrs:{title:ga(t,e)}},fa(e))])})))])}(t,n),r=ba(t,n.fen,e("recentGames"),n.recentGames||[]),s=ba(t,n.fen,e("topGames"),n.topGames||[]);Ma=o||r||s?m("div.data",[Ea(t.explorer),(null==n?void 0:n.opening)&&xa(t,n),o,s,r]):ka(t,n)}else if(n&&function(t){return!!t.tablebase}(n)){const o=(o,r,s)=>function(t,e,n,o,r){return r.length?[m("div.title",o?{attrs:{title:o}}:{},n),m("table.tablebase",[m("tbody",Ki(t,{fen:e,onClick:(e,n)=>n&&t.explorerMove(n)}),r.map((n=>m("tr",{key:n.uci,attrs:{"data-uci":n.uci}},[m("td",n.san),m("td",[ma(t,e,n),pa(t,e,n)])]))))])]:[]}(t,n.fen,e(r),s&&e(s),n.moves.filter((t=>t.category==o)));Ma=n.moves.length?m("div.data",[...o("loss","winning"),...o("unknown","unknown"),...o("maybe-loss","winOr50MovesByPriorMistake","unknownDueToRounding"),...o("blessed-loss","winPreventedBy50MoveRule"),...o("draw","drawn"),...o("cursed-win","lossSavedBy50MoveRule"),...o("maybe-win","lossOr50MovesByPriorMistake","unknownDueToRounding"),...o("win","losing")]):n.checkmate?Ca(t,"checkmate"):n.stalemate?Ca(t,"stalemate"):n.variant_win||n.variant_loss?Ca(t,"variantEnding"):ka(t)}return Ma}const Ea=t=>{const e=t.db(),n=(e,n)=>m("button.button-link",{key:e,attrs:{title:n},hook:P("click",(()=>t.config.data.db(e.toLowerCase())),t.reload)},e),o=(n,o)=>m("span.active.text."+e,{attrs:{title:o,...A("")},hook:"player"==e?P("click",t.config.toggleColor,t.reload):void 0},n),r=t.config.data.playerName.value(),s=t.root.trans("masterDbExplanation",2200,"1952","2021-11"),i=t.root.trans("lichessDbExplanation");return m("div.explorer-title",["masters"==e?o([m("strong","Masters")," database"],s):t.config.allDbs.includes("masters")?n("Masters",s):void 0,"lichess"==e?o([m("strong","Lichess")," database"],i):n("Lichess",i),"player"==e?r?o([m("strong"+(r.length>14?".long":""),r)," "+t.root.trans("white"==t.config.data.color()?"asWhite":"asBlack"),t.isIndexing()&&!t.config.data.open()?m("i.ddloader",{attrs:{title:"Indexing..."}}):void 0],t.root.trans("switchSides")):o([m("strong","Player")," database"],""):m("button.button-link.player",{key:"player",hook:P("click",(()=>{t.config.selectPlayer(r||"me"),"player"!=t.db()&&(t.config.data.db("player"),t.config.data.open(!0))}),t.reload)},t.root.trans("player"))])};function Aa(t,e){return"standard"===e.key||"fromPosition"===e.key?t.trans.noarg("openingExplorer"):t.trans("xOpeningExplorer",e.name)}let Ta="";function Ia(t){const e=t.explorer;if(!e.enabled())return;const n=e.current(),o=e.config.data.open(),r=!o&&(e.loading()||!n&&!e.failing()),s=o?function(t){return m("div.config",[Ea(t.explorer),...ea(t.explorer.config)])}(t):e.failing()?function(t){var e;return m("div.data.empty",[m("div.title",Aa(t,t.data.game.variant)),m("div.failing.message",[m("h3","Oops, sorry!"),m("p.explanation",null===(e=t.explorer.failing())||void 0===e?void 0:e.toString()),wa(t)])])}(t):Sa(t);return m("section.explorer-box.sub-box"+(o?".explorer__config":""),{class:{loading:r,reduced:!o&&(!!e.failing()||e.movesAway()>2)},hook:{insert:t=>t.elm.scrollTop=0,postpatch(t,e){n&&Ta!==n.fen&&(e.elm.scrollTop=0,Ta=n.fen)}}},[m("div.overlay"),s,m("button.fbt.toconf",{attrs:{"aria-label":o?"Close configuration":"Open configuration",...A(o?"":"")},hook:P("click",(()=>t.explorer.config.toggleOpen()),t.redraw)})])}function $a(t){return t.split(/\s/)[0].split(/[nbrqkp]/i).length-1}function _a(t){switch(t){case"standard":case"fromPosition":case"chess960":return 7;case"atomic":case"antichess":return 6;default:return 0}}const Na=(t,e)=>$a(e)<=_a(t);class Da{constructor(t,e,n){this.root=t,this.opts=e,this.loading=q(!0),this.failing=q(null),this.hovering=q(null),this.movesAway=q(0),this.gameMenu=q(null),this.lastStream=q(null),this.cache={},this.checkHash=t=>{var e;const n=location.hash.split("/");"#explorer"!=n[0]&&"#opening"!=n[0]||this.root.embed||(this.enabled(!0),"lichess"==n[1]||"masters"===n[1]?this.config.data.db(n[1]):(null===(e=n[1])||void 0===e?void 0:e.match(/[A-Za-z0-9_-]{2,30}/))&&(this.config.selectPlayer(n[1]),this.config.data.color("black"==n[2]?"black":"white")),t&&this.reload())},this.reload=()=>{this.cache={},this.setNode(),this.root.redraw()},this.destroy=Pa,this.baseXhrOpening=()=>({endpoint:this.opts.endpoint,config:this.config.data}),this.fetch=J((()=>{const t=this.root.node.fen,e=e=>{this.cache[t]=e,this.movesAway(e.moves.length?0:this.movesAway()+1),this.loading(!1),this.failing(null),this.root.redraw()},n=t=>{this.loading(!1),this.failing(t),this.root.redraw()},o=this.lastStream();o&&o.promise.then((t=>t.cancel())),this.withGames&&this.tablebaseRelevant(this.effectiveVariant,t)?Vi(this.opts.tablebaseEndpoint,this.effectiveVariant,t).then(e,n):this.lastStream(zi(ji({...this.baseXhrOpening(),db:this.db(),variant:this.effectiveVariant,rootFen:this.root.nodeList[0].fen,play:this.root.nodeList.slice(1).map((t=>t.uci)),fen:t,withGames:this.withGames},e).then((t=>(t.end.promise.then((t=>!0!==t?n(t):this.root.redraw())),t)))))}),250,!0),this.empty={white:0,black:0,draws:0,isOpening:!0,moves:[],fen:"",opening:this.root.data.game.opening},this.tablebaseRelevant=(t,e)=>$a(e)-1<=_a(t)&&this.root.ceval.possible,this.setNode=()=>{if(!this.enabled())return;this.gameMenu(null);const t=this.root.node;t.ply>=50&&!this.tablebaseRelevant(this.effectiveVariant,t.fen)&&(this.cache[t.fen]=this.empty);const e=this.cache[t.fen];e?(this.movesAway(e.moves.length?0:this.movesAway()+1),this.loading(!1),this.failing(null)):(this.loading(!0),this.fetch())},this.db=()=>this.config.data.db(),this.current=()=>this.cache[this.root.node.fen],this.toggle=()=>{this.movesAway(0),this.enabled(!this.enabled()),this.setNode(),this.root.autoScroll()},this.disable=()=>{this.enabled()&&(this.enabled(!1),this.gameMenu(null),this.root.autoScroll())},this.setHovering=(t,e)=>{this.hovering(e?{fen:t,uci:e}:null),this.root.setAutoShapes()},this.onFlip=()=>{"player"==this.db()&&(this.cache={},this.setNode())},this.isIndexing=()=>{const t=this.lastStream();return!(!t||t.sync&&t.sync.end.sync)},this.fetchMasterOpening=(()=>{const t={};return e=>{const n=t[e];return n?Promise.resolve(n):new Promise((n=>ji({...this.baseXhrOpening(),db:"masters",rootFen:e,play:[],fen:e},(o=>{t[e]=o,n(o)}))))}})(),this.fetchTablebaseHit=async t=>{const e=await Vi(this.opts.tablebaseEndpoint,this.effectiveVariant,t),n=e.moves[0];if(n&&null==n.dtz)throw"unknown tablebase position";return{fen:t,best:n&&n.uci,winner:e.checkmate?Zr(Hi(t)):e.stalemate?void 0:Ui(t,n)}},this.allowed=q(n),this.enabled=t.embed?q(!1):Mn("explorer.enabled",!1),this.withGames=t.synthetic||zt(t.data)||!!t.data.opponent.ai,this.effectiveVariant="fromPosition"===t.data.game.variant.key?"standard":t.data.game.variant.key,this.config=new ta(t,this.effectiveVariant,this.reload),window.addEventListener("hashchange",this.checkHash,!1),this.checkHash()}}function Oa(t,e){const n=t.data.game.variant.key,o=q(!0),r=q(null),s=q(null),i=q(null),a=q(!1);function c(e,n=0){if(e.tbhit||t.outcome(e))return!0;const o=e.ceval;return!!o&&(o.depth+n>=15||o.depth>=13&&!o.cloud&&o.millis>3e3)}function l(t){return t&&(t.winner?{mate:"white"===t.winner?10:-10}:{cp:0})}function d(t){return t.tbhit&&t.tbhit.best||t.ceval&&t.ceval.pvs[0].moves[0]}function h(e,n,o){let r,s;const i=t.outcome(n);if(i&&i.winner)r="goodMove";else{const o=l(n.tbhit)||(n.threefold||i&&!i.winner?{cp:0}:n.ceval),a=l(e.tbhit)||e.ceval,c=-co(t.bottomColor(),o,a);s=d(e),(s===n.uci||n.san.startsWith("O-O")&&s===qt[n.uci])&&(s=void 0),r=s?c<.025?"goodMove":c<.06?"inaccuracy":c<.14?"mistake":"blunder":"goodMove"}return{prev:e,node:n,path:o,verdict:r,best:s?{uci:s,san:t.position(e).unwrap((t=>((t,e)=>hr(t.clone(),e))(t,hn(s))),(t=>"--"))}:void 0}}function u(){return t.turnColor()===t.bottomColor()}function p(){const s=t.node;if(!o())return r(null),t.redraw();if(!Na(n,s.fen)||_(s.tbhit))if(t.showComputer()||t.toggleComputer(),t.ceval.enabled()||t.toggleCeval(),t.threatMode()&&t.toggleThreatMode(),u()){const e=i();e&&(e.uci=d(s)||e.uci,t.setAutoShapes())}else{if(r(null),s.san&&c(s)){const e=t.tree.parentNode(t.path);if(c(e,1))r(h(e,s,t.path));else{const e=t.tree.parentNode(Ht(t.path));c(e,1)&&r(h(e,s,t.path))}}!a()&&function(t){const n=t.ceval;return!!n&&(n.depth>=Math.min(n.maxDepth||99,e())||n.depth>=15&&(n.cloud||n.millis>5e3))}(s)?(t.playUci(d(s)),a(!0)):t.redraw()}}function m(){Na(n,t.node.fen)?t.explorer.fetchTablebaseHit(t.node.fen).then((e=>{e&&t.node.fen===e.fen&&(t.node.tbhit=e),p()}),(()=>{_(t.node.tbhit)||(t.node.tbhit=null),p()})):p()}function f(){o(!0),m()}return lichess.requestIdleCallback(m,800),{onCeval:p,onJump(){a(!1),i(null),function(t,e){if(_(e.threefold))return;const n=Bi(e.fen);let o,r=0;for(o in t)Bi(t[o].fen)===n&&r++;e.threefold=r>2}(t.nodeList,t.node),m()},isMyTurn:u,comment:r,running:o,hovering:s,hinting:i,resume:f,playableDepth:e,reset(){r(null),i(null)},preUserJump(t,e){t!==e&&(o(!1),r(null))},postUserJump(t,e){t!==e&&u()&&f()},onUserMove(){o(!0)},playCommentBest(){const e=r();e&&(t.jump(Ht(e.path)),e.best&&t.playUci(e.best.uci))},commentShape(e){const n=r();e&&n&&n.best?s({uci:n.best.uci}):s(null),t.setAutoShapes()},hint(){const e=t.node.ceval?t.node.ceval.pvs[0].moves[0]:null,n=i();!e||n&&"move"===n.mode?i(null):i({mode:n?"move":"piece",uci:e}),t.setAutoShapes()},currentNode:()=>t.node,bottomColor:t.bottomColor,redraw:t.redraw}}function qa(t,e){const n=t.data.game;let o=[];const r=[];let s=[];const i=q(null),a=q("find"),c=t.redraw;function l(t){return s.includes(t)}function d(){const n="white"==e?1:0;return o=function(t,e){const n=[];for(let o=1;o<t.length;o++){const r=t[o],s=t[o-1];if(e(r)&&r.eval&&s.eval){const t=Math.abs(co("white",s.eval,r.eval));Fi(s)&&(t>.1||s.eval.mate&&!r.eval.mate&&Math.abs(s.eval.mate)<=3)&&n.push(r)}}return n}(t.mainline,(t=>t.ply%2===n&&!r.includes(t.ply))),o.find((t=>!l(t.ply)))}function h(){a("find");const e=d();if(!e)return i(null),c();const o={node:e,path:t.mainlinePathToPly(e.ply)},s=Ht(o.path),l={node:t.tree.nodeAtPath(s),path:s},u=l.node.children.find((t=>!!t.comp));i({fault:o,prev:l,solution:{node:u,path:s+u.id},openingUcis:[]}),"standard"===n.variant.key&&n.division&&(!n.division.middle||o.node.ply<n.division.middle)&&t.explorer.fetchMasterOpening(l.node.fen).then((t=>{const e=i(),n=[];t.moves.forEach((t=>{t.white+t.draws+t.black>1&&n.push(t.uci)})),n.includes(o.node.uci)?(r.push(o.node.ply),setTimeout(h,100)):(e.openingUcis=n,i(e))})),t.userJump(l.path),c()}function u(){const n=t.node,o=i();if(o&&"eval"===a()&&o.fault.node.ply===n.ply&&function(t){var e;return!!t.ceval&&(t.ceval.depth>=18||t.ceval.depth>=14&&(null!==(e=t.ceval.millis)&&void 0!==e?e:0)>7e3)}(n)){co(e,n.ceval,o.prev.node.eval)>-.035?p():m()}}function p(){f(),a("win"),c()}function m(){a("fail");const e={node:t.node,path:t.path};t.userJump(i().prev.path),!t.tree.pathIsMainline(e.path)&&D(e.node.children)&&t.tree.deleteNodeAt(e.path),c()}function f(){s.push(i().fault.node.ply)}function g(){const t=a();return"find"===t||"fail"===t}return h(),{current:i,color:e,isPlySolved:l,onJump:function(){const e=t.node,n=a(),o=i();if(o){if("eval"===n&&o.fault.node.ply!==e.ply)return a("find"),void t.setAutoShapes();g()&&o.fault.node.ply===e.ply&&(o.openingUcis.includes(e.uci)||e.comp?p():e.eval?m():(a("eval"),t.ceval.enabled()||t.toggleCeval(),u())),t.setAutoShapes()}},jumpToNext:h,skip:function(){f(),h()},viewSolution:function(){a("view"),t.userJump(i().solution.path),f()},hideComputerLine:function(t){return t.ply%2==0!=("white"===e)&&!l(t.ply)},showBadNode:function(){const e=i();if(e&&g()&&e.prev.path===t.path)return e.fault.node},onCeval:u,onMergeAnalysisData:function(){g()&&!i()&&h()},feedback:a,isSolving:g,completion:()=>[s.length,o.length],reset(){s=[],h()},flip(){"racingKings"!==t.data.game.variant.key?t.flip():(t.retro=qa(t,Zr(e)),c())},close:t.toggleRetro,trans:t.trans,noarg:t.trans.noarg,node:()=>t.node,redraw:c}}const La="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Ra={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},Fa={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function Ba(t){"start"===t&&(t=La);const e=new Map;let n=7,o=0;for(const r of t)switch(r){case" ":case"[":return e;case"/":if(--n,n<0)return e;o=0;break;case"~":{const t=e.get(Jr([o-1,n]));t&&(t.promoted=!0);break}default:{const t=r.charCodeAt(0);if(t<57)o+=t-48;else{const t=r.toLowerCase();e.set(Jr([o,n]),{role:Ra[t],color:r===t?"black":"white"}),++o}}}return e}function za(t,e){return Math.abs(t-e)}const ja=(t,e,n,o)=>{const r=za(t,n),s=za(e,o);return 1===r&&2===s||2===r&&1===s},Ga=(t,e,n,o)=>za(t,n)===za(e,o),Va=(t,e,n,o)=>t===n||e===o,Ha=(t,e,n,o)=>Ga(t,e,n,o)||Va(t,e,n,o);function Ua(t,e,n){const o=t.get(e);if(!o)return[];const r=Yr(e),s=o.role,i="pawn"===s?(a=o.color,(t,e,n,o)=>za(t,n)<2&&("white"===a?o===e+1||e<=1&&o===e+2&&t===n:o===e-1||e>=6&&o===e-2&&t===n)):"knight"===s?ja:"bishop"===s?Ga:"rook"===s?Va:"queen"===s?Ha:function(t,e,n){return(o,r,s,i)=>za(o,s)<2&&za(r,i)<2||n&&r===i&&r===("white"===t?0:7)&&(4===o&&(2===s&&e.includes(0)||6===s&&e.includes(7))||e.includes(s))}(o.color,function(t,e){const n="white"===e?"1":"8",o=[];for(const[r,s]of t)r[1]===n&&s.color===e&&"rook"===s.role&&o.push(Yr(r)[0]);return o}(t,o.color),n);var a;return Xr.filter((t=>(r[0]!==t[0]||r[1]!==t[1])&&i(r[0],r[1],t[0],t[1]))).map(Jr)}function Wa(t,...e){t&&setTimeout((()=>t(...e)),1)}function Ka(t){t.premovable.current&&(t.premovable.current=void 0,Wa(t.premovable.events.unset))}function Ja(t){const e=t.predroppable;e.current&&(e.current=void 0,Wa(e.events.unset))}function Ya(t,e,n){const o=t.pieces.get(e),r=t.pieces.get(n);if(e===n||!o)return!1;const s=r&&r.color!==o.color?r:void 0;return n===t.selected&&oc(t),Wa(t.events.move,e,n,s),function(t,e,n){if(!t.autoCastle)return!1;const o=t.pieces.get(e);if(!o||"king"!==o.role)return!1;const r=Yr(e),s=Yr(n);if(0!==r[1]&&7!==r[1]||r[1]!==s[1])return!1;4!==r[0]||t.pieces.has(n)||(6===s[0]?n=Jr([7,s[1]]):2===s[0]&&(n=Jr([0,s[1]])));const i=t.pieces.get(n);return!(!i||i.color!==o.color||"rook"!==i.role||(t.pieces.delete(e),t.pieces.delete(n),r[0]<s[0]?(t.pieces.set(Jr([6,s[1]]),o),t.pieces.set(Jr([5,s[1]]),i)):(t.pieces.set(Jr([2,s[1]]),o),t.pieces.set(Jr([3,s[1]]),i)),0))}(t,e,n)||(t.pieces.set(n,o),t.pieces.delete(e)),t.lastMove=[e,n],t.check=void 0,Wa(t.events.change),s||!0}function Xa(t,e,n,o){if(t.pieces.has(n)){if(!o)return!1;t.pieces.delete(n)}return Wa(t.events.dropNewPiece,e,n),t.pieces.set(n,e),t.lastMove=[n],t.check=void 0,Wa(t.events.change),t.movable.dests=void 0,t.turnColor=Zr(t.turnColor),!0}function Qa(t,e,n){const o=Ya(t,e,n);return o&&(t.movable.dests=void 0,t.turnColor=Zr(t.turnColor),t.animation.current=void 0),o}function Za(t,e,n){if(sc(t,e,n)){const o=Qa(t,e,n);if(o){const r=t.hold.stop();oc(t);const s={premove:!1,ctrlKey:t.stats.ctrlKey,holdTime:r};return!0!==o&&(s.captured=o),Wa(t.movable.events.after,e,n,s),!0}}else if(function(t,e,n){return e!==n&&ic(t,e)&&Ua(t.pieces,e,t.premovable.castle).includes(n)}(t,e,n))return function(t,e,n,o){Ja(t),t.premovable.current=[e,n],Wa(t.premovable.events.set,e,n,o)}(t,e,n,{ctrlKey:t.stats.ctrlKey}),oc(t),!0;return oc(t),!1}function tc(t,e,n,o){const r=t.pieces.get(e);r&&(function(t,e,n){const o=t.pieces.get(e);return!(!o||e!==n&&t.pieces.has(n)||"both"!==t.movable.color&&(t.movable.color!==o.color||t.turnColor!==o.color))}(t,e,n)||o)?(t.pieces.delete(e),Xa(t,r,n,o),Wa(t.movable.events.afterNewPiece,r.role,n,{premove:!1,predrop:!1})):r&&function(t,e,n){const o=t.pieces.get(e),r=t.pieces.get(n);return!!o&&(!r||r.color!==t.movable.color)&&t.predroppable.enabled&&("pawn"!==o.role||"1"!==n[1]&&"8"!==n[1])&&t.movable.color===o.color&&t.turnColor!==o.color}(t,e,n)?function(t,e,n){Ka(t),t.predroppable.current={role:e,key:n},Wa(t.predroppable.events.set,e,n)}(t,r.role,n):(Ka(t),Ja(t)),t.pieces.delete(e),oc(t)}function ec(t,e,n){if(Wa(t.events.select,e),t.selected){if(t.selected===e&&!t.draggable.enabled)return oc(t),void t.hold.cancel();if((t.selectable.enabled||n)&&t.selected!==e&&Za(t,t.selected,e))return void(t.stats.dragged=!1)}(rc(t,e)||ic(t,e))&&(nc(t,e),t.hold.start())}function nc(t,e){t.selected=e,ic(t,e)?t.premovable.dests=Ua(t.pieces,e,t.premovable.castle):t.premovable.dests=void 0}function oc(t){t.selected=void 0,t.premovable.dests=void 0,t.hold.cancel()}function rc(t,e){const n=t.pieces.get(e);return!!n&&("both"===t.movable.color||t.movable.color===n.color&&t.turnColor===n.color)}function sc(t,e,n){var o,r;return e!==n&&rc(t,e)&&(t.movable.free||!!(null===(r=null===(o=t.movable.dests)||void 0===o?void 0:o.get(e))||void 0===r?void 0:r.includes(n)))}function ic(t,e){const n=t.pieces.get(e);return!!n&&t.premovable.enabled&&t.movable.color===n.color&&t.turnColor!==n.color}function ac(t){const e=t.premovable.current;if(!e)return!1;const n=e[0],o=e[1];let r=!1;if(sc(t,n,o)){const e=Qa(t,n,o);if(e){const s={premove:!0};!0!==e&&(s.captured=e),Wa(t.movable.events.after,n,o,s),r=!0}}return Ka(t),r}function cc(t){Ka(t),Ja(t),oc(t)}function lc(t){t.movable.color=t.movable.dests=t.animation.current=void 0,cc(t)}function dc(t,e,n){let o=Math.floor(8*(t[0]-n.left)/n.width);e||(o=7-o);let r=7-Math.floor(8*(t[1]-n.top)/n.height);return e||(r=7-r),o>=0&&o<8&&r>=0&&r<8?Jr([o,r]):void 0}function hc(t){return"white"===t.orientation}const uc=["green","red","blue","yellow"];function pc(t,e){if(e.touches&&e.touches.length>1)return;e.stopPropagation(),e.preventDefault(),e.ctrlKey?oc(t):cc(t);const n=is(e),o=dc(n,hc(t),t.dom.bounds());o&&(t.drawable.current={orig:o,pos:n,brush:bc(e),snapToValidMove:t.drawable.defaultSnapToValidMove},mc(t))}function mc(t){requestAnimationFrame((()=>{const e=t.drawable.current;if(e){const n=dc(e.pos,hc(t),t.dom.bounds());n||(e.snapToValidMove=!1);const o=e.snapToValidMove?function(t,e,n,o){const r=Yr(t),s=Xr.filter((t=>Ha(r[0],r[1],t[0],t[1])||ja(r[0],r[1],t[0],t[1]))),i=s.map((t=>ls(Jr(t),n,o))).map((t=>ts(e,t))),[,a]=i.reduce(((t,e,n)=>t[0]<e?t:[e,n]),[i[0],0]);return Jr(s[a])}(e.orig,e.pos,hc(t),t.dom.bounds()):n;o!==e.mouseSq&&(e.mouseSq=o,e.dest=o!==e.orig?o:void 0,t.dom.redrawNow()),mc(t)}}))}function fc(t,e){t.drawable.current&&(t.drawable.current.pos=is(e))}function gc(t){const e=t.drawable.current;e&&(e.mouseSq&&function(t,e){const n=t=>t.orig===e.orig&&t.dest===e.dest,o=t.shapes.find(n);o&&(t.shapes=t.shapes.filter((t=>!n(t))));o&&o.brush===e.brush||t.shapes.push(e);yc(t)}(t.drawable,e),vc(t))}function vc(t){t.drawable.current&&(t.drawable.current=void 0,t.dom.redraw())}function bc(t){var e;const n=(t.shiftKey||t.ctrlKey)&&as(t),o=t.altKey||t.metaKey||(null===(e=t.getModifierState)||void 0===e?void 0:e.call(t,"AltGraph"));return uc[(n?1:0)+(o?2:0)]}function yc(t){t.onChange&&t.onChange(t.shapes)}function wc(t,e){return e.animation.enabled?function(t,e){const n=new Map(e.pieces),o=t(e),r=function(t,e){const n=new Map,o=[],r=new Map,s=[],i=[],a=new Map;let c,l,d;for(const[h,u]of t)a.set(h,Cc(h,u));for(const h of Kr)c=e.pieces.get(h),l=a.get(h),c?l?es(c,l.piece)||(s.push(l),i.push(Cc(h,c))):i.push(Cc(h,c)):l&&s.push(l);for(const h of i)l=xc(h,s.filter((t=>es(h.piece,t.piece)))),l&&(d=[l.pos[0]-h.pos[0],l.pos[1]-h.pos[1]],n.set(h.key,d.concat(d)),o.push(l.key));for(const h of s)o.includes(h.key)||r.set(h.key,h.piece);return{anims:n,fadings:r}}(n,e);if(r.anims.size||r.fadings.size){const t=e.animation.current&&e.animation.current.start;e.animation.current={start:performance.now(),frequency:1/e.animation.duration,plan:r},t||Mc(e,performance.now())}else e.dom.redraw();return o}(t,e):kc(t,e)}function kc(t,e){const n=t(e);return e.dom.redraw(),n}function Cc(t,e){return{key:t,pos:Yr(t),piece:e}}function xc(t,e){return e.sort(((e,n)=>ts(t.pos,e.pos)-ts(t.pos,n.pos)))[0]}function Mc(t,e){const n=t.animation.current;if(void 0===n)return void(t.dom.destroyed||t.dom.redrawNow());const o=1-(e-n.start)*n.frequency;if(o<=0)t.animation.current=void 0,t.dom.redrawNow();else{const e=function(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1}(o);for(const t of n.plan.anims.values())t[2]=t[0]*e,t[3]=t[1]*e;t.dom.redrawNow(!0),requestAnimationFrame(((e=performance.now())=>Mc(t,e)))}}function Pc(t,e){if(!e.isTrusted||void 0!==e.button&&0!==e.button)return;if(e.touches&&e.touches.length>1)return;const n=t.dom.bounds(),o=is(e),r=dc(o,hc(t),n);if(!r)return;const s=t.pieces.get(r),i=t.selected;var a;i||!t.drawable.enabled||!t.drawable.eraseOnClick&&s&&s.color===t.turnColor||(a=t).drawable.shapes.length&&(a.drawable.shapes=[],a.dom.redraw(),yc(a.drawable)),!1!==e.cancelable&&(!e.touches||t.blockTouchScroll||s||i||function(t,e){const n=hc(t),o=t.dom.bounds(),r=Math.pow(o.width/8,2);for(const s of t.pieces.keys()){const t=ls(s,n,o);if(ts(t,e)<=r)return!0}return!1}(t,o))&&e.preventDefault();const c=!!t.premovable.current,l=!!t.predroppable.current;t.stats.ctrlKey=e.ctrlKey,t.selected&&sc(t,t.selected,r)?wc((t=>ec(t,r)),t):ec(t,r);const d=t.selected===r,h=_c(t,r);if(s&&h&&d&&function(t,e){const n=t.pieces.get(e);return!!n&&t.draggable.enabled&&("both"===t.movable.color||t.movable.color===n.color&&(t.turnColor===n.color||t.premovable.enabled))}(t,r)){t.draggable.current={orig:r,piece:s,origPos:o,pos:o,started:t.draggable.autoDistance&&t.stats.dragged,element:h,previouslySelected:i,originTarget:e.target,keyHasChanged:!1},h.cgDragging=!0,h.classList.add("dragging");const a=t.dom.elements.ghost;a&&(a.className=`ghost ${s.color} ${s.role}`,os(a,ns(n)(Yr(r),hc(t))),ss(a,!0)),Ec(t)}else c&&Ka(t),l&&Ja(t);t.dom.redraw()}function Sc(t,e,n,o){const r="a0";t.pieces.set(r,e),t.dom.redraw();const s=is(n);t.draggable.current={orig:r,piece:e,origPos:s,pos:s,started:!0,element:()=>_c(t,r),originTarget:n.target,newPiece:!0,force:!!o,keyHasChanged:!1},Ec(t)}function Ec(t){requestAnimationFrame((()=>{var e;const n=t.draggable.current;if(!n)return;(null===(e=t.animation.current)||void 0===e?void 0:e.plan.anims.has(n.orig))&&(t.animation.current=void 0);const o=t.pieces.get(n.orig);if(o&&es(o,n.piece)){if(!n.started&&ts(n.pos,n.origPos)>=Math.pow(t.draggable.distance,2)&&(n.started=!0),n.started){if("function"==typeof n.element){const t=n.element();if(!t)return;t.cgDragging=!0,t.classList.add("dragging"),n.element=t}const e=t.dom.bounds();os(n.element,[n.pos[0]-e.left-e.width/16,n.pos[1]-e.top-e.height/16]),n.keyHasChanged||(n.keyHasChanged=n.orig!==dc(n.pos,hc(t),e))}}else Ic(t);Ec(t)}))}function Ac(t,e){t.draggable.current&&(!e.touches||e.touches.length<2)&&(t.draggable.current.pos=is(e))}function Tc(t,e){const n=t.draggable.current;if(!n)return;if("touchend"===e.type&&!1!==e.cancelable&&e.preventDefault(),"touchend"===e.type&&n.originTarget!==e.target&&!n.newPiece)return void(t.draggable.current=void 0);Ka(t),Ja(t);const o=dc(is(e)||n.pos,hc(t),t.dom.bounds());o&&n.started&&n.orig!==o?n.newPiece?tc(t,n.orig,o,n.force):(t.stats.ctrlKey=e.ctrlKey,Za(t,n.orig,o)&&(t.stats.dragged=!0)):n.newPiece?t.pieces.delete(n.orig):t.draggable.deleteOnDropOff&&!o&&(t.pieces.delete(n.orig),Wa(t.events.change)),(n.orig!==n.previouslySelected&&!n.keyHasChanged||n.orig!==o&&o)&&t.selectable.enabled||oc(t),$c(t),t.draggable.current=void 0,t.dom.redraw()}function Ic(t){const e=t.draggable.current;e&&(e.newPiece&&t.pieces.delete(e.orig),t.draggable.current=void 0,oc(t),$c(t),t.dom.redraw())}function $c(t){const e=t.dom.elements;e.ghost&&ss(e.ghost,!1)}function _c(t,e){let n=t.dom.elements.board.firstChild;for(;n;){if(n.cgKey===e&&"PIECE"===n.tagName)return n;n=n.nextSibling}}const Nc=["queen","knight","rook","bishop"];class Dc{constructor(t,e,n,o=1){this.withGround=t,this.onCancel=e,this.redraw=n,this.autoQueenPref=o,this.start=(t,e,n,o,r=!1)=>this.withGround((s=>{const i=s.state.pieces.get(t),a=i||s.state.pieces.get(e);return"pawn"==(null==a?void 0:a.role)&&("8"==e[1]&&"black"==s.state.turnColor||"1"==e[1]&&"white"==s.state.turnColor)&&(this.prePromotionRole&&(null==o?void 0:o.premove)?(this.doPromote({orig:t,dest:e,callback:n},this.prePromotionRole),!0):(null==o?void 0:o.ctrlKey)||this.promoting||!(3===this.autoQueenPref||2===this.autoQueenPref&&i||r)?(this.promoting={orig:t,dest:e,pre:!!i,callback:n},this.redraw(),!0):(i?this.setPrePromotion(e,"queen"):this.doPromote({orig:t,dest:e,callback:n},"queen"),!0))}))||!1,this.cancel=()=>{this.cancelPrePromotion(),this.promoting&&(this.promoting=void 0,this.onCancel(),this.redraw())},this.cancelPrePromotion=()=>{this.prePromotionRole&&(this.withGround((t=>t.setAutoShapes([]))),this.prePromotionRole=void 0,this.redraw())},this.view=t=>{const e=this.promoting;if(e)return this.withGround((n=>this.renderPromotion(e.dest,t?Nc.concat("king"):Nc,Zr(n.state.turnColor),n.state.orientation)))||null}}finish(t){const e=this.promoting;e&&(this.promoting=void 0,e.pre?this.setPrePromotion(e.dest,t):this.doPromote(e,t),this.redraw())}doPromote(t,e){this.withGround((n=>function(t,e,n){const o=t.state.pieces.get(e);o&&"pawn"==o.role&&t.setPieces(new Map([[e,{color:o.color,role:n,promoted:!0}]]))}(n,t.dest,e))),t.callback(t.orig,t.dest,e)}setPrePromotion(t,e){this.prePromotionRole=e,this.withGround((n=>n.setAutoShapes([{orig:t,piece:{color:Zr(n.state.turnColor),role:e,opacity:.8},brush:""}])))}renderPromotion(t,e,n,o){let r=12.5*(7-Yr(t)[0]);"white"===o&&(r=87.5-r);return m("div#promotion-choice."+(n===o?"top":"bottom"),{hook:M((t=>{t.addEventListener("click",this.cancel),t.oncontextmenu=()=>!1}))},e.map(((t,e)=>m("square",{attrs:{style:"top: "+12.5*(n===o?e:7-e)+"%;left: "+r+"%"},hook:P("click",(e=>{e.stopPropagation(),this.finish(t)}))},[m("piece."+t+"."+n)]))))}}function Oc(){const t=new Map,e=t=>{$(".analyse__wiki").html(t).toggleClass("empty",!t),lichess.pubsub.emit("chat.resize")},n="https://en.wikibooks.org",o=(t,e)=>(t=>t.replace(/<p>(<br \/>|\s)*<\/p>/g,""))((t=>t.replace('<h2><span id="Theory_table">Theory table</span></h2>',""))((t=>t.replace(/For explanation of theory tables see theory table and for notation see algebraic notation.?/,""))((t=>t.replace("When contributing to this Wikibook, please follow the Conventions for organization.",""))(t))))+(t=>`<p><a target="_blank" href="${n}/wiki/${t}">Read more on WikiBooks</a></p>`)(e);return J((async r=>{var s;const i=r.slice(1).map((t=>`${(t=>`${Math.floor((t.ply+1)/2)}${t.ply%2==1?"._":"..."}`)(t)}${t.san}`)),a=null!==(s=i.join("/").replace(/[+!#?]/g,""))&&void 0!==s?s:"";if(i.length>30||!a||a.length>234)e("");else if(t.has(a))e(t.get(a));else if(Array.from({length:i.length},((t,e)=>-e-1)).map((t=>i.slice(0,t).join("/"))).some((e=>t.has(e)&&!t.get(e).length)))e("");else{const r=`Chess_Opening_Theory/${a}`;try{const s=await fetch(`${n}/w/api.php?titles=${r}&redirects&origin=*&action=query&prop=extracts&formatversion=2&format=json&exchars=1200`),i=n=>{t.set(a,n),e(n)};if(s.ok){const t=(await s.json()).query.pages[0];t.missing?i(""):t.invalid?e("invalid request: "+t.invalidreason):t.extract?i(o(t.extract,r)):e("error: unexpected API response:<br><pre>"+JSON.stringify(t)+"</pre>")}else i("")}catch(c){e("error: "+c)}}}),500,!0)}class qc{constructor(t,e){this.opts=t,this.redraw=e,this.autoScrollRequested=!1,this.redirecting=!1,this.onMainline=!0,this.flipped=!1,this.showComments=!0,this.showAutoShapes=Mn("show-auto-shapes",!0),this.showGauge=Mn("show-gauge",!0),this.showComputer=Mn("show-computer",!0),this.showMoveAnnotation=Mn("show-move-annotation",!0),this.keyboardHelp="#keyboard"===location.hash,this.threatMode=q(!1),this.cgVersion={js:1,dom:1},this.pvUciQueue=[],this.enableWiki=t=>{this.wiki=t?Oc():void 0,this.wiki&&this.wiki(this.nodeList)},this.setPath=t=>{this.path=t,this.nodeList=this.tree.getNodeList(t),this.node=Zt(this.nodeList),this.mainline=se(this.tree.root),this.onMainline=this.tree.pathIsMainline(t),this.fenInput=void 0,this.pgnInput=void 0,this.wiki&&this.wiki(this.nodeList)},this.flip=()=>{this.flipped=!this.flipped,this.chessground.set({orientation:this.bottomColor()}),this.retro&&"racingKings"!==this.data.game.variant.key&&(this.retro=qa(this,this.bottomColor())),this.practice&&this.restartPractice(),this.explorer.onFlip(),this.onChange(),this.redraw()},this.bottomIsWhite=()=>"white"===this.bottomColor(),this.getDests=Oe(800,(()=>{this.embed||_(this.node.dests)||this.socket.sendAnaDests({variant:this.data.game.variant.key,fen:this.node.fen,path:this.path})})),this.throttleSound=t=>Oe(100,(()=>lichess.sound.play(t))),this.sound={move:this.throttleSound("move"),capture:this.throttleSound("capture"),check:this.throttleSound("check")},this.onChange=Oe(300,(()=>{lichess.pubsub.emit("analysis.change",this.node.fen,this.path,!!this.onMainline&&this.node.ply)})),this.updateHref=J((()=>{this.opts.study||window.history.replaceState(null,"","#"+this.node.ply)}),750),this.playedLastMoveMyself=()=>!!this.justPlayed&&!!this.node.uci&&this.node.uci.startsWith(this.justPlayed),this.userJump=t=>{if(this.autoplay.stop(),this.gamebookPlay()||this.withCg((t=>t.selectSquare(null))),this.practice){const e=this.path;this.practice.preUserJump(e,t),this.jump(t),this.practice.postUserJump(e,this.path)}else this.jump(t)},this.canJumpTo=t=>!this.study||this.study.canJumpTo(t),this.jumpToMain=t=>{this.userJump(this.mainlinePathToPly(t))},this.jumpToIndex=t=>{this.jumpToMain(t+1+this.tree.root.ply)},this.userNewPiece=(t,e)=>{if(function(t,e,n,o){if(n.color!==t.state.movable.color)return!1;if("pawn"===n.role&&("1"===o[1]||"8"===o[1]))return!1;const r=Ot(e);return null===r||r.includes(o)}(this.chessground,this.node.drops,t,e)){this.justPlayed=an(t.role).toUpperCase()+"@"+e,this.justDropped=t.role,this.justCaptured=void 0,this.sound.move();const n={role:t.role,pos:e,variant:this.data.game.variant.key,fen:this.node.fen,path:this.path};this.socket.sendAnaDrop(n),this.preparePremoving(),this.redraw()}else this.jump(this.path)},this.userMove=(t,e,n)=>{this.justPlayed=t,this.justDropped=void 0;const o=this.chessground.state.pieces.get(e),r=n||o&&"pawn"==o.role&&t[0]!=e[0];this.sound[r?"capture":"move"](),this.promotion.start(t,e,((t,e,o)=>this.sendMove(t,e,n,o)))||this.sendMove(t,e,n)},this.sendMove=(t,e,n,o)=>{const r={orig:t,dest:e,variant:this.data.game.variant.key,fen:this.node.fen,path:this.path};n&&(this.justCaptured=n),o&&(r.promotion=o),this.practice&&this.practice.onUserMove(),this.socket.sendAnaMove(r),this.preparePremoving(),this.redraw()},this.onPremoveSet=()=>{this.study&&this.study.onPremoveSet()},this.setAutoShapes=()=>{this.withCg((t=>t.setAutoShapes(function(t){const e=t.node.fen.includes(" w ")?"white":"black",n=Zr(e);if(t.practice){const n=t.practice.hovering();if(n)return hs(e,n.uci,"green");const o=t.practice.hinting();return o?"move"===o.mode?hs(e,o.uci,"paleBlue"):[{orig:"@"===o.uci[1]?o.uci.slice(2,4):o.uci.slice(0,2),brush:"paleBlue"}]:[]}const o=t.getCeval(),{eval:r={},fen:s,ceval:i,threat:a}=t.node;let c=t.explorer.hovering();c&&c.fen===s||(t.explorer.hovering(null),c=o.hovering());let l,d=[];if(t.retro&&(l=t.retro.showBadNode()))return hs(e,l.uci,"paleRed",{lineWidth:8});if(c&&c.fen===s&&(d=d.concat(hs(e,c.uci,"paleBlue"))),t.showAutoShapes()&&t.showComputer()&&(r.best&&(d=d.concat(hs(n,r.best,"paleGreen"))),!c&&parseInt(o.multiPv()))){const n=o.enabled()&&i?i.pvs[0].moves[0]:t.nextNodeBest();n&&(d=d.concat(hs(e,n,"paleBlue"))),o.enabled()&&i&&i.pvs[1]&&!(t.threatMode()&&a&&a.pvs.length>2)&&i.pvs.forEach((function(t){if(t.moves[0]===n)return;const o=co(e,i.pvs[0],t);o>=0&&o<.2&&(d=d.concat(hs(e,t.moves[0],"paleGrey",{lineWidth:Math.round(12-50*o)})))}))}if(o.enabled()&&t.threatMode()&&a){const[t,...e]=a.pvs;d=d.concat(hs(n,t.moves[0],e.length>0?"paleRed":"red")),e.forEach((function(e){const o=co(n,e,t);o>=0&&o<.2&&(d=d.concat(hs(n,e.moves[0],"paleRed",{lineWidth:Math.round(11-45*o)})))}))}if(t.showMoveAnnotation()&&t.showComputer()){const{uci:e,glyphs:n,san:o}=t.node;if(e&&o&&n&&n.length>0){const t=n[0],r=ps[t.symbol];if(r){const t=hn(e),n=o.startsWith("O-O")?0===rn(t.to)?o.startsWith("O-O-O")?"c1":"g1":o.startsWith("O-O-O")?"c8":"g8":dn(t.to);d=d.concat({orig:n,customSvg:r})}}}return d}(this))))},this.onNewCeval=(t,e,n)=>{this.tree.updateAt(e,(o=>{if(o.fen===t.fen||n){if(n){const e=t;(!o.threat||lo(e,o.threat)||o.threat.maxDepth<e.maxDepth)&&(o.threat=e)}else!o.ceval||lo(t,o.ceval)?o.ceval=t:t.cloud||(o.ceval.cloud&&this.ceval.isDeeper()?o.ceval=t:t.maxDepth>o.ceval.maxDepth&&(o.ceval.maxDepth=t.maxDepth));e===this.path&&(this.setAutoShapes(),n||(this.retro&&this.retro.onCeval(),this.practice&&this.practice.onCeval(),this.studyPractice&&this.studyPractice.onCeval(),this.evalCache.onCeval(),t.cloud&&t.depth>=this.ceval.effectiveMaxDepth()&&this.ceval.stop()),this.redraw())}}))},this.startCeval=Oe(800,(()=>{this.ceval.enabled()&&(this.canUseCeval()?(this.ceval.start(this.path,this.nodeList,this.threatMode()),this.evalCache.fetch(this.path,parseInt(this.ceval.multiPv()))):this.ceval.stop())})),this.toggleCeval=()=>{this.showComputer()&&(this.ceval.toggle(),this.setAutoShapes(),this.startCeval(),this.ceval.enabled()||(this.threatMode(!1),this.practice&&this.togglePractice()),this.redraw())},this.toggleThreatMode=()=>{this.node.check||(this.ceval.enabled()||this.ceval.toggle(),this.ceval.enabled()&&(this.threatMode(!this.threatMode()),this.threatMode()&&this.practice&&this.togglePractice(),this.setAutoShapes(),this.startCeval(),this.redraw()))},this.disableThreatMode=()=>!!this.practice,this.mandatoryCeval=()=>!!this.studyPractice,this.cevalSetMultiPv=t=>{this.ceval.multiPv(t),this.tree.removeCeval(),this.evalCache.clear(),this.cevalReset()},this.cevalSetThreads=t=>{this.ceval.setThreads(t),this.cevalReset()},this.cevalSetHashSize=t=>{this.ceval.setHashSize(t),this.cevalReset()},this.cevalSetInfinite=t=>{this.ceval.infinite(t),this.cevalReset()},this.hasFullComputerAnalysis=()=>Object.keys(this.mainline[0].eval||{}).length>0,this.toggleAutoShapes=t=>{this.showAutoShapes(t),this.resetAutoShapes()},this.toggleGauge=()=>{this.showGauge(!this.showGauge())},this.toggleMoveAnnotation=t=>{this.showMoveAnnotation(t),this.resetAutoShapes()},this.toggleComputer=()=>{this.ceval.enabled()&&this.toggleCeval();const t=!this.showComputer();this.showComputer(t),!t&&this.practice&&this.togglePractice(),this.onToggleComputer(),lichess.pubsub.emit("analysis.comp.toggle",t)},this.toggleRetro=()=>{this.retro?this.retro=void 0:(this.retro=qa(this,this.bottomColor()),this.practice&&this.togglePractice(),this.explorer.enabled()&&this.toggleExplorer()),this.setAutoShapes()},this.toggleExplorer=()=>{this.practice&&this.togglePractice(),(this.explorer.enabled()||this.explorer.allowed())&&this.explorer.toggle()},this.togglePractice=()=>{this.practice||!this.ceval.possible?(this.practice=void 0,this.showGround()):(this.retro&&this.toggleRetro(),this.explorer.enabled()&&this.toggleExplorer(),this.practice=Oa(this,(()=>this.studyPractice&&null===this.studyPractice.success()?20:18)),this.setAutoShapes())},this.gamebookPlay=()=>this.study&&this.study.gamebookPlay(),this.isGamebook=()=>!(!this.study||!this.study.data.chapter.gamebook),this.withCg=t=>{if(this.chessground&&this.cgVersion.js===this.cgVersion.dom)return t(this.chessground)},this.data=t.data,this.element=t.element,this.embed=t.embed,this.trans=t.trans,this.treeView=function(t="column"){const e=Mn("treeView",t);function n(){return"inline"===e()}function o(t){e(t?"inline":"column")}return{get:e,set:o,toggle(){o(!n())},inline:n}}(t.embed?"inline":"column"),this.promotion=new Dc(this.withCg,(()=>this.withCg((t=>t.set(this.cgConfig)))),this.redraw),this.data.forecast&&(this.forecast=qi(this.data.forecast,this.data,e)),this.opts.wiki&&(this.wiki=Oc()),window.LichessAnalyseNvui&&(this.nvui=window.LichessAnalyseNvui(e)),this.instanciateEvalCache(),this.initialize(this.data,!1),this.instanciateCeval(),this.initialPath="";{const t=window.location,e="#last"===t.hash?this.tree.lastPly():parseInt(t.hash.slice(1));if(e){window.history.replaceState(null,"",t.pathname+t.search);const n=se(this.tree.root);this.initialPath=te(n,(t=>t.ply<=e))}}this.setPath(this.initialPath),this.showGround(),this.onToggleComputer(),this.startCeval(),this.explorer.setNode(),this.study=t.study?As(t.study,this,(t.tagTypes||"").split(","),t.practice,t.relay):void 0,this.studyPractice=this.study?this.study.practice:void 0,"#practice"===location.hash||this.study&&this.study.data.chapter.practice?this.togglePractice():"#menu"===location.hash&&lichess.requestIdleCallback(this.actionMenu.toggle,500),Ce(this),lichess.pubsub.on("jump",(t=>{this.jumpToMain(parseInt(t)),this.redraw()})),lichess.pubsub.on("sound_set",(t=>{this.music||"music"!==t||lichess.loadScript("javascripts/music/replay.js").then((()=>{this.music=window.lichessReplayMusic()})),this.music&&"music"!==t&&(this.music=null)})),lichess.pubsub.on("analysis.change.trigger",this.onChange),lichess.pubsub.on("analysis.chart.click",(t=>{this.jumpToIndex(t),this.redraw()})),lichess.pubsub.on("speech.enabled",Me),Me(lichess.sound.speech())}initialize(t,e){this.data=t,this.synthetic="synthetic"===t.game.id,this.ongoing=!this.synthetic&&Ft(t);const n=e&&this.tree.root;this.tree=ae(function(t){const e=t[0],n=t.length;let o=e;e.id="";for(let r=1;r<n;r++){const e=t[r];o.children?o.children.unshift(e):o.children=[e],o=e}return o.children=o.children||[],e}(this.data.treeParts)),n&&this.tree.merge(n),this.actionMenu=new Hs,this.autoplay=new Ts(this),this.socket?this.socket.clearCache():this.socket=function(t,e){let n,o,r={};function s(){r="standard"===e.data.game.variant.key&&e.tree.root.fen.split(" ",1)[0]===La?{"":{path:"",dests:"iqy muC gvx ltB bqs pxF jrz nvD ksA owE"}}:{}}function i(){if(e.study)return e.study.vm.chapterId}function a(t,n=!1){const o=i();o&&(t.ch=o,n&&(e.study.isWriting()?e.study.vm.mode.sticky||(t.sticky=!1):t.write=!1))}s(),e.synthetic||setTimeout((function(){t("startWatching",e.data.game.id)}),1e3);const c={node(t){clearTimeout(n),t.ch==i()?e.addNode(t.node,t.path):console.log("socket handler node got wrong chapter id",t)},stepFailure(){clearTimeout(n),e.reset()},dests(t){clearTimeout(o),t.ch&&t.ch!==i()?console.log("socket handler node got wrong chapter id",t):(r[t.path]=t,e.addDests(t.dests,t.path))},destsFailure(t){console.log(t),clearTimeout(o)},fen(t){e.forecast&&t.id===e.data.game.id&&0!==Zt(e.mainline).fen.indexOf(t.fen)&&e.forecast.reloadToLastPly()},analysisProgress(t){e.mergeAnalysisData(t)},evalHit(t){e.evalCache.onCloudEval(t)}};function l(t){"standard"===t.variant&&delete t.variant}return{receive(t,n){const o=c[t];return o?(o(n),!0):!!e.study&&e.study.socketHandler(t,n)},sendAnaMove:function e(o){clearTimeout(n),l(o),a(o,!0),t("anaMove",o),n=setTimeout((()=>e(o)),3e3)},sendAnaDrop:function e(o){clearTimeout(n),l(o),a(o,!0),t("anaDrop",o),n=setTimeout((()=>e(o)),3e3)},sendAnaDests:function e(n){clearTimeout(o),r[n.path]?setTimeout((function(){c.dests(r[n.path])}),300):(l(n),a(n),t("anaDests",n),o=setTimeout((function(){console.log(n,"resendAnaDests"),e(n)}),3e3))},clearCache:s,send:t}}(this.opts.socketSend,this),this.explorer&&this.explorer.destroy(),this.explorer=new Da(this,this.opts.explorer,this.explorer?this.explorer.allowed():!this.embed),this.gamePath=this.synthetic||this.ongoing?void 0:Wt(se(this.tree.root)),this.fork=function(t){let e,n=0;function o(){return t.node.children.length>1}return{state(){const r=t.node;return e&&e.id===r.id||(e=r,n=0),{node:r,selected:n,displayed:o()}},next(){if(o())return n=Math.min(t.node.children.length-1,n+1),!0},prev(){if(o())return n=Math.max(0,n-1),!0},highlight(e){var n;if(!o()||!_(e))return void t.explorer.setHovering(t.node.fen,null);const r=null===(n=t.node.children[e])||void 0===n?void 0:n.uci,s=_(r)?r:null;t.explorer.setHovering(t.node.fen,s)},proceed(e){if(o()){e=_(e)?e:n;const o=t.node.children[e];if(_(o))return t.userJumpIfCan(t.path+o.id),!0}}}}(this),lichess.sound.preloadBoardSounds()}topColor(){return on(this.bottomColor())}bottomColor(){return"racingKings"===this.data.game.variant.key?this.flipped?"black":"white":this.flipped?on(this.data.orientation):this.data.orientation}getOrientation(){return this.bottomColor()}getNode(){return this.node}turnColor(){return this.node.ply%2==0?"white":"black"}togglePlay(t){this.autoplay.toggle(t),this.actionMenu.open=!1}uciToLastMove(t){if(!t)return;const e="@"===t[1]?2:0;return[t.slice(e,e+2),t.slice(2,4)]}showGround(){this.onChange(),_(this.node.dests)||this.getDests(),this.withCg((t=>{t.set(this.makeCgOpts()),this.setAutoShapes(),this.node.shapes&&t.setShapes(this.node.shapes)}))}makeCgOpts(){const t=this.node,e=this.turnColor(),n=function(t){if(void 0===t)return null;const e=new Map;if(t)for(const n of t.split(" "))e.set(Nt[n[0]],n.slice(1).split("").map((t=>Nt[t])));return e}(this.node.dests),o=Ot(this.node.drops),r=this.gamebookPlay(),s=r?r.movableColor():this.practice?this.bottomColor():!this.embed&&(n&&n.size>0||null===o||o.length)?e:void 0,i={fen:t.fen,turnColor:e,movable:this.embed?{color:void 0,dests:new Map}:{color:s,dests:s===e&&n||new Map},check:!!t.check,lastMove:this.uciToLastMove(t.uci)};return n||t.check||(i.turnColor=on(e),i.movable.color=e),i.premovable={enabled:i.movable.color&&i.turnColor!==i.movable.color},this.cgConfig=i,i}autoScroll(){this.autoScrollRequested=!0}jump(t){const e=t!==this.path,n=e&&t.length==this.path.length+2;this.setPath(t),e&&(this.study&&this.study.setPath(t,this.node),n&&(this.node.uci?this.playedLastMoveMyself()||(this.node.san.includes("x")?this.sound.capture():this.sound.move()):this.sound.move(),/\+|#/.test(this.node.san)&&this.sound.check()),this.threatMode(!1),this.ceval.stop(),this.startCeval(),Pe(this.node)),this.justPlayed=this.justDropped=this.justCaptured=void 0,this.explorer.setNode(),this.updateHref(),this.autoScroll(),this.promotion.cancel(),e&&(this.retro&&this.retro.onJump(),this.practice&&this.practice.onJump(),this.study&&this.study.onJump()),this.music&&this.music.jump(this.node),lichess.pubsub.emit("ply",this.node.ply),this.showGround()}userJumpIfCan(t){this.canJumpTo(t)&&this.userJump(t)}mainlinePathToPly(t){return te(this.mainline,(e=>e.ply<=t))}jumpToGlyphSymbol(t,e){const n=function(t,e,n,o){const r=n.length;if(!r)return;const s=o-n[0].ply;for(let i=1;i<r;i++){const o=n[(s+i)%r];if(o.ply%2==("white"===t?1:0)&&o.glyphs&&o.glyphs.find((function(t){return t.symbol===e})))return o}}(t,e,this.mainline,this.node.ply);n&&this.jumpToMain(n.ply),this.redraw()}reloadData(t,e){this.initialize(t,e),this.redirecting=!1,this.setPath(""),this.instanciateCeval(),this.instanciateEvalCache(),this.cgVersion.js++}changePgn(t){this.redirecting=!0,z("/analysis/pgn",{method:"post",body:H({pgn:t})}).then((t=>{this.reloadData(t,!1),this.userJump(this.mainlinePathToPly(this.tree.lastPly())),this.redraw()}),(t=>{console.log(t),this.redirecting=!1,this.redraw()}))}changeFen(t){this.redirecting=!0,window.location.href="/analysis/"+this.data.game.variant.key+"/"+encodeURIComponent(t).replace(/%20/g,"_").replace(/%2F/g,"/")}preparePremoving(){this.chessground.set({turnColor:this.chessground.state.movable.color,movable:{color:on(this.chessground.state.movable.color)},premovable:{enabled:!0}})}addNode(t,e){const n=this.tree.addNode(t,e);if(!n)return console.log("Can't addNode",t,e),this.redraw();this.jump(n),this.redraw();const o=this.pvUciQueue.shift();o?this.playUci(o,this.pvUciQueue):this.chessground.playPremove()}addDests(t,e){this.tree.addDests(t,e),e===this.path&&(this.showGround(),this.outcome()&&this.ceval.stop()),this.withCg((t=>t.playPremove()))}deleteNode(t){const e=this.tree.nodeAtPath(t);if(!e)return;const n=ne(e);(n.nodes>=10||n.comments>0)&&!confirm("Delete "+Ie("move",n.nodes)+(n.comments?" and "+Ie("comment",n.comments):"")+"?")||(this.tree.deleteNodeAt(t),Ut(this.path,t)?this.userJump(Ht(t)):this.jump(this.path),this.study&&this.study.deleteNode(t))}promote(t,e){this.tree.promoteAt(t,e),this.jump(t),this.study&&this.study.promote(t,e)}forceVariation(t,e){this.tree.forceVariationAt(t,e),this.jump(t),this.study&&this.study.forceVariation(t,e)}reset(){this.showGround(),this.redraw()}encodeNodeFen(){return this.node.fen.replace(/\s/g,"_")}currentEvals(){return{server:this.node.eval,client:this.node.ceval}}nextNodeBest(){return Kt(this.node,(t=>{var e;return null===(e=t.eval)||void 0===e?void 0:e.best}))}instanciateCeval(){this.ceval&&this.ceval.destroy(),this.ceval=lr({variant:this.data.game.variant,initialFen:this.data.game.initialFen,possible:!this.embed&&(this.synthetic||!Ft(this.data)),emit:(t,e)=>{this.onNewCeval(t,e.path,e.threatMode)},setAutoShapes:this.setAutoShapes,redraw:this.redraw,...this.opts.study&&this.opts.practice?{storageKeyPrefix:"practice",multiPvDefault:1}:{}})}getCeval(){return this.ceval}outcome(t){return this.position(t||this.node).unwrap((t=>t.outcome()),(t=>{}))}position(t){const e=wn(t.fen).unwrap();return sr(Zn(this.data.game.variant.key),e)}canUseCeval(){return!this.node.threefold&&!this.outcome()}cevalReset(){this.ceval.stop(),this.ceval.enabled()||this.ceval.toggle(),this.startCeval(),this.redraw()}showEvalGauge(){return this.hasAnyComputerAnalysis()&&this.showGauge()&&!this.outcome()&&this.showComputer()}hasAnyComputerAnalysis(){return!!this.data.analysis||this.ceval.enabled()}resetAutoShapes(){this.showAutoShapes()||this.showMoveAnnotation()?this.setAutoShapes():this.chessground&&this.chessground.setAutoShapes([])}onToggleComputer(){this.showComputer()?this.resetAutoShapes():(this.tree.removeComputerVariations(),this.ceval.enabled()&&this.toggleCeval(),this.chessground&&this.chessground.setAutoShapes([]))}mergeAnalysisData(t){this.study&&this.study.data.chapter.id!==t.ch||(this.tree.merge(t.tree),this.showComputer()||this.tree.removeComputerVariations(),this.data.analysis=t.analysis,t.analysis&&(t.analysis.partial=!!Jt(t.tree,(t=>!t.eval&&!!t.children.length&&t.ply<=300))),t.division&&(this.data.game.division=t.division),this.retro&&this.retro.onMergeAnalysisData(),this.study&&this.study.serverEval.onMergeAnalysisData(),lichess.pubsub.emit("analysis.server.progress",this.data),this.redraw())}playUci(t,e){this.pvUciQueue=null!=e?e:[];const n=hn(t),o=dn(n.to);if("from"in n){const t=this.chessground.state.pieces.get(dn(n.from)),e=this.chessground.state.pieces.get(o);this.sendMove(dn(n.from),o,e&&t&&e.color!==t.color?e:void 0,n.promotion)}else this.chessground.newPiece({color:this.chessground.state.movable.color,role:n.role},o)}playUciList(t){this.pvUciQueue=t;const e=this.pvUciQueue.shift();e&&this.playUci(e,this.pvUciQueue)}explorerMove(t){this.playUci(t),this.explorer.loading(!0)}playBestMove(){var t;const e=(null===(t=this.node.ceval)||void 0===t?void 0:t.pvs[0].moves[0])||this.nextNodeBest();e&&this.playUci(e)}canEvalGet(){if(this.node.ply>=15&&!this.opts.study)return!1;const t=new Set;for(let e=this.nodeList.length-1;e>=0;e--){const n=this.nodeList[e],o=n.fen.split(" ").slice(0,4).join(" ");if(t.has(o))return!1;if(n.san&&uo(this.data.game.variant.key,n.san))return!0;t.add(o)}return!0}instanciateEvalCache(){this.evalCache=Oi({variant:this.data.game.variant.key,canGet:()=>this.canEvalGet(),canPut:()=>{var t;return!!((null===(t=this.ceval)||void 0===t?void 0:t.cachable)&&this.data.evalPut&&this.canEvalGet()&&(this.opts.study||!this.node.ceval.mate&&Math.abs(this.node.ceval.cp)<99))},getNode:()=>this.node,send:this.opts.socketSend,receive:this.onNewCeval})}restartPractice(){this.practice=void 0,this.togglePractice()}}const Lc={pawn:1,knight:3,bishop:3,rook:5,queen:9,king:0};const Rc={white:0,black:0};function Fc(t,e,n,o){const r=[];let s;for(s in t)if(t[s]>0){const e=[];for(let n=0;n<t[s];n++)e.push(m("mpiece."+s));r.push(m("div",e))}if(o)for(let i=0;i<o;i++)r.push(m("div",m("mpiece.king")));return e>0&&r.push(m("score","+"+e)),m("div.material.material-"+n,r)}const Bc={white:{king:0,queen:0,rook:0,bishop:0,knight:0,pawn:0},black:{king:0,queen:0,rook:0,bishop:0,knight:0,pawn:0}};function zc(t,e,n,o,r,s){let i,a=0;t?(i=function(t){const e={white:{king:0,queen:0,rook:0,bishop:0,knight:0,pawn:0},black:{king:0,queen:0,rook:0,bishop:0,knight:0,pawn:0}};for(const n of t.values()){const t=e[Zr(n.color)];t[n.role]>0?t[n.role]--:e[n.color][n.role]++}return e}(n),a=function(t){let e=0;for(const n of t.values())e+=Lc[n.role]*("white"===n.color?1:-1);return e}(n)*("white"===e?1:-1)):i=Bc;const c=o?function(t,e){const n={...Rc};for(const o of t){if(e<o.ply)break;o.check&&(o.ply%2==1?n.white++:n.black++)}return n}(r,s):Rc,l=Zr(e);return[Fc(i[l],-a,"top",c[l]),Fc(i[e],a,"bottom",c[e])]}function jc(t,e){for(let n=0;n<8;n++)for(let o=n%2===e?0:1;o<8;o+=2)if(/[bB]/.test(t[8*n+o]))return!0;return!1}function Gc(t){var e;const n=t.trans.noarg,o=t.data;switch(o.game.status.name){case"started":return n("playingRightNow");case"aborted":return n("gameAborted");case"mate":return n("checkmate");case"resign":return n("white"==o.game.winner?"blackResigned":"whiteResigned");case"stalemate":return n("stalemate");case"timeout":switch(o.game.winner){case"white":return n("blackLeftTheGame");case"black":return n("whiteLeftTheGame")}return`${o.game.turns%2==0?n("whiteLeftTheGame"):n("blackLeftTheGame")}${o.game.winner?"":` • ${n("draw")}`}`;case"draw":return function(t,e){if("horde"===t||"kingOfTheHill"===t||"racingKings"===t||"crazyhouse"===t||"atomic"===t||"antichess"===t)return!1;let n=e.split(" ")[0].replace(/[^a-z]/gi,"");if("threeCheck"===t)return!/[pbnrq]/.test(n)||!/[PBNRQ]/.test(n);if(/[prq]/i.test(n))return!1;if(/n/.test(n))return n.length-n.replace(/[a-z]/g,"").length<=2&&!/[PBNR]/.test(n);if(/N/.test(n))return n.length-n.replace(/[A-Z]/g,"").length<=2&&!/[pbnr]/.test(n);if(/b/i.test(n)){for(let t=8;t>1;t--)n=n.replace(""+t,"1"+(t-1));return!(jc(n,0)&&jc(n,1)||/[pPnN]/.test(n))}return!1}(o.game.variant.key,o.game.fen)?`${n("insufficientMaterial")} • ${n("draw")}`:"100"===o.game.fen.split(" ")[4]?`${n("fiftyMovesWithoutProgress")} • ${n("draw")}`:o.game.threefold?`${n("threefoldRepetition")} • ${n("draw")}`:(null===(e=o.game.drawOffers)||void 0===e?void 0:e.some((t=>t>=o.game.turns)))?n("drawByMutualAgreement"):n("draw");case"outoftime":return`${o.game.turns%2==0?n("whiteTimeOut"):n("blackTimeOut")}${o.game.winner?"":` • ${n("draw")}`}`;case"noStart":return"white"==o.game.winner?n("blackDidntMove"):n("whiteDidntMove");case"cheat":return n("cheatDetected");case"variantEnd":switch(o.game.variant.key){case"kingOfTheHill":return n("kingInTheCenter");case"threeCheck":return n("threeChecks")}return n("variantEnding");case"unknownFinish":return"Finished";default:return o.game.status.name}}const Vc=(t,e)=>{const n=jt(t.data,e);return n.user?m("a.user-link.ulpt",{attrs:{href:"/@/"+n.user.username}},[n.user.username," ",(o=n.ratingDiff,0===o?m("span","±0"):o&&o>0?m("good","+"+o):o&&o<0?m("bad","−"+-o):void 0)]):m("span",n.name||n.ai&&"Stockfish level "+n.ai||t.study&&Nn(t.study.data.chapter.tags,e)||"Anonymous");var o},Hc=[{kind:"inaccuracy",i18n:"nbInaccuracies",symbol:"?!"},{kind:"mistake",i18n:"nbMistakes",symbol:"?"},{kind:"blunder",i18n:"nbBlunders",symbol:"??"}];function Uc(t,e){const n=t.data,o=n.analysis[e].acpl;return m("div.advice-summary__side",[m("div.advice-summary__player",[m(`i.is.color-icon.${e}`),Vc(t,e)]),...Hc.map((o=>{const r=n.analysis[e][o.kind];return m(`div.advice-summary__error${r?`.symbol.${o.kind}`:""}`,{attrs:r?{"data-color":e,"data-symbol":o.symbol}:{}},t.trans.vdomPlural(o.i18n,r,m("strong",r)))})),m("div.advice-summary__acpl",[m("strong",""+(_(o)?o:"?")),m("span",t.trans.noarg("averageCentipawnLoss"))])])}function Wc(t){return m("div.advice-summary",{hook:{insert:e=>{$(e.elm).on("click","div.symbol",(function(){t.jumpToGlyphSymbol($(this).data("color"),$(this).data("symbol"))}))}}},[Uc(t,"white"),t.study?null:m("a.button.text",{class:{active:!!t.retro},attrs:A(""),hook:P("click",t.toggleRetro,t.redraw)},t.trans.noarg("learnFromYourMistakes")),Uc(t,"black")])}function Kc(t){if(t.studyPractice||t.embed)return;if(!t.data.analysis||!t.showComputer()||t.study&&"serverEval"!==t.study.vm.toolTab())return m("div.analyse__acpl");let e=""+(t.data.analysis.partial?Math.random():"")+!!t.retro;return t.study&&(e+=t.study.data.chapter.id),m("div.analyse__acpl",b("div.advice-summary",Wc,[t,e]))}function Jc(t){if(t.embed)return;const e=t.node,n=e.clock;if(!n&&0!==n)return;const o=t.bottomIsWhite(),r=t.tree.getParentClock(e,t.path),s=e.ply%2==0,i=[r,n];s||i.reverse();const a=t.study,c=a&&a.data.chapter.relay,l=(null==c?void 0:c.path)===t.path&&""!==t.path&&!_n(a.data.chapter)&&c.lastMoveAt||t.autoplay.lastMoveAt;if(l){const t=(Date.now()-l)/10,e=s?0:1;i[e]&&(i[e]=Math.max(0,i[e]-t))}const d=!t.study||!t.study.relay;return[Yc(i[0],s,o?"bottom":"top",d),Yc(i[1],!s,o?"top":"bottom",d)]}function Yc(t,e,n,o){return m("div.analyse__clock."+n,{class:{active:e}},function(t,e){if(!t&&0!==t)return["-"];const n=new Date(10*t),o=n.getUTCMilliseconds(),r=":",s=Xc(n.getUTCMinutes())+r+Xc(n.getUTCSeconds());return!e||t>=36e4?[Math.floor(t/36e4)+r+s]:t>=6e3?[s]:[s,m("tenths","."+Math.floor(o/100).toString())]}(t,o))}function Xc(t){return(t<10?"0":"")+t}const Qc=["mousedown","touchstart"],Zc=["pawn","knight","bishop","rook","queen"];function tl(t,e,n){if(!t.node.crazy||"crazyhouse"!==t.data.game.variant.key)return;const o=t.node.crazy.pockets["white"===e?0:1],r=t.justDropped,s=t.justCaptured;s&&(s.role=s.promoted?"pawn":s.role);const i=e===t.turnColor(),a=!t.embed&&i;return m(`div.pocket.is2d.pocket-${n}.pos-${t.bottomColor()}`,{class:{usable:a},hook:M((n=>{t.embed||Qc.forEach((o=>{n.addEventListener(o,(n=>function(t,e,n){if(void 0!==n.button&&0!==n.button)return;if(t.chessground.state.movable.color!==e)return;const o=n.target,r=o.getAttribute("data-role"),s=o.getAttribute("data-nb");r&&e&&"0"!==s&&(n.stopPropagation(),n.preventDefault(),Sc(t.chessground.state,{color:e,role:r},n))}(t,e,n)))}))}))},Zc.map((t=>{let n=o[t]||0;return i&&(r===t&&n--,s&&s.role===t&&n++),m("div.pocket-c1",m("div.pocket-c2",m("piece."+t+"."+e,{attrs:{"data-role":t,"data-color":e,"data-nb":n}})))})))}function el(t,e,n){const o=n[0];if(!o)return;const r=e.findStartingWithNode(o);if(!r.length)return;const s=r.filter((function(t){return t.length>1}));return m("button.on-my-turn.button.text",{attrs:A(""),hook:P("click",(t=>e.playAndSave(o)))},[m("span",[m("strong",t.trans("playX",Dt(n[0].san))),s.length?m("span",t.trans.plural("andSaveNbPremoveLines",s.length)):m("span",t.trans.noarg("noConditionalPremoves"))])])}function nl(t,e){const n=t.tree.getCurrentNodesAfterPly(t.nodeList,t.mainline,t.data.game.turns);return e.truncate(n.map((t=>({ply:t.ply,fen:t.fen,uci:t.uci,san:t.san,check:t.check}))))}function ol(t,e){const n=nl(t,e),o=e.isCandidate(n);return m("div.forecast",{class:{loading:e.loading()}},[e.loading()?m("div.overlay",ke()):null,m("div.box",[m("div.top",t.trans.noarg("conditionalPremoves")),m("div.list",e.list().map((function(n,o){return m("div.entry.text",{attrs:A("")},[m("button.del",{hook:P("click",(t=>e.removeIndex(o)),t.redraw),attrs:{"data-icon":"",type:"button"}}),m("sans",qs(n))])}))),m("button.add.text",{class:{enabled:o},attrs:A(o?"":""),hook:P("click",(n=>e.addNodes(nl(t,e))),t.redraw)},[m("span",o?[m("span",t.trans.noarg("addCurrentVariation")),m("sans",qs(n))]:t.trans.noarg("playVariationToCreateConditionalPremoves"))])]),e.onMyTurn?el(t,e,n):null])}const rl=(t,e=100)=>{let n;const o=Oe(e,(()=>requestAnimationFrame((()=>{t(),n&&clearTimeout(n),n=setTimeout(o,500)}))));o()};let sl=!1;let il=!1;function al(t){const e=()=>function(t){const e=t.querySelector(".mchat"),n=t.querySelector(".analyse__board .cg-wrap"),o=t.querySelector(".analyse__side");if(e&&n&&o){const t=n.offsetHeight-o.offsetHeight;t&&(e.style.height=`calc(${t}px - 2vmin)`)}}(t);var n;rl(e),n=e,sl||(sl=!0,document.body.addEventListener("chessground.resize",n)),il||(lichess.pubsub.on("chat.resize",e),il=!0)}function cl(t,e){e.animation&&(dl(t.animation,e.animation),(t.animation.duration||0)<70&&(t.animation.enabled=!1))}function ll(t,e){var n,o;if((null===(n=e.movable)||void 0===n?void 0:n.dests)&&(t.movable.dests=void 0),(null===(o=e.drawable)||void 0===o?void 0:o.autoShapes)&&(t.drawable.autoShapes=[]),dl(t,e),e.fen&&(t.pieces=Ba(e.fen),t.drawable.shapes=[]),"check"in e&&function(t,e){if(t.check=void 0,!0===e&&(e=t.turnColor),e)for(const[n,o]of t.pieces)"king"===o.role&&o.color===e&&(t.check=n)}(t,e.check||!1),"lastMove"in e&&!e.lastMove?t.lastMove=void 0:e.lastMove&&(t.lastMove=e.lastMove),t.selected&&nc(t,t.selected),cl(t,e),!t.movable.rookCastle&&t.movable.dests){const e="white"===t.movable.color?"1":"8",n="e"+e,o=t.movable.dests.get(n),r=t.pieces.get(n);if(!o||!r||"king"!==r.role)return;t.movable.dests.set(n,o.filter((t=>!(t==="a"+e&&o.includes("c"+e)||t==="h"+e&&o.includes("g"+e)))))}}function dl(t,e){for(const n in e)hl(t[n])&&hl(e[n])?dl(t[n],e[n]):t[n]=e[n]}function hl(t){return"object"==typeof t}function ul(t,e){t.exploding&&(e?t.exploding.stage=e:t.exploding=void 0,t.dom.redraw())}function pl(t,e){function n(){!function(t){t.orientation=Zr(t.orientation),t.animation.current=t.draggable.current=t.selected=void 0}(t),e()}return{set(e){e.orientation&&e.orientation!==t.orientation&&n(),cl(t,e),(e.fen?wc:kc)((t=>ll(t,e)),t)},state:t,getFen:()=>{return e=t.pieces,Wr.map((t=>Hr.map((n=>{const o=e.get(n+t);if(o){let t=Fa[o.role];return"white"===o.color&&(t=t.toUpperCase()),o.promoted&&(t+="~"),t}return"1"})).join(""))).join("/").replace(/1{2,}/g,(t=>t.length.toString()));var e},toggleOrientation:n,setPieces(e){wc((t=>function(t,e){for(const[n,o]of e)o?t.pieces.set(n,o):t.pieces.delete(n)}(t,e)),t)},selectSquare(e,n){e?wc((t=>ec(t,e,n)),t):t.selected&&(oc(t),t.dom.redraw())},move(e,n){wc((t=>Ya(t,e,n)),t)},newPiece(e,n){wc((t=>Xa(t,e,n)),t)},playPremove(){if(t.premovable.current){if(wc(ac,t))return!0;t.dom.redraw()}return!1},playPredrop(e){if(t.predroppable.current){const n=function(t,e){const n=t.predroppable.current;let o=!1;if(!n)return!1;e(n)&&Xa(t,{role:n.role,color:t.movable.color},n.key)&&(Wa(t.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),o=!0);return Ja(t),o}(t,e);return t.dom.redraw(),n}return!1},cancelPremove(){kc(Ka,t)},cancelPredrop(){kc(Ja,t)},cancelMove(){kc((t=>{cc(t),Ic(t)}),t)},stop(){kc((t=>{lc(t),Ic(t)}),t)},explode(e){!function(t,e){t.exploding={stage:1,keys:e},t.dom.redraw(),setTimeout((()=>{ul(t,2),setTimeout((()=>ul(t,void 0)),120)}),120)}(t,e)},setAutoShapes(e){kc((t=>t.drawable.autoShapes=e),t)},setShapes(e){kc((t=>t.drawable.shapes=e),t)},getKeyAtDomPos:e=>dc(e,hc(t),t.dom.bounds()),redrawAll:e,dragNewPiece(e,n,o){Sc(t,e,n,o)},destroy(){lc(t),t.dom.unbind&&t.dom.unbind(),t.dom.destroyed=!0}}}function ml(t,e,n){const o=new Map,r=[];for(const a of t)o.set(a.hash,!1);let s,i=e.firstChild;for(;i;)s=i.getAttribute("cgHash"),o.has(s)?o.set(s,!0):r.push(i),i=i.nextSibling;for(const a of r)e.removeChild(a);for(const a of t)o.get(a.hash)||e.appendChild(n(a))}function fl(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}function gl(t,e,n){const o=t.drawable,r=o.current,s=r&&r.mouseSq?r:void 0,i=new Map,a=t.dom.bounds(),c=o.autoShapes.filter((t=>!t.piece));for(const m of o.shapes.concat(c).concat(s?[s]:[]))m.dest&&i.set(m.dest,(i.get(m.dest)||0)+1);const l=o.shapes.concat(c).map((t=>({shape:t,current:!1,hash:vl(t,i,!1,a)})));s&&l.push({shape:s,current:!0,hash:vl(s,i,!0,a)});const d=l.map((t=>t.hash)).join(";");if(d===t.drawable.prevSvgHash)return;t.drawable.prevSvgHash=d;const h=e.querySelector("defs"),u=e.querySelector("g"),p=n.querySelector("g");!function(t,e,n){const o=new Map;let r;for(const a of e)a.shape.dest&&(r=t.brushes[a.shape.brush],a.shape.modifiers&&(r=Ml(r,a.shape.modifiers)),o.set(r.key,r));const s=new Set;let i=n.firstChild;for(;i;)s.add(i.getAttribute("cgKey")),i=i.nextSibling;for(const[a,c]of o.entries())s.has(a)||n.appendChild(kl(c))}(o,l,h),ml(l.filter((t=>!t.shape.customSvg)),u,(e=>wl(t,e,o.brushes,i,a))),ml(l.filter((t=>t.shape.customSvg)),p,(e=>wl(t,e,o.brushes,i,a)))}function vl({orig:t,dest:e,brush:n,piece:o,modifiers:r,customSvg:s},i,a,c){return[c.width,c.height,a,t,e,n,e&&(i.get(e)||0)>1,o&&bl(o),r&&(l=r,""+(l.lineWidth||"")),s&&yl(s)].filter((t=>t)).join(",");var l}function bl(t){return[t.color,t.role,t.scale].filter((t=>t)).join(",")}function yl(t){let e=0;for(let n=0;n<t.length;n++)e=(e<<5)-e+t.charCodeAt(n)>>>0;return"custom-"+e.toString()}function wl(t,{shape:e,current:n,hash:o},r,s,i){let a;const c=xl(Yr(e.orig),t.orientation);if(e.customSvg)a=function(t,e,n){const[o,r]=El(e,n),s=Cl(fl("g"),{transform:`translate(${o},${r})`}),i=Cl(fl("svg"),{width:1,height:1,viewBox:"0 0 100 100"});return s.appendChild(i),i.innerHTML=t,s}(e.customSvg,c,i);else if(e.dest){let o=r[e.brush];e.modifiers&&(o=Ml(o,e.modifiers)),a=function(t,e,n,o,r,s){const i=function(t){return(t?20:10)/64}(r&&!o),a=El(e,s),c=El(n,s),l=c[0]-a[0],d=c[1]-a[1],h=Math.atan2(d,l),u=Math.cos(h)*i,p=Math.sin(h)*i;return Cl(fl("line"),{stroke:t.color,"stroke-width":Pl(t,o),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+t.key+")",opacity:Sl(t,o),x1:a[0],y1:a[1],x2:c[0]-u,y2:c[1]-p})}(o,c,xl(Yr(e.dest),t.orientation),n,(s.get(e.dest)||0)>1,i)}else a=function(t,e,n,o){const r=El(e,o),s=[3/64,4/64],i=(o.width+o.height)/(4*Math.max(o.width,o.height));return Cl(fl("circle"),{stroke:t.color,"stroke-width":s[n?0:1],fill:"none",opacity:Sl(t,n),cx:r[0],cy:r[1],r:i-s[1]/2})}(r[e.brush],c,n,i);return a.setAttribute("cgHash",o),a}function kl(t){const e=Cl(fl("marker"),{id:"arrowhead-"+t.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return e.appendChild(Cl(fl("path"),{d:"M0,0 V4 L3,2 Z",fill:t.color})),e.setAttribute("cgKey",t.key),e}function Cl(t,e){for(const n in e)t.setAttribute(n,e[n]);return t}function xl(t,e){return"white"===e?t:[7-t[0],7-t[1]]}function Ml(t,e){return{color:t.color,opacity:Math.round(10*t.opacity)/10,lineWidth:Math.round(e.lineWidth||t.lineWidth),key:[t.key,e.lineWidth].filter((t=>t)).join("")}}function Pl(t,e){return(t.lineWidth||10)*(e?.85:1)/64}function Sl(t,e){return(t.opacity||1)*(e?.9:1)}function El(t,e){const n=Math.min(1,e.width/e.height),o=Math.min(1,e.height/e.width);return[(t[0]-3.5)*n,(3.5-t[1])*o]}function Al(t,e){const n=cs("coords",e);let o;for(const r of t)o=cs("coord"),o.textContent=r,n.appendChild(o);return n}function Tl(t,e){const n=t.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(e).observe(t.dom.elements.wrap),t.viewOnly)return;const o=function(t){return e=>{t.draggable.current?Ic(t):t.drawable.current?vc(t):e.shiftKey||as(e)?t.drawable.enabled&&pc(t,e):t.viewOnly||(t.dropmode.active?function(t,e){if(!t.dropmode.active)return;Ka(t),Ja(t);const n=t.dropmode.piece;if(n){t.pieces.set("a0",n);const o=is(e),r=o&&dc(o,hc(t),t.dom.bounds());r&&tc(t,"a0",r)}t.dom.redraw()}(t,e):Pc(t,e))}}(t);n.addEventListener("touchstart",o,{passive:!1}),n.addEventListener("mousedown",o,{passive:!1}),(t.disableContextMenu||t.drawable.enabled)&&n.addEventListener("contextmenu",(t=>t.preventDefault()))}function Il(t,e,n,o){return t.addEventListener(e,n,o),()=>t.removeEventListener(e,n,o)}function $l(t,e,n){return o=>{t.drawable.current?t.drawable.enabled&&n(t,o):t.viewOnly||e(t,o)}}function _l(t){const e=hc(t),n=ns(t.dom.bounds()),o=t.dom.elements.board,r=t.pieces,s=t.animation.current,i=s?s.plan.anims:new Map,a=s?s.plan.fadings:new Map,c=t.draggable.current,l=function(t){var e;const n=new Map;if(t.lastMove&&t.highlight.lastMove)for(const s of t.lastMove)Fl(n,s,"last-move");t.check&&t.highlight.check&&Fl(n,t.check,"check");if(t.selected&&(Fl(n,t.selected,"selected"),t.movable.showDests)){const o=null===(e=t.movable.dests)||void 0===e?void 0:e.get(t.selected);if(o)for(const e of o)Fl(n,e,"move-dest"+(t.pieces.has(e)?" oc":""));const r=t.premovable.dests;if(r)for(const e of r)Fl(n,e,"premove-dest"+(t.pieces.has(e)?" oc":""))}const o=t.premovable.current;if(o)for(const s of o)Fl(n,s,"current-premove");else t.predroppable.current&&Fl(n,t.predroppable.current.key,"current-premove");const r=t.exploding;if(r)for(const s of r.keys)Fl(n,s,"exploding"+r.stage);return n}(t),d=new Set,h=new Set,u=new Map,p=new Map;let m,f,g,v,b,y,w,k,C,x;for(f=o.firstChild;f;){if(m=f.cgKey,Dl(f))if(g=r.get(m),b=i.get(m),y=a.get(m),v=f.cgPiece,!f.cgDragging||c&&c.orig===m||(f.classList.remove("dragging"),os(f,n(Yr(m),e)),f.cgDragging=!1),!y&&f.cgFading&&(f.cgFading=!1,f.classList.remove("fading")),g){if(b&&f.cgAnimating&&v===Rl(g)){const t=Yr(m);t[0]+=b[2],t[1]+=b[3],f.classList.add("anim"),os(f,n(t,e))}else f.cgAnimating&&(f.cgAnimating=!1,f.classList.remove("anim"),os(f,n(Yr(m),e)),t.addPieceZIndex&&(f.style.zIndex=Ll(Yr(m),e)));v!==Rl(g)||y&&f.cgFading?y&&v===Rl(y)?(f.classList.add("fading"),f.cgFading=!0):Bl(u,v,f):d.add(m)}else Bl(u,v,f);else if(Ol(f)){const t=f.className;l.get(m)===t?h.add(m):Bl(p,t,f)}f=f.nextSibling}for(const[M,P]of l)if(!h.has(M)){C=p.get(P),x=C&&C.pop();const t=n(Yr(M),e);if(x)x.cgKey=M,os(x,t);else{const e=cs("square",P);e.cgKey=M,os(e,t),o.insertBefore(e,o.firstChild)}}for(const[M,P]of r)if(b=i.get(M),!d.has(M))if(w=u.get(Rl(P)),k=w&&w.pop(),k){k.cgKey=M,k.cgFading&&(k.classList.remove("fading"),k.cgFading=!1);const o=Yr(M);t.addPieceZIndex&&(k.style.zIndex=Ll(o,e)),b&&(k.cgAnimating=!0,k.classList.add("anim"),o[0]+=b[2],o[1]+=b[3]),os(k,n(o,e))}else{const r=Rl(P),s=cs("piece",r),i=Yr(M);s.cgPiece=r,s.cgKey=M,b&&(s.cgAnimating=!0,i[0]+=b[2],i[1]+=b[3]),os(s,n(i,e)),t.addPieceZIndex&&(s.style.zIndex=Ll(i,e)),o.appendChild(s)}for(const M of u.values())ql(t,M);for(const M of p.values())ql(t,M)}function Nl(t){const e=t.dom.elements.wrap.getBoundingClientRect(),n=t.dom.elements.container,o=e.height/e.width,r=8*Math.floor(e.width*window.devicePixelRatio/8)/window.devicePixelRatio,s=r*o;n.style.width=r+"px",n.style.height=s+"px",t.dom.bounds.clear(),t.addDimensionsCssVars&&(document.documentElement.style.setProperty("--cg-width",r+"px"),document.documentElement.style.setProperty("--cg-height",s+"px"))}function Dl(t){return"PIECE"===t.tagName}function Ol(t){return"SQUARE"===t.tagName}function ql(t,e){for(const n of e)t.dom.elements.board.removeChild(n)}function Ll(t,e){const n=t[1];return`${e?10-n:3+n}`}function Rl(t){return`${t.color} ${t.role}`}function Fl(t,e,n){const o=t.get(e);o?t.set(e,`${o} ${n}`):t.set(e,n)}function Bl(t,e,n){const o=t.get(e);o?o.push(n):t.set(e,[n])}function zl(t,e){ml(t.drawable.autoShapes.filter((t=>t.piece)).map((t=>{return{shape:t,hash:(e=t,[e.orig,null===(n=e.piece)||void 0===n?void 0:n.role,null===(o=e.piece)||void 0===o?void 0:o.color,null===(r=e.piece)||void 0===r?void 0:r.scale].join(",")),current:!1};var e,n,o,r})),e,(e=>function(t,{shape:e,hash:n},o){var r,s,i;const a=e.orig,c=null===(r=e.piece)||void 0===r?void 0:r.role,l=null===(s=e.piece)||void 0===s?void 0:s.color,d=null===(i=e.piece)||void 0===i?void 0:i.scale,h=cs("piece",`${c} ${l}`);return h.setAttribute("cgHash",n),h.cgKey=a,h.cgScale=d,rs(h,ns(o)(Yr(a),hc(t)),d),h}(t,e,t.dom.bounds())))}function jl(t,e){const n={pieces:Ba(La),orientation:"white",turnColor:"white",coordinates:!0,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,addDimensionsCssVars:!1,blockTouchScroll:!1,pieceKey:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},prevSvgHash:""},hold:Qr()};function o(){const e="dom"in n?n.dom.unbind:void 0,o=function(t,e){t.innerHTML="",t.classList.add("cg-wrap");for(const c of Vr)t.classList.toggle("orientation-"+c,e.orientation===c);t.classList.toggle("manipulable",!e.viewOnly);const n=cs("cg-container");t.appendChild(n);const o=cs("cg-board");let r,s,i,a;if(n.appendChild(o),e.drawable.visible&&(r=Cl(fl("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),r.appendChild(fl("defs")),r.appendChild(fl("g")),s=Cl(fl("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),s.appendChild(fl("g")),i=cs("cg-auto-pieces"),n.appendChild(r),n.appendChild(s),n.appendChild(i)),e.coordinates){const t="black"===e.orientation?" black":"",o="left"===e.ranksPosition?" left":"";n.appendChild(Al(Ur,"ranks"+t+o)),n.appendChild(Al(Hr,"files"+t))}return e.draggable.showGhost&&(a=cs("piece","ghost"),ss(a,!1),n.appendChild(a)),{board:o,container:n,wrap:t,ghost:a,svg:r,customSvg:s,autoPieces:i}}(t,n),r=function(t){let e;const n=()=>(void 0===e&&(e=t()),e);return n.clear=()=>{e=void 0},n}((()=>o.board.getBoundingClientRect())),s=t=>{_l(a),o.autoPieces&&zl(a,o.autoPieces),!t&&o.svg&&gl(a,o.svg,o.customSvg)},i=()=>{Nl(a),function(t){const e=hc(t),n=ns(t.dom.bounds());let o=t.dom.elements.board.firstChild;for(;o;)(Dl(o)&&!o.cgAnimating||Ol(o))&&os(o,n(Yr(o.cgKey),e)),o=o.nextSibling}(a),o.autoPieces&&function(t){var e;const n=hc(t),o=ns(t.dom.bounds());let r=null===(e=t.dom.elements.autoPieces)||void 0===e?void 0:e.firstChild;for(;r;)rs(r,o(Yr(r.cgKey),n),r.cgScale),r=r.nextSibling}(a)},a=n;return a.dom={elements:o,bounds:r,redraw:Gl(s),redrawNow:s,unbind:e},a.drawable.prevSvgHash="",Nl(a),s(!1),Tl(a,i),e||(a.dom.unbind=function(t,e){const n=[];if("ResizeObserver"in window||n.push(Il(document.body,"chessground.resize",e)),!t.viewOnly){const e=$l(t,Ac,fc),o=$l(t,Tc,gc);for(const t of["touchmove","mousemove"])n.push(Il(document,t,e));for(const t of["touchend","mouseup"])n.push(Il(document,t,o));const r=()=>t.dom.bounds.clear();n.push(Il(document,"scroll",r,{capture:!0,passive:!0})),n.push(Il(window,"resize",r,{passive:!0}))}return()=>n.forEach((t=>t()))}(a,i)),a.events.insert&&a.events.insert(o),a}return ll(n,e||{}),pl(o(),o)}function Gl(t){let e=!1;return()=>{e||(e=!0,requestAnimationFrame((()=>{t(),e=!1})))}}function Vl(t){var e;return t.clientX||0===t.clientX?[t.clientX,t.clientY]:(null===(e=t.targetTouches)||void 0===e?void 0:e[0])?[t.targetTouches[0].clientX,t.targetTouches[0].clientY]:void 0}const Hl=t=>m("div.cg-wrap.cgv"+t.cgVersion.js,{hook:{insert:e=>{t.chessground=jl(e.elm,function(t){const e=t.data.pref,n=t.makeCgOpts(),o={turnColor:n.turnColor,fen:n.fen,check:n.check,lastMove:n.lastMove,orientation:t.bottomColor(),coordinates:0!==e.coords&&!t.embed,addPieceZIndex:e.is3d,addDimensionsCssVars:!0,viewOnly:!!t.embed,movable:{free:!1,color:n.movable.color,dests:n.movable.dests,showDests:e.destination,rookCastle:e.rookCastle},events:{move:t.userMove,dropNewPiece:t.userNewPiece,insert(e){t.embed||function(t,e,n,o){if(0===e)return;const r=document.createElement("cg-resize");t.container.appendChild(r);const s=t=>{t.preventDefault();const e="touchstart"===t.type?"touchmove":"mousemove",n="touchstart"===t.type?"touchend":"mouseup",o=Vl(t),r=parseInt(getComputedStyle(document.body).getPropertyValue("--zoom"));let s=r;const i=J((()=>G(`/pref/zoom?v=${s}`,{method:"post"})),700),a=t=>{const e=Vl(t),n=e[0]-o[0]+e[1]-o[1];s=Math.round(Math.min(100,Math.max(0,r+n/10))),document.body.setAttribute("style","--zoom:"+s),window.dispatchEvent(new Event("resize")),i()};document.body.classList.add("resizing"),document.addEventListener(e,a),document.addEventListener(n,(()=>{document.removeEventListener(e,a),document.body.classList.remove("resizing")}),{once:!0})};if(r.addEventListener("touchstart",s,{passive:!1}),r.addEventListener("mousedown",s,{passive:!1}),1===e){const t=t=>r.classList.toggle("none",o?!o(t):t>=2);t(n),lichess.pubsub.on("ply",t)}}(e,2,t.node.ply)}},premovable:{enabled:n.premovable.enabled,showDests:e.destination,events:{set:t.onPremoveSet}},draggable:{enabled:0!==e.moveEvent,showGhost:e.highlight},selectable:{enabled:1!==e.moveEvent},drawable:{enabled:!t.embed,eraseOnClick:!t.opts.study||!!t.opts.practice,defaultSnapToValidMove:"0"!=(lichess.storage.get("arrow.snap")||1)},highlight:{lastMove:e.highlight,check:e.highlight},animation:{duration:e.animationDuration},disableContextMenu:!0};return t.study&&t.study.mutateCgConfig(o),o}(t)),t.setAutoShapes(),t.node.shapes&&t.chessground.setShapes(t.node.shapes),t.cgVersion.dom=t.cgVersion.js},destroy:e=>t.chessground.destroy()}});function Ul(t,e,n){return t.best?e.trans.vdom("goodMove"===t.verdict?"anotherWasX":"bestWasX",m("move",{hook:{insert:t=>{const e=t.elm;e.addEventListener("click",n.playCommentBest),e.addEventListener("mouseover",(()=>n.commentShape(!0))),e.addEventListener("mouseout",(()=>n.commentShape(!1)))},destroy:()=>n.commentShape(!1)}},t.best.san)):[]}function Wl(t,e){return m("div.player.off",[m("div.icon.off","!"),m("div.instruction",[m("strong",t.trans.noarg("youBrowsedAway")),m("div.choices",[m("a",{hook:P("click",e.resume,e.redraw)},t.trans.noarg("resumePractice"))])])])}function Kl(t,e){const n=e.winner||t.turnColor();return m("div.player",[n?m("div.no-square",m("piece.king."+n)):m("div.icon.off","!"),m("div.instruction",[m("strong",t.trans.noarg(e.winner?"checkmate":"draw")),e.winner?m("em",m("color",t.trans.noarg("white"===e.winner?"whiteWinsGame":"blackWinsGame"))):m("em",t.trans.noarg("theGameIsADraw"))])])}function Jl(t,e){return m("div.progress",m("div",{attrs:{style:`width: ${t.ceval?100*Math.max(0,t.ceval.depth-8)/(e-8)+"%":0}`}}))}function Yl(t,e){const n=e.hinting();return m("div.player.running",[m("div.no-square",m("piece.king."+t.turnColor())),m("div.instruction",(e.isMyTurn()?[m("strong",t.trans.noarg("yourTurn"))]:[m("strong",t.trans.noarg("computerThinking")),Jl(e.currentNode(),e.playableDepth())]).concat(m("div.choices",[e.isMyTurn()?m("a",{hook:P("click",(()=>t.practice.hint()),e.redraw)},t.trans.noarg(n?"piece"===n.mode?"seeBestMove":"hideBestMove":"getAHint")):""])))])}function Xl(t){var e;const n=t.practice;if(!n)return;const o=n.comment(),r=n.running(),s=n.currentNode().threefold?{winner:void 0}:t.outcome();return m("div.practice-box.training-box.sub-box."+(o?o.verdict:"no-verdict"),[m("div.title",t.trans.noarg("practiceWithComputer")),m("div.feedback",r?s?Kl(t,s):Yl(t,n):Wl(t,n)),r?m("div.comment",(s&&!(null===(e=t.study)||void 0===e?void 0:e.practice)?wd(t):null)||(o?[m("span.verdict",t.trans.noarg(o.verdict))," "].concat(Ul(o,t,n)):[n.isMyTurn()||s?"":m("span.wait",t.trans.noarg("evaluatingYourMove"))])):null])}function Ql(t){return m("div.choices",[m("a",{hook:P("click",t.viewSolution,t.redraw)},t.noarg("viewTheSolution")),m("a",{hook:P("click",t.skip)},t.noarg("skipThisMove"))])}function Zl(t){return m("a.half.continue",{hook:P("click",t.jumpToNext)},[m("i",{attrs:A("")}),t.noarg("next")])}function td(t){return m("div.progress",m("div",{attrs:{style:`width: ${t.ceval?100*Math.max(0,t.ceval.depth-8)/10+"%":0}`}}))}const ed={find:t=>[m("div.player",[m("div.no-square",m("piece.king."+t.color)),m("div.instruction",[m("strong",t.trans.vdom("xWasPlayed",m("move",Nr({withDots:!0,showGlyphs:!0,showEval:!1},t.current().fault.node)))),m("em",t.noarg("white"===t.color?"findBetterMoveForWhite":"findBetterMoveForBlack")),Ql(t)])])],offTrack:t=>[m("div.player",[m("div.icon.off","!"),m("div.instruction",[m("strong",t.noarg("youBrowsedAway")),m("div.choices.off",[m("a",{hook:P("click",t.jumpToNext)},t.noarg("resumeLearning"))])])])],fail:t=>[m("div.player",[m("div.icon","✗"),m("div.instruction",[m("strong",t.noarg("youCanDoBetter")),m("em",t.noarg("white"===t.color?"tryAnotherMoveForWhite":"tryAnotherMoveForBlack")),Ql(t)])])],win:t=>[m("div.half.top",m("div.player",[m("div.icon","✓"),m("div.instruction",m("strong",t.noarg("goodMove")))])),Zl(t)],view:t=>[m("div.half.top",m("div.player",[m("div.icon","✓"),m("div.instruction",[m("strong",t.noarg("solution")),m("em",t.trans.vdom("bestWasX",m("strong",Nr({withDots:!0,showEval:!1},t.current().solution.node))))])])),Zl(t)],eval:t=>[m("div.half.top",m("div.player.center",[m("div.instruction",[m("strong",t.noarg("evaluatingYourMove")),td(t.node())])]))],end(t,e){if(!e())return[m("div.half.top",m("div.player",[m("div.icon",ke()),m("div.instruction",t.noarg("waitingForAnalysis"))]))];const n=!t.completion()[1];return[m("div.player",[m("div.no-square",m("piece.king."+t.color)),m("div.instruction",[m("em",n?t.noarg("white"===t.color?"noMistakesFoundForWhite":"noMistakesFoundForBlack"):t.noarg("white"===t.color?"doneReviewingWhiteMistakes":"doneReviewingBlackMistakes")),m("div.choices.end",[n?null:m("a",{hook:P("click",t.reset)},t.noarg("doItAgain")),m("a",{hook:P("click",t.flip)},t.noarg("white"===t.color?"reviewBlackMistakes":"reviewWhiteMistakes"))])])])]}};function nd(t,e){const n=t.retro,o=n.current();return n.isSolving()&&o&&t.path!==o.prev.path?ed.offTrack(n):"find"===e?o?ed.find(n):ed.end(n,t.hasFullComputerAnalysis):ed[e](n)}function od(t){const e=t.retro;if(!e)return;const n=e.feedback(),o=e.completion();return m("div.retro-box.training-box.sub-box",[m("div.title",[m("span",e.noarg("learnFromYourMistakes")),m("span",`${Math.min(o[0]+1,o[1])} / ${o[1]}`),m("button.fbt",{hook:P("click",t.toggleRetro,t.redraw),attrs:{"data-icon":"","aria-label":"Close learn window"}})]),m("div.feedback."+n,nd(t,n))])}function rd(t){return!!t.study&&t.study.data.chapter.gamebook&&!t.gamebookPlay()&&"analyse"!==t.study.vm.gamebookOverride}function sd(t){const e="deviation";return m("div.deviation",[m("div.legend.todo",{class:{done:cd(t.node,e).length>2}},[Ae(""),m("p","When any other wrong move is played:")]),m("textarea",{attrs:{placeholder:"Explain why all other moves are wrong"},hook:ld(t,e)})])}function id(t){return m("div.hint",[m("div.legend",[Ae(""),m("p","Optional, on-demand hint for the player:")]),m("textarea",{attrs:{placeholder:"Give the player a tip so they can find the right move"},hook:ld(t,"hint")})])}const ad=Oe(500,((t,e)=>{t.socket.send("setGamebook",{path:t.path,ch:t.study.vm.chapterId,gamebook:e}),t.redraw()}));function cd(t,e){return t.gamebook&&t.gamebook[e]||""}function ld(t,e){const n=cd(t.node,e);return{insert(o){const r=o.elm;r.value=n,r.oninput=()=>{const n=t.node;n.gamebook=n.gamebook||{},n.gamebook[e]=r.value.trim(),ad(t,n.gamebook)},o.data.path=t.path},postpatch(e,o){e.data.path!==t.path&&(o.elm.value=n),o.data.path=t.path}}}function dd(t){const e=t.state,n=()=>({attrs:{type:"button"},hook:P("click",t.hint,t.redraw)});return e.showHint?m("button",n(),[m("div.hint",{hook:ht(e.hint)})]):e.hint?m("button.hint",n(),t.trans.noarg("getAHint")):void 0}function hd(t,e){const n=e.feedback,o=t.root.turnColor();return"bad"===n?m("button.feedback.act.bad"+(e.comment?".com":""),{attrs:{type:"button"},hook:P("click",t.retry)},[Ae(""),m("span",t.trans.noarg("retry"))]):"good"===n&&e.comment?m("button.feedback.act.good.com",{attrs:{type:"button"},hook:P("click",t.next)},[m("span.text",{attrs:A("")},t.trans.noarg("next")),m("kbd","<space>")]):"end"===n?function(t){const e=t.root.study;return m("div.feedback.end",[e.nextChapter()?m("button.next.text",{attrs:{"data-icon":"",type:"button"},hook:P("click",e.goToNextChapter)},e.trans.noarg("nextChapter")):void 0,m("button.retry",{attrs:{"data-icon":"",type:"button"},hook:P("click",(()=>t.root.userJump("")),t.redraw)},e.trans.noarg("playAgain")),m("button.analyse",{attrs:{"data-icon":"",type:"button"},hook:P("click",(()=>e.setGamebookOverride("analyse")),t.redraw)},e.trans.noarg("analysis"))])}(t):m("div.feedback.info."+n+(e.init?".init":""),m("div","play"===n?[m("div.no-square",m("piece.king."+o)),m("div.instruction",[m("strong",t.trans.noarg("yourTurn")),m("em",t.trans.noarg("white"===o?"findTheBestMoveForWhite":"findTheBestMoveForBlack"))])]:t.trans.noarg("goodMove")))}function ud(t){const e=t.study;if(!e||t.embed)return;const n=e.data.chapter.tags,o={white:Nn(n,"white"),black:Nn(n,"black")},r=Jc(t),s=!_n(e.data.chapter)&&t.turnColor(),i=Ad(t);return["white","black"].map((a=>function(t,e,n,o,r,s,i,a){const c=Nn(t,`${r}title`),l=a?void 0:Nn(t,`${r}elo`),d=function(t,e){switch(Nn(t,"result")){case"1-0":return e?"1":"0";case"0-1":return e?"0":"1";case"1/2-1/2":return"1/2";default:return}}(t,"white"===r);return m("div.study__player.study__player-"+(i?"top":"bot"),{class:{ticking:s}},[m("div.left",[d&&m("span.result",d),m("span.info",[c&&m("span.utitle","BOT"==c?{attrs:{"data-bot":!0}}:{},c+" "),m("span.name",o[r]),l&&m("span.elo",l)])]),n[i?0:1],null==e?void 0:e["white"===r?0:1]])}(n,r,i,o,a,s===a,t.bottomColor()!==a,e.data.hideRatings&&Dn(n))))}function pd(t){var e,n;return t.members.canContribute()?m("div.relay-admin",{hook:M((t=>lichess.loadCssPath("analyse.relay-admin")))},[m("h2",[m("span.text",{attrs:A("")},"Broadcast manager"),m("a",{attrs:{href:`/broadcast/round/${t.id}/edit`,"data-icon":""}})]),(null===(e=t.data.sync)||void 0===e?void 0:e.url)||(null===(n=t.data.sync)||void 0===n?void 0:n.ids)?(t.data.sync.ongoing?gd:vd)(t):null,fd(t)]):void 0}const md=t=>[t.moves?m("strong",""+t.moves):t.moves," new move"+(t.moves>1?"s":"")];function fd(t){var e,n;const o=function(){bd||(bd=window.Intl&&Intl.DateTimeFormat?new Intl.DateTimeFormat(document.documentElement.lang,{month:"short",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric"}).format:t=>t.toLocaleString());return bd}(),r=null===(e=t.data.sync)||void 0===e?void 0:e.url,s=((null===(n=t.data.sync)||void 0===n?void 0:n.log)||[]).slice(0).reverse().map((t=>{const e=t.error&&m("a",r?{attrs:{href:r,target:"_blank",rel:"noopener nofollow"}}:{},t.error);return m("div"+(e?".err":""),{key:t.at,attrs:A(e?"":"")},[m("div",[...e?[e]:md(t),m("time",o(new Date(t.at)))])])}));return t.loading()&&s.unshift(m("div.load",[m("i.ddloader"),"Polling source..."])),m("div.log",s)}function gd(t){var e,n;const o=null===(e=t.data.sync)||void 0===e?void 0:e.url,r=null===(n=t.data.sync)||void 0===n?void 0:n.ids;return m("div.state.on.clickable",{hook:P("click",(e=>t.setSync(!1))),attrs:A("")},[m("div",o?["Connected to source",m("br"),o.replace(/https?:\/\//,"")]:r?["Connected to",m("br"),r.length," game(s)"]:[])])}const vd=t=>m("div.state.off.clickable",{hook:P("click",(e=>t.setSync(!0))),attrs:A("")},[m("div.fat","Click to connect")]);let bd;function yd(t){const e=(t,e)=>[m("div.result",t),m("div.status",e)];if(t.data.game.status.id>=30){let n;switch(t.data.game.winner){case"white":n="1-0";break;case"black":n="0-1";break;default:n="½-½"}const o=jt(t.data,t.data.game.winner);return e(n,[Gc(t),o?" • "+t.trans("white"==o.color?"whiteIsVictorious":"blackIsVictorious"):null])}if(t.study){const n=Nn(t.study.data.chapter.tags,"result");return n&&"*"!==n?"1-0"===n?e(n,[t.trans.noarg("whiteIsVictorious")]):"0-1"===n?e(n,[t.trans.noarg("blackIsVictorious")]):e("½-½",[t.trans.noarg("draw")]):[]}return[]}const wd=t=>{var e;return!t.embed&&(null===(e=t.study)||void 0===e?void 0:e.hasNextChapter())?m("button.next.text",{attrs:{"data-icon":"",type:"button"},hook:P("click",t.study.goToNextChapter),class:{highlighted:!!t.outcome()||t.node==Zt(t.mainline)}},t.trans.noarg("nextChapter")):null},kd=(t,e)=>m("div.analyse__moves.areplay",[m("div",[t.embed&&t.study?m("div.chapter-name",t.study.currentChapter().name):null,Mi(t,e),...yd(t)]),t.practice||rd(t)?null:wd(t)]);function Cd(t){if(!t.ongoing&&t.data.userAnalysis)return t.redirecting?ke():m("div.copyables",[m("div.pair",[m("label.name","FEN"),m("input.copyable.autoselect.analyse__underboard__fen",{attrs:{spellCheck:!1},hook:{insert:e=>{const n=e.elm;n.value=_(t.fenInput)?t.fenInput:t.node.fen,n.addEventListener("change",(e=>{n.value!==t.node.fen&&n.reportValidity()&&t.changeFen(n.value.trim())})),n.addEventListener("input",(e=>{t.fenInput=n.value,n.setCustomValidity(wn(n.value.trim()).isOk?"":"Invalid FEN")}))},postpatch:(e,n)=>{const o=n.elm;_(t.fenInput)?o.value!=t.fenInput&&(o.value=t.fenInput):(o.value=t.node.fen,o.setCustomValidity(""))}}})]),m("div.pgn",[m("div.pair",[m("label.name","PGN"),m("textarea.copyable.autoselect",{attrs:{spellCheck:!1},hook:{...M((e=>{e.value=_(t.pgnInput)?t.pgnInput:Os(t),e.addEventListener("input",(e=>t.pgnInput=e.target.value))})),postpatch:(e,n)=>{n.elm.value=_(t.pgnInput)?t.pgnInput:Os(t)}}}),m("button.button.button-thin.action.text",{attrs:A(""),hook:P("click",(e=>{const n=$(".copyables .pgn textarea").val();n!==Os(t)&&t.changePgn(n)}),t.redraw)},t.trans.noarg("importPgn"))])])])}const xd=(t,e,n)=>m("button.fbt",{class:{disabled:!n},attrs:{"data-act":e,"data-icon":t}});function Md(t){const e=""!==t.path,n=!!t.node.children[0],o=t.actionMenu.open,r=t.trans.noarg;return m("div.analyse__controls.analyse-controls",{hook:M((e=>{!function(t,e,n){for(const o of["touchstart","mousedown"])t.addEventListener(o,(t=>{e(t),t.preventDefault(),n&&n()}),{passive:!1})}(e,(e=>{const n=(t=>{const e=t.target;return e.getAttribute("data-act")||e.parentNode.getAttribute("data-act")})(e);"prev"===n||"next"===n?function(t,e,n){const o=()=>{me[e](t),t.redraw(),r=Math.max(100,r-r/15),s=setTimeout(o,r)};let r=350,s=setTimeout(o,500);me[e](t);const i="touchstart"==n.type?"touchend":"mouseup";document.addEventListener(i,(()=>clearTimeout(s)),{once:!0})}(t,n,e):"first"===n?he(t):"last"===n?de(t):"explorer"===n?t.toggleExplorer():"practice"===n?t.togglePractice():"menu"===n?t.actionMenu.toggle():"analysis"===n&&t.studyPractice&&window.open(t.studyPractice.analysisUrl(),"_blank","noopener")}),t.redraw)}))},[t.embed?null:m("div.features",t.studyPractice?[m("button.fbt",{attrs:{title:r("analysis"),"data-act":"analysis","data-icon":""}})]:[m("button.fbt",{attrs:{title:r("openingExplorerAndTablebase"),"data-act":"explorer","data-icon":""},class:{hidden:o||!t.explorer.allowed()||!!t.retro,active:t.explorer.enabled()}}),t.ceval.possible&&t.ceval.allowed()&&!t.isGamebook()?m("button.fbt",{attrs:{title:r("practiceWithComputer"),"data-act":"practice","data-icon":""},class:{hidden:o||!!t.retro,active:!!t.practice}}):null]),m("div.jumps",[xd("","first",e),xd("","prev",e),xd("","next",n),xd("","last",n)]),t.studyPractice?m("div.noop"):m("button.fbt",{class:{active:o},attrs:{title:r("menu"),"data-act":"menu","data-icon":""}})])}function Pd(t,e){2===t.data.pref.coords&&$("body").toggleClass("coords-in",e).toggleClass("coords-out",!e)}const Sd=(t,e)=>e+(t&&t.data.chapter?"."+t.data.chapter.id:""),Ed=t=>t.ceval.possible&&t.ceval.allowed()?m("div.comp-off__hint",[m("span",t.trans.noarg("computerAnalysisDisabled")),m("button",{hook:P("click",t.toggleComputer,t.redraw),attrs:{type:"button"}},t.trans.noarg("enable"))]):void 0;function Ad(t){var e;const n=null===(e=t.chessground)||void 0===e?void 0:e.state,o=n?n.pieces:Ba(t.node.fen);return zc(!!t.data.pref.showCaptured,t.bottomColor(),o,!(!t.data.player.checks&&!t.data.opponent.checks),t.nodeList,t.node.ply)}const Td=(t,e,n)=>m("div.analyse__player_strip."+t,[e,n]);function Id(t){if(t.nvui)return t.nvui.render(t);const e=function(t){const e=t.study&&void 0!==t.study.data.chapter.conceal?{owner:t.study.isChapterOwner(),ply:t.study.data.chapter.conceal}:null;if(e)return n=>(o,r)=>!e||n&&e.ply>=r.ply||Ut(t.path,o)?null:e.owner?"conceal":"hide"}(t),n=t.study,o=!(t.retro&&t.retro.isSolving()||t.practice),r=t.actionMenu.open,s=t.gamebookPlay(),i=s&&function(t){const e=t.state;return m("div.gamebook",{hook:{insert:t=>lichess.loadCssPath("analyse.gamebook.play")}},[e.comment||"play"==e.feedback||"end"==e.feedback?m("div.comment",{class:{hinted:e.showHint}},[e.comment?m("div.content",{hook:ht(e.comment)}):m("div.content","play"==e.feedback?t.trans("whatWouldYouPlay"):"end"==e.feedback?t.trans("youCompletedThisLesson"):void 0),dd(t)]):void 0,m("div.floor",[hd(t,e),m("img.mascot",{attrs:{width:120,height:120,src:lichess.assetUrl("images/mascot/octopus.svg")}})])])}(s),a=rd(t)?function(t){const e=t.study,n=t.turnColor()===t.data.orientation,o=!!(t.node.comments||[]).find((t=>t.text.length>2)),r=t.tree.parentNode(t.path).children.length>1;let s;const i=P("click",(()=>{e.commentForm.start(e.vm.chapterId,t.path,t.node),e.vm.toolTab("comments"),lichess.requestIdleCallback((()=>$("#comment-text").each((function(){this.focus()}))),500)}),t.redraw);return s=t.path?t.onMainline?n?[m("div.legend.todo.clickable",{hook:i,class:{done:o}},[Ae(""),m("p","Explain the opponent move, and help the player find the next move, with a comment.")]),id(t)]:[m("div.legend.clickable",{hook:i},[Ae(""),m("p","You may reflect on the player's correct move, with a comment; or leave empty to jump immediately to the next move.")]),r?null:m("div.legend.clickable",{hook:P("click",(()=>le(t)),t.redraw)},[Ae(""),m("p","Add variation moves to explain why specific other moves are wrong.")]),sd(t)]:[m("div.legend.todo.clickable",{hook:i,class:{done:o}},[Ae(""),m("p","Explain why this move is wrong in a comment")]),m("div.legend",[m("p","Or promote it as the mainline if it is the right move.")])]:n?[m("div.legend.todo.clickable",{hook:i,class:{done:o}},[Ae(""),m("p","Help the player find the initial move, with a comment.")]),id(t)]:[m("div.legend.clickable",{hook:i},[Ae(""),m("p","Introduce the gamebook with a comment")]),m("div.legend.todo",{class:{done:!!t.node.children[0]}},[Ae(""),m("p","Put the opponent's first move on the board.")])],m("div.gamebook-edit",{hook:{insert:t=>lichess.loadCssPath("analyse.gamebook.edit")}},s)}(t):void 0,c=ud(t),l=!c&&function(t){if(t.embed)return;const e=Jc(t),n=t.bottomIsWhite(),o=Ad(t);return[Td("top",o[0],null==e?void 0:e[n?1:0]),Td("bottom",o[1],null==e?void 0:e[n?0:1])]}(t),d=t.showEvalGauge(),h=!!d||!!c,u=function(t){const e=t.study,n=null==e?void 0:e.relay;if(e&&(null==n?void 0:n.tourShow.active)){const o=null==n?void 0:n.currentRound();return m("div.relay-tour",[m("div.relay-tour__text",[m("h1",n.data.tour.name),m("div.relay-tour__round",[m("strong",o.name)," ",o.ongoing?t.trans.noarg("playingRightNow"):o.startsAt?m("time.timeago",{hook:{insert(t){t.elm.setAttribute("datetime",""+o.startsAt)}}},lichess.timeago(o.startsAt)):null]),n.data.tour.markup?m("div",{hook:ct(n.data.tour.markup,(()=>n.data.tour.markup))}):m("div",n.data.tour.description),ii(n)]),e.looksNew()?null:ks(e.multiBoard,e)])}}(t);return m("main.analyse.variant-"+t.data.game.variant.key,{hook:{insert:e=>{var n;const o=e.elm;if(Pd(t,h),!!c!=$("body").hasClass("header-margin")&&requestAnimationFrame((()=>{$("body").toggleClass("header-margin",!!c),t.redraw()})),t.opts.chat){const e=document.createElement("section");e.classList.add("mchat"),o.appendChild(e);const r=t.opts.chat;null===(n=r.instance)||void 0===n||n.then((t=>t.destroy())),r.parseMoves=!0,r.instance=lichess.makeChat(r)}al(o)},update(e,n){Pd(t,h)},postpatch(t,e){t.data.gaugeOn!==d&&document.body.dispatchEvent(new Event("chessground.resize")),e.data.gaugeOn=d}},class:{"comp-off":!t.showComputer(),"gauge-on":d,"has-players":!!c,"gamebook-play":!!i,"has-relay-tour":!!u,"analyse-hunter":t.opts.hunter,"analyse--wiki":!!t.wiki&&!t.study}},[t.keyboardHelp?xe(t):null,n?ui(n):null,u||m(Sd(n,"div.analyse__board.main-board"),{hook:"ontouchstart"in window||"0"==lichess.storage.get("scrollMoves")?void 0:S("wheel",dr(((e,n)=>{if(t.gamebookPlay())return;const o=e.target;"PIECE"!==o.tagName&&"SQUARE"!==o.tagName&&"CG-BOARD"!==o.tagName||(e.preventDefault(),e.deltaY>0&&n?ce(t):e.deltaY<0&&n&&le(t),t.redraw())})))},[...l||[],c?c[t.bottomIsWhite()?1:0]:null,Hl(t),c?c[t.bottomIsWhite()?0:1]:null,t.promotion.view("antichess"===t.data.game.variant.key)]),d&&!u?yr(t):null,r||u?null:tl(t,t.topColor(),"top"),i||(u?null:m(Sd(n,"div.analyse__tools"),[...r?[Us(t)]:[t.showComputer()?wr(t):Ed(t),o?Pr(t):null,kd(t,e),a||Ri(t,e),od(t)||Xl(t)||Ia(t)]])),r||u?null:tl(t,t.bottomColor(),"bottom"),i||u?null:Md(t),t.embed||u?null:m("div.analyse__underboard",{hook:t.synthetic||Ft(t.data)?void 0:M((e=>function(t,e){$(t).replaceWith(e.opts.$underboard),$("#adv-chart").attr("id","acpl-chart");const n=e.data,o=$(".analyse__underboard__panels > div"),r=$(".analyse__underboard__menu"),s=$("#movetimes-chart"),i=document.querySelector(".analyse__underboard__fen"),a=document.querySelector(".position-gif"),c=t=>t.getSelectedPoints().forEach((t=>t.select(!1)));let l;window.LichessAnalyseNvui||(lichess.pubsub.on("analysis.comp.toggle",(t=>{setTimeout((()=>(t?r.find('[data-panel="computer-analysis"]'):r.find("span:eq(1)")).trigger("mousedown")),50),t&&$("#acpl-chart").each(((t,e)=>e.highcharts.reflow()))})),lichess.pubsub.on("analysis.change",((t,n,o)=>{const r=$("#acpl-chart"),d=`${t}${e.bottomColor()}`;if(t&&d!==l&&(i.value=t,a.href=U(`/export/gif/${t.replace(/ /g,"_")}`,{color:e.bottomColor(),lastMove:e.node.uci,variant:e.data.game.variant.key}),l=d),r.length){const t=r[0].highcharts;t&&(o!=t.lastPly&&(!1===o?c(t):t.selectPly(o)),t.lastPly=o)}if(s.length){const t=s[0].highcharts;t&&(o!=t.lastPly&&(!1===o?c(t):t.selectPly(o)),t.lastPly=o)}})),lichess.pubsub.on("analysis.server.progress",(t=>{window.LichessChartGame?window.LichessChartGame.acpl.update&&window.LichessChartGame.acpl.update(t,e.mainline):h(),t.analysis&&!t.analysis.partial&&$("#acpl-chart-loader").remove()})));const d=()=>`<div id="acpl-chart-loader"><span>Stockfish 15<br>server analysis</span>${lichess.spinnerHtml}</div>`;function h(){var t;if((null===(t=window.LichessChartGame)||void 0===t?void 0:t.acpl.update)||window.LichessAnalyseNvui)return;const r=!e.tree.root.eval||!Object.keys(e.tree.root.eval).length,s=o.filter(".computer-analysis");$("#acpl-chart").length?r&&!$("#acpl-chart-loader").length&&s.append(d()):s.html('<div id="acpl-chart"></div>'+(r?d():"")),lichess.loadModule("chart.game").then((()=>window.LichessChartGame.acpl(n,e.mainline,e.trans,$("#acpl-chart")[0])))}const u=lichess.storage.make("analysis.panel"),p=function(t){var s;r.children(".active").removeClass("active"),r.find(`[data-panel="${t}"]`).addClass("active"),o.removeClass("active").filter("."+t).addClass("active"),"move-times"!=t&&!e.opts.hunter||(null===(s=window.LichessChartGame)||void 0===s?void 0:s.movetime.render)||lichess.loadModule("chart.game").then((()=>window.LichessChartGame.movetime(n,e.trans,e.opts.hunter))),("computer-analysis"==t||e.opts.hunter)&&$("#acpl-chart").length&&setTimeout(h,200)};r.on("mousedown","span",(function(){const t=$(this).data("panel");u.set(t),p(t)}));const m=u.get();if(m&&r.children(`[data-panel="${m}"]`).filter((function(){const t=window.getComputedStyle(this).display;return!!t&&"none"!=t})).length)p(m);else{const t=r.children('[data-panel="ctable"]');(t.length?t:r.children(":first-child")).trigger("mousedown")}n.analysis||o.find("form.future-game-analysis").on("submit",(function(){return $(this).hasClass("must-login")?(confirm(e.trans("youNeedAnAccountToDoThat"))&&(location.href="/signup"),!1):(V(this.action,{method:this.method}).then((t=>{t.ok?h():t.text().then((t=>{t&&!t.startsWith("<!DOCTYPE html>")&&alert(t),lichess.reload()}))})),!1)})),o.on("click",".pgn",(function(){const t=window.getSelection(),e=document.createRange();e.selectNodeContents(this),t.removeAllRanges(),t.addRange(e)})),o.on("click",".embed-howto",(function(){const t=`<iframe src="${_e()}/embed/${n.game.id}${location.hash}?theme=auto&bg=auto"\nwidth=600 height=397 frameborder=0></iframe>`;fe({content:$('<div><strong style="font-size:1.5em">'+$(this).html()+"</strong><br /><br /><pre>"+lichess.escapeHtml(t)+"</pre><br />"+t+'<br /><br /><a class="text" data-icon="" href="/developers#embed-game">Read more about embedding games</a></div>')})}))}(e,t)))},n?pi(t):[Cd(t)]),u?null:Kc(t),t.embed?null:t.studyPractice?oi(n):m("aside.analyse__side",{hook:M((e=>{t.opts.$side&&t.opts.$side.length&&$(e).replaceWith(t.opts.$side),$(e).append($(".context-streamers").clone().removeClass("none"))}))},t.studyPractice?[oi(n)]:n?[hi(n)]:[t.forecast?ol(t,t.forecast):null,!t.synthetic&&Ft(t.data)?m("div.back-to-game",m("a.button.button-empty.text",{attrs:{href:$s(t.data,t.data.player.color),"data-icon":""}},t.trans.noarg("backToGame"))):null]),n&&n.relay&&pd(n.relay),t.embed?null:m("div.chat__members.none",{hook:M(lichess.watchers)})])}const $d=u([C,w]);function _d(t){t.element=document.querySelector("main.analyse"),t.trans=lichess.trans(t.i18n);const e=lichess.analysis=new qc(t,(function(){o=$d(o,Id(e))})),n=Id(e);t.element.innerHTML="";let o=$d(t.element,n);return function(){if("ontouchstart"in window)return;let t,e;const n=n=>{t=n.pageX,e=n.pageY};let o={};$("#topnav.hover").each((function(){const r=$(this).removeClass("hover"),s=()=>r.toggleClass("hover"),i=()=>{Math.sqrt((o.pX-t)*(o.pX-t)+(o.pY-e)*(o.pY-e))<8?(r.off(o.event,n),delete o.timeoutId,o.isActive=!0,s()):(o.pX=t,o.pY=e,o.timeoutId=setTimeout(i,200))},a=function(t){o.timeoutId&&(o.timeoutId=clearTimeout(o.timeoutId));const e=o.event="mousemove";if("mouseover"==t.type){if(o.isActive||t.buttons)return;o.pX=t.pageX,o.pY=t.pageY,r.off(e,n).on(e,n),o.timeoutId=setTimeout(i,200)}else{if(!o.isActive)return;r.off(e,n),o={},s()}};r.on("mouseover",a).on("mouseleave",a)}))}(),{socketReceive:e.socket.receive,path:()=>e.path,setChapter(t){e.study&&e.study.setChapter(t)}}}return window.Chessground=jl,window.LichessChat=function(t,e){const n=u([C,w]),o=ot(e,(function(){s=n(s,It(o))})),r=It(o);t.innerHTML="";let s=n(t,r);return o},t.boot=function(t){lichess.socket=new lichess.StrongSocket(t.data.url.socket,t.data.player.version,{params:{userTv:t.data.userTv&&t.data.userTv.id},receive(t,n){e.socketReceive(t,n)}}),t.$side=$(".analyse__side").clone(),t.$underboard=$(".analyse__underboard").clone(),t.socketSend=lichess.socket.send;const e=_d(t)},t.patch=$d,t.start=_d,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}}),t}({});
